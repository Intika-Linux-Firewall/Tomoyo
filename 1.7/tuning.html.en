<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>TOMOYO Linux Install manual</title>
<link rel="stylesheet" href="http://tomoyo.sourceforge.jp/tomoyo.css" media="all" type="text/css">
</head>
<body>
<p style="text-align:right;"><a href="tuning.html.ja">Japanese Page</a></p>
<p style="text-align:right;">Last modified: $Date$</p>
<h1>Phase 4: Tuning policy for your system.</h1>

<p>This page describes how to tune TOMOYO's policy.</p>

<hr>

<h2>Step 1: Patterning File Access Permissions</h2>

<p>Append access permissions for files that are not necessarily accessed in the learning mode such as WWW contents for WWW service.</p>

<table border="1">
<tr><td>Before</td><td>After</td></tr>
<tr><td>
&lt;kernel&gt; /usr/sbin/httpd<br>
<br>
allow_read /var/www/html/index.html<br>
allow_read /var/www/html/blog/index.html<br>
allow_read /var/www/html/blog/page1.html<br>
allow_read /var/www/html/blog/page2.html<br>
allow_read /var/www/html/blog/page3.html<br>
allow_read /var/www/html/blog/image1.jpg<br>
allow_read /var/www/html/blog/image2.jpg
</td><td>
&lt;kernel&gt; /usr/sbin/httpd<br>
<br>
allow_read /var/www/html/\*.html<br>
allow_read /var/www/html/\*/\*.html<br>
allow_read /var/www/html/\*/\*.jpg<br>
<br>
<br>
<br>
<br>
</td></tr>
</table>

<p>If you define</p>

<table border="1">
<tr><td>
path_group WEB-CONTENTS /var/www/html/\*.html<br>
path_group WEB-CONTENTS /var/www/html/\*/\*.html<br>
path_group WEB-CONTENTS /var/www/html/\*/\*.jpg<br>
</td></tr>
</table>

<p>in the exception policy, you can simplify like</p>

<table border="1">
<tr><td>
&lt;kernel&gt; /usr/sbin/httpd<br>
<br>
allow_read @WEB-CONTENTS
</td></tr>
</table>

<p>in the domain policy.</p>

<p>You can confirm the range of accessible files by using "ccs-pathmatch" command that lists pathnames matching to the given pathname patterns.</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# /usr/sbin/ccs-pathmatch '/var/log/samba/\*.log'<br>
/var/log/samba/host1.log /var/log/samba/host2.log /var/log/samba/host3.log /var/log/samba/host4.log /var/log/samba/host5.log
</td></tr>
</table>

<hr>

<h2>Step 2: Patterning Numeric Permissions</h2>

<p>Make patterns for numeric parameters such as file's create mode and network's port numbers.<br>
The following example permits /usr/sbin/httpd to accept connections from client's port 1024-65535.</a>

<table border="1">
<tr><td>Before</td><td>After</td></tr>
<tr><td>
&lt;kernel&gt; /usr/sbin/httpd<br>
<br>
allow_network TCP accept 0:0:0:0:0:ffff:c0a8:801 3810<br>
allow_network TCP accept 0:0:0:0:0:ffff:c0a8:801 3829<br>
allow_network TCP accept 0:0:0:0:0:ffff:c0a8:801 3829
</td><td>
&lt;kernel&gt; /usr/sbin/httpd<br>
<br>
allow_network TCP accept 0:0:0:0:0:ffff:c0a8:801 1024-65535<br>
<br>
<br>
</td></tr>
</table>

<p>If you define</p>

<table border="1">
<tr><td>
number_group WEB-CLIENT-PORTS 1024-65535
</td></tr>
</table>

<p>in the exception policy, you can simplify like</p>

<table border="1">
<tr><td>
&lt;kernel&gt; /usr/sbin/httpd<br>
<br>
allow_network TCP accept 0:0:0:0:0:ffff:c0a8:801 @WEB-CLIENT-PORTS<br>
</td></tr>
</table>

<p>in the domain policy.</p>

<hr>

<h2>Step 3: Patterning Network Access Permissions</h2>

<p>Similarly, make patterns for IP addresses. Don't copy the following permissions.</a>

<table border="1">
<tr><td>Before</td><td>After</td></tr>
<tr><td>
&lt;kernel&gt; /usr/sbin/httpd<br>
<br>
allow_network TCP accept 0:0:0:0:0:0:0:1 @WEB-CLIENT-PORTS<br>
allow_network TCP accept 0:0:0:0:0:ffff:a00:1 @WEB-CLIENT-PORTS<br>
allow_network TCP accept 0:0:0:0:0:ffff:a00:a1 @WEB-CLIENT-PORTS<br>
allow_network TCP accept 10.0.0.10 @WEB-CLIENT-PORTS<br>
allow_network TCP accept 10.0.0.200 @WEB-CLIENT-PORTS
</td><td>
&lt;kernel&gt; /usr/sbin/httpd<br>
<br>
allow_network TCP accept 0:0:0:0:0:0:0:1 @WEB-CLIENT-PORTS<br>
allow_network TCP accept 0:0:0:0:0:ffff:a00:1-0:0:0:0:0:ffff:a00:ff @WEB-CLIENT-PORTS<br>
allow_network TCP accept 10.0.0.1-10.0.0.255 @WEB-CLIENT-PORTS<br>
<br>
<br>
</td></tr>
</table>

<p>If you define</p>

<table border="1">
<tr><td>
address_group WEB-CLIENT-ADDRESS 0:0:0:0:0:0:0:1<br>
address_group WEB-CLIENT-ADDRESS 0:0:0:0:0:ffff:a00:1-0:0:0:0:0:ffff:a00:ff<br>
address_group WEB-CLIENT-ADDRESS 10.0.0.1-10.0.0.255
</td></tr>
</table>

<p>in the exception policy, you can simplify like</p>

<table border="1">
<tr><td>
&lt;kernel&gt; /usr/sbin/httpd<br>
<br>
allow_network TCP accept @WEB-CLIENT-ADDRESS @WEB-CLIENT-PORTS
</td></tr>
</table>

<p>in the domain policy.</p>

<hr>

<h2>Step 4: Adding conditions to ACLs (Optional)</h2>

<p>You can add conditions to individual ACLs if necessary. By using this feature, you can enforce system's user ID based access control.</p>

<p>You can define the following path_group in the exception policy.</p>

<table border="1">
<tr><td>
path_group HOME-FTP-FILE /home/\*/ftp/\*<br>
path_group HOME-FTP-FILE /home/\*/ftp/\*/\*<br>
path_group HOME-FTP-FILE /home/\*/ftp/\*/\*/\*<br>
path_group HOME-FTP-FILE /home/\*/ftp/\*/\*/\*/\*<br>
path_group HOME-FTP-DIR  /home/\*/ftp/\*/<br>
path_group HOME-FTP-DIR  /home/\*/ftp/\*/\*/<br>
path_group HOME-FTP-DIR  /home/\*/ftp/\*/\*/\*/<br>
path_group HOME-SMB-FILE /home/\*/samba/\*<br>
path_group HOME-SMB-FILE /home/\*/samba/\*/\*<br>
path_group HOME-SMB-FILE /home/\*/samba/\*/\*/\*<br>
path_group HOME-SMB-FILE /home/\*/samba/\*/\*/\*/\*<br>
path_group HOME-SMB-DIR  /home/\*/samba/\*/<br>
path_group HOME-SMB-DIR  /home/\*/samba/\*/\*/<br>
path_group HOME-SMB-DIR  /home/\*/samba/\*/\*/\*/
</td></tr>
</table>

<p>If you want to protect non-anonymous FTP service, by adding conditions in the following manner, you can forbid access to directories outside the user's home directory. To reduce damages when it is cracked, it is recommended that you should expose directories only under specific (such as "ftp") directory rather than exposing whole of home directories. If you use vsftpd, you can give like the following way.</p>

<table border="1">
<tr><td>Before</td><td>After</td></tr>
<tr><td>
&lt;kernel&gt; /usr/sbin/vsftpd<br>
<br>
allow_read/write @HOME-FTP-FILE<br>
allow_mkdir @HOME-FTP-DIR 0755<br>
allow_rmdir @HOME-FTP-DIR<br>
allow_create @HOME-FTP-FILE 0644<br>
allow_truncate @HOME-FTP-FILE<br>
allow_unlink @HOME-FTP-FILE<br>
allow_rename @HOME-FTP-FILE @HOME-FTP-FILE<br>
allow_rename @HOME-FTP-DIR @HOME-FTP-DIR
</td><td>
&lt;kernel&gt; /usr/sbin/vsftpd<br>
<br>
allow_read/write @HOME-FTP-FILE if task.uid=path1.uid<br>
allow_mkdir @HOME-FTP-DIR 0755 if task.uid=path1.parent.uid<br>
allow_rmdir @HOME-FTP-DIR if task.uid=path1.uid<br>
allow_create @HOME-FTP-FILE 0644 if task.uid=path1.parent.uid<br>
allow_truncate @HOME-FTP-FILE if task.uid=path1.uid<br>
allow_unlink @HOME-FTP-FILE if task.uid=path1.uid<br>
allow_rename @HOME-FTP-FILE @HOME-FTP-FILE if task.uid=path1.parent.uid task.uid=path2.parent.uid<br>
allow_rename @HOME-FTP-DIR @HOME-FTP-DIR if task.uid=path1.parent.uid task.uid=path2.parent.uid
</td></tr>
</table>

<p>If you want to protect Samba service, by adding conditions in the following manner, you can forbid access to directories outside the user's home directory. To reduce damages when it is cracked, it is recommended that you should expose directories only under specific (such as "samba") directory rather than exposing whole of home directories.</p>

<table border="1">
<tr><td>Before</td><td>After</td></tr>
<tr><td>
&lt;kernel&gt; /usr/sbin/smbd<br>
<br>
allow_read/write @HOME-SMB-FILE<br>
allow_mkdir @HOME-SMB-DIR 0755<br>
allow_rmdir @HOME-SMB-DIR<br>
allow_create @HOME-SMB-FILE 0644<br>
allow_truncate @HOME-SMB-FILE<br>
allow_unlink @HOME-SMB-FILE<br>
allow_rename @HOME-SMB-FILE @HOME-SMB-FILE<br>
allow_rename @HOME-SMB-DIR @HOME-SMB-DIR
</td><td>
&lt;kernel&gt; /usr/sbin/smbd<br>
<br>
allow_read/write @HOME-SMB-FILE if task.euid=path1.uid<br>
allow_mkdir @HOME-SMB-DIR 0755 if task.euid=path1.parent.uid<br>
allow_rmdir @HOME-SMB-DIR if task.euid=path1.uid<br>
allow_create @HOME-SMB-FILE 0644 if task.euid=path1.parent.uid<br>
allow_truncate @HOME-SMB-FILE if task.euid=path1.uid<br>
allow_unlink @HOME-SMB-FILE if task.euid=path1.uid<br>
allow_rename @HOME-SMB-FILE @HOME-SMB-FILE if task.euid=path1.parent.uid task.euid=path2.parent.uid<br>
allow_rename @HOME-SMB-DIR @HOME-SMB-DIR if task.euid=path1.parent.uid task.euid=path2.parent.uid<br>
</td></tr>
</table>

<p>If you want to protect SSH service, by adding conditions in the following manner, you can forbid login as user "root".</p>

<table border="1">
<tr><td>Before</td><td>After</td></tr>
<tr><td>
&lt;kernel&gt; /usr/sbin/sshd<br>
<br>
allow_execute /bin/bash if exec.realpath="/bin/bash" exec.argv[0]="-bash"
</td><td>
&lt;kernel&gt; /usr/sbin/sshd<br>
<br>
allow_execute /bin/bash if exec.realpath="/bin/bash" exec.argv[0]="-bash" task.uid!=0 task.euid!=0
</td></tr>
</table>

<p>Various conditions are supported. Please see <a href="policy-reference.html.en#conditional_acl">Using conditional ACL.</a> for details.</p>

<hr>

<p><a href="index.html.en">Return to index page.</a></p>
<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>
</body>
</html>
