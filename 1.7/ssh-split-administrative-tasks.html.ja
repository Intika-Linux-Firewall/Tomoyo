<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja-JP">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>SSH サービスでシステム管理者の操作を制限する</title>
<link rel="stylesheet" href="http://tomoyo.osdn.jp/tomoyo.css" media="all" type="text/css">
</head>
<body>
<p>Info: Version <a href="../1.8/">1.8.x</a> is available.</p>
<p style="text-align:right;"><a href="ssh-split-administrative-tasks.html.en">English Page</a></p>
<p style="text-align:right;">Last modified: $Date$</p>
<h1>SSH サービスでシステム管理者の操作を制限する</h1>

<h2>概要</h2>

<p><object data="http://www.youtube.com/v/aEJAGBKc8uY&amp;hl=en_US&amp;fs=1" type="application/x-shockwave-flash" width="425" height="344"><param name="movie" value="http://www.youtube.com/v/aEJAGBKc8uY&amp;hl=en_US&amp;fs=1"><param name="allowFullScreen" value="true"><param name="allowscriptaccess" value="always"></object></p>

<p>このページでは、ＳＳＨサーバからログインシェルが実行される時にロールの選択を行うことにより、システム管理者の操作を制限する手順について紹介します。</p>

<hr>

<h2>ステップ１：ソースコードのコンパイル</h2>

<p>使用するロールを決めます。このページでは「 Web サーバ管理者」「 Mail サーバ管理者」「セキュリティ管理者」の３つを使用します。</p>

<p>以下のソースコードをコンパイルします。このページでは、コンパイルされたプログラムの名前を /bin/sshd_login とします。また、ＳＳＨサーバのパス名を /usr/sbin/sshd とします。</p>

<table border="1">
<tr><td><pre>
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;syslog.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;fcntl.h&gt;

#define SSHD_EXECUTABLE_PATH "/usr/sbin/sshd"

int main(int raw_argc, char *raw_argv[])
{
	int i;
	int argc;
	int envc;
	char *filename;
	char **argv;
	char **envp;
	{ /* Check that I'm an execute handler process.  */
		int fd = open("/proc/ccs/.execute_handler", O_RDONLY);
		close(fd);
		if (fd == EOF) {
			fprintf(stderr, "FATAL: I'm not execute_handler.\n");
			return 1;
		}
	}
	if (raw_argc &lt; 7)
		return 1;
	filename = raw_argv[4];
	argc = atoi(raw_argv[5]);
	envc = atoi(raw_argv[6]);
	if (raw_argc != argc + envc + 7)
		return 1;
	for (i = 5; i &lt; argc + 5; i++)
		raw_argv[i] = raw_argv[i + 2];
	raw_argv[argc + 5] = NULL;
	for (i = argc + 6; i &lt; argc + envc + 6; i++)
		raw_argv[i] = raw_argv[i + 1];
	raw_argv[argc + envc + 6] = NULL;
	argv = raw_argv + 5;
	envp = raw_argv + argc + 6;
	/* "/usr/sbin/sshd" executes "/usr/sbin/sshd" with "-R" option. */
	if (argc == 2 &amp;&amp; !strcmp(argv[1], "-R") &amp;&amp;
	    !strcmp(raw_argv[2], SSHD_EXECUTABLE_PATH) &amp;&amp;
	    !strcmp(filename, SSHD_EXECUTABLE_PATH)) {
		execve(filename, argv, envp);
		return 1;
	}
	/* Don't allow 'shell -c "command"' request. */
	if (argc == 3 &amp;&amp; !strcmp(argv[1], "-c")) {
		fprintf(stderr, "You are not permitted to run %s\n", argv[2]);
		return 1;
	}
	printf("Select your role.\n\n");
	printf("1: Web administrator\n");
	printf("2: Mail administrator\n");
	printf("3: Security administrator\n\n");
	while (1) {
		int c = getchar();
		if (c == EOF)
			break;
		if (c == '1') {
			execve("/bin/webadmin-auth", argv, envp);
			break;
		}
		if (c == '2') {
			execve("/bin/mailadmin-auth", argv, envp);
			break;
		}
		if (c == '3') {
			execve("/bin/securityadmin-auth", argv, envp);
			break;
		}
	}
	return 1;
}
</pre></td></tr>
</table>

<p>以下の内容を /bin/webadmin-auth として保存し、実行許可を与えます。</p>

<table border="1">
<tr><td><pre>
#! /bin/sh
echo "Enter password for web administrator."
stty -echo
read
stty echo
[ "$REPLY" == "webadmin" ] &amp;&amp; exec /bin/bash
echo "Authentication failure"
sleep 5
exit 1
</pre></td></tr>
</table>

<p>以下の内容を /bin/mailadmin-auth として保存し、実行許可を与えます。</p>

<table border="1">
<tr><td><pre>
#! /bin/sh
echo "Enter password for mail administrator."
stty -echo
read
stty echo
[ "$REPLY" == "mailadmin" ] &amp;&amp; exec /bin/bash
echo "Authentication failure"
sleep 5
exit 1
</pre></td></tr>
</table>

<p>以下の内容を /bin/securityadmin-auth として保存し、実行許可を与えます。</p>

<table border="1">
<tr><td><pre>
#! /bin/sh
echo "Enter password for security administrator."
stty -echo
read
stty echo
[ "$REPLY" == "securityadmin" ] &amp;&amp; exec /bin/bash
echo "Authentication failure"
sleep 5
exit 1
</pre></td></tr>
</table>

<h2>ステップ２： TOMOYO Linux のインストールと初期化</h2>

<p><a href="install.html.ja">TOMOYO Linux をインストール</a>してから、以下のコマンドを実行して初期設定を行ってください。</p>

<table border="1">
<tr><td>
/usr/lib/ccs/init_policy
</td></tr>
</table>

<p>その後、 TOMOYO Linux カーネルで再起動する前に以下の操作を行ってください。</p>

<p>/usr/sbin/sshd が実行された場合にはドメイン遷移が初期化されるようにするために、 /etc/ccs/exception_policy.conf に以下の内容を追加します。</p>

<table border="1">
<tr><td>
initialize_domain /usr/sbin/sshd
</td></tr>
</table>

<p>/usr/sbin/sshd からのプログラムの実行要求が /bin/sshd_login に渡されるようにするために、 /etc/ccs/domain_policy.conf に以下の内容を追加します。</p>

<table border="1">
<tr><td>
&lt;kernel&gt; /usr/sbin/sshd<br>
execute_handler /bin/sshd_login
</td></tr>
</table>

<h2>ステップ３：学習と運用</h2>

<p>以上で設定は完了です。 TOMOYO Linux カーネルで再起動してください。</p>

<p>クライアント側から ssh でサーバ側にアクセスしてください。ログイン認証後に /bin/sshd_login によるプロンプトが表示されることを確認したら、 Ctrl-C を押してログアウトしてください。これで、 /bin/sshd_login のためのドメインである &lt;kernel&gt; /usr/sbin/sshd /bin/sshd_login が作成されました。</p>

<p>/bin/sshd_login から起動される操作を制限するために、学習モードを割り当てます。</p>

<table border="1">
<tr><td>
/usr/sbin/ccs-setprofile -r 1 '&lt;kernel&gt; /usr/sbin/sshd /bin/sshd_login'
</td></tr>
</table>

<p>クライアント側から ssh でサーバ側にアクセスしてください。ログイン認証後に /bin/sshd_login が表示したプロンプトに対して 1 を入力し、 /bin/webadmin-auth が表示したプロンプトに対して webadmin を入力してください。これで、「 Web サーバ管理者」のためのドメインである &lt;kernel&gt; /usr/sbin/sshd /bin/sshd_login /bin/webadmin-auth /bin/bash が作成されました。</p>

<p>その後、「 Web サーバ管理者」に対して許可したい操作を行います。冒頭の動画では以下の操作をしています。</p>

<table border="1">
<tr><td>
service httpd restart<br>
cd /var/www/html/<br>
tar -zxf ~/htdocs.tar.gz --strip 1<br>
less /var/log/httpd/access_log
</td></tr>
</table>

<p>許可したい操作が終わったらログアウトしてください。</p>

<p>クライアント側から ssh でサーバ側にアクセスしてください。ログイン認証後に /bin/sshd_login が表示したプロンプトに対して 2 を入力し、 /bin/mailadmin-auth が表示したプロンプトに対して mailadmin を入力してください。これで、「 Mail サーバ管理者」のためのドメインである &lt;kernel&gt; /usr/sbin/sshd /bin/sshd_login /bin/mailadmin-auth /bin/bash が作成されました。</p>

<p>その後、「 Mail サーバ管理者」に対して許可したい操作を行います。冒頭の動画では以下の操作をしています。</p>

<table border="1">
<tr><td>
service sendmail restart<br>
mailq<br>
less /var/log/maillog
</td></tr>
</table>

<p>許可したい操作が終わったらログアウトしてください。</p>

<p>クライアント側から ssh でサーバ側にアクセスしてください。ログイン認証後に /bin/sshd_login が表示したプロンプトに対して 3 を入力し、 /bin/securityadmin-auth が表示したプロンプトに対して securityadmin を入力してください。これで、「セキュリティ管理者」のためのドメインである &lt;kernel&gt; /usr/sbin/sshd /bin/sshd_login /bin/securityadmin-auth /bin/bash が作成されました。</p>

<p>その後、「セキュリティ管理者」に対して許可したい操作を行います。冒頭の動画では以下の操作をしています。</p>

<table border="1">
<tr><td>
less /var/log/tomoyo/reject_log.conf
</td></tr>
</table>

<p>許可したい操作が終わったらログアウトしてください。</p>

<p>確認モードを割り当て、許可したい操作を行えるかどうか確認してください。</p>

<table border="1">
<tr><td>
/usr/sbin/ccs-setprofile -r 2 '&lt;kernel&gt; /usr/sbin/sshd /bin/sshd_login'
</td></tr>
</table>

<p>強制モードを割り当てれば完成です。</p>

<table border="1">
<tr><td>
/usr/sbin/ccs-setprofile -r 3 '&lt;kernel&gt; /usr/sbin/sshd /bin/sshd_login'
</td></tr>
</table>

<h2>説明</h2>

<p>/bin/webadmin-auth /bin/mailadmin-auth /bin/securityadmin-auth という３つのプログラムを /usr/sbin/sshd とログインシェルとの間に挿入してやることにより、親ドメインが異なる３つのドメイン（ "&lt;kernel&gt; /usr/sbin/sshd /bin/sshd_login /bin/webadmin-auth /bin/bash", "&lt;kernel&gt; /usr/sbin/sshd /bin/sshd_login /bin/mailadmin-auth /bin/bash", "&lt;kernel&gt; /usr/sbin/sshd /bin/sshd_login /bin/securityadmin-auth /bin/bash" ）を作成し、それぞれに必要なアクセス許可だけを与えるという形で権限を分割しています。このプログラムはサンプルなのでシェルスクリプトで済ませていますが、実際に使用する場合にはちゃんとしたユーザ認証を行うプログラムを作成してください。</p>

<p>TOMOYO Linux の execute_handler 機能が /usr/sbin/sshd からのプログラムの実行要求を横取りして、 /bin/sshd_login に渡しています。 /bin/sshd_login がロールを選択させるためのプロンプトを表示して、ユーザからの応答を受け取ります。</p>

<p>システムのユーザ認証を通過後なので、シェルの実行要求を伴わないＳＳＨの機能は許可されています。ポートフォワーディングの制限なども行いたい場合は、通常通り学習モードで動作を学習させて、強制モードで動作を制限してやる必要があります。</p>

<p>それぞれのドメインではプログラムを実行するたびにドメイン遷移が発生します。ドメイン遷移をさせたくない場合は、 /etc/ccs/exception_policy.conf に以下のように keep_domain を指定することができます。</p>

<table border="1">
<tr><td>
keep_domain &lt;kernel&gt; /usr/sbin/sshd /bin/sshd_login /bin/webadmin-auth /bin/bash<br>
keep_domain &lt;kernel&gt; /usr/sbin/sshd /bin/sshd_login /bin/mailadmin-auth /bin/bash<br>
keep_domain &lt;kernel&gt; /usr/sbin/sshd /bin/sshd_login /bin/securityadmin-auth /bin/bash
</td></tr>
</table>

<hr>

<p><a href="index.html.ja">目次へ戻る</a></p>
<p><a href="http://osdn.jp/"><img src="http://osdn.jp/sflogo.php?group_id=1973" width="96" height="31" alt="sflogo.php" title="SourceForge.jp"></a></p>
</body>
</html>
