<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="ja-JP">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>TOMOYO Linux 導入手順書</title>
<link rel="stylesheet" href="http://tomoyo.sourceforge.jp/tomoyo.css" media="all" type="text/css">
</head>
<body>
<p style="text-align:right;"><a href="enforcing.html.en">English Page</a></p>
<p style="text-align:right;">Last modified: $Date$</p>
<h1>第５章：システムの振る舞いを制限</h1>

<p>このページでは、 TOMOYO の強制モードの使い方と、強制モードで動作中に発生したポリシー違反を処理する方法について説明します。</p>

<hr>

<h2>ステップ１：強制モードを有効にする</h2>

<p>Apache に許可したい操作を全て行ったと判断したら、ポリシーエディタを実行してプロファイル番号を 3 に変更します。</p>

<p>ポリシーエディタを実行してください。対象となるドメインを選択し、 s キーを押して 3 と入力してから Enter キーを押します。</p>

<p><img src="editpolicy-httpd-set-profile3.png" width="720" height="400"></p>

<p>/usr/sbin/httpd およびその子孫のプロファイル番号が 3 に変化しました。</p>

<p><img src="editpolicy-httpd-profile3.png" width="720" height="400"></p>

<p>@ キーを押してプロセス一覧表示に切り替えてください。そして、 /usr/sbin/httpd プロセスとその子孫に対してプロファイル 3 が割り当てられていることを確認してください。</p>

<p><img src="editpolicy-httpd-process3.png" width="720" height="400"></p>

<p>プロファイル 3 は強制モードを行うよう指定されているため、これにより /usr/sbin/httpd プロセスおよびその子孫は強制アクセス制御により保護された状態になりました。</p>

<p><img src="editpolicy-profile-list-enforcing.png" width="720" height="400"></p>

<p>q キーを押してポリシーエディタを終了してください。</p>

<p>ポリシーで許可されている操作をしてみましょう。</p>

<p><img src="operation-permitted.png" width="688" height="933"></p>

<p>メールの送信はポリシーで許可されているので、操作は正常に終了しました。</p>

<p>ポリシーで許可されていない操作をしてみましょう。</p>

<p><img src="unix-penguin.png" width="688" height="933"></p>

<p>操作は拒否されました。（一見すると正常に終了したように見えますが、実際には /bin/mail が「入力が空っぽです」と警告しているとおり、 /bin/cat の実行が拒否されています。）</p>

<p><img src="unix-penguin-rejected.png" width="688" height="623"></p>

<p>もしプロファイルで PREFERENCE::enforcing={ verbose=yes } と設定されている場合（デフォルトでそうなっています）、ポリシーで許可されていない操作を行うと ERROR: というメッセージがコンソールに表示されます。</p>

<p><img src="enforcing-error.png" width="720" height="400"></p>

<p>もしアクセスログの設定を<a href="initialize.html.ja#configure_audit_daemon">第２章： TOMOYO Linux の初期化</a>で行っていた場合は、拒否されたアクセス要求を grep を使ってアクセスログから抽出することができます。</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# grep -A 3 -F 'profile=3 mode=enforcing' /var/log/tomoyo/reject_log.conf<br>
#2009-09-04 17:02:40# profile=3 mode=enforcing pid=5739 uid=48 gid=48 euid=48 egid=48 suid=48 sgid=48 fsuid=48 fsgid=48 state[0]=0 state[1]=0 state[2]=0 realpath="/bin/cat" argc=2 envc=7 argv[]={ "cat" "/etc/passwd" } envp[]={ "TERM=linux" "PATH=/sbin:/usr/sbin:/bin:/usr/bin" "_=/bin/cat" "PWD=/usr/share/horde/admin" "LANG=en_US.UTF-8" "SHLVL=3" "LANGUAGE=en_US.UTF-8" } (global-pid=5739)<br>
&lt;kernel&gt; /usr/sbin/httpd /bin/sh<br>
allow_execute /bin/cat<br>
<br>
--<br>
#2009-09-04 17:02:40# profile=3 mode=enforcing pid=5739 uid=48 gid=48 euid=48 egid=48 suid=48 sgid=48 fsuid=48 fsgid=48 state[0]=0 state[1]=0 state[2]=0 (global-pid=5739)<br>
&lt;kernel&gt; /usr/sbin/httpd /bin/sh<br>
allow_read /bin/cat
</td></tr>
</table>

<p>最初のログは、 /usr/sbin/httpd から起動された /bin/sh から /bin/cat の実行が要求され、そのときの引数は cat /etc/passwd であったことを示しています。このログの１行目に mode=enforcing という内容が含まれているため、この要求は拒否されたことが判ります。</p>

<p>２番目のログは、 /usr/sbin/httpd から起動された /bin/sh が /bin/cat を読み込みモードでオープンしようとして拒否されたことを示しています。これは、要求されたプログラムを実行できなかった場合そのプログラムの内容を確認するために読み込みモードでオープンしようとするという習性が /bin/sh にあるためです。</p>

<p>もし通知設定を<a href="initialize.html.ja#configure_notify_daemon">第２章： TOMOYO Linux の初期化</a>で行っていた場合は、 ccs-notifyd から送られたメールが届くはずです。このメールの内容は、ヘッダにシリアルナンバーが付与されている点を除いてアクセスログと同一内容です。</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# mail<br>
Mail version 8.1 6/6/93.  Type ? for help.<br>
"/var/spool/mail/root": 1 message 1 unread<br>
&gt;U  1 root@localhost.local  Fri Sep  4 17:02  19/1072<br>
&amp;<br>
Message 1:<br>
From root@localhost.localdomain  Fri Sep  4 17:02:40 2009<br>
Date: Fri, 4 Sep 2009 17:02:40 +0900<br>
From: root &lt;root@localhost.localdomain&gt;<br>
To: root@localhost.localdomain<br>
<br>
Q0-0<br>
#2009-09-04 17:02:40# profile=3 mode=enforcing pid=5739 uid=48 gid=48 euid=48 egid=48 suid=48 sgid=48 fsuid=48 fsgid=48 state[0]=0 state[1]=0 state[2]=0 realpath="/bin/cat" argc=2 envc=7 argv[]={ "cat" "/etc/passwd" } envp[]={ "TERM=linux" "PATH=/sbin:/usr/sbin:/bin:/usr/bin" "_=/bin/cat" "PWD=/usr/share/horde/admin" "LANG=en_US.UTF-8" "SHLVL=3" "LANGUAGE=en_US.UTF-8" } (global-pid=5739)<br>
&lt;kernel&gt; /usr/sbin/httpd /bin/sh<br>
allow_execute /bin/cat
</td></tr>
</table>

<p>プロファイルで PREFERENCE::enforcing={ penalty=1 } と設定することで、強制モードでポリシー違反が発生した場合に、ポリシー違反の原因となったプロセスを 0.1 秒間スリープ状態にさせることができます。無限ループの中でポリシー違反が発生した場合に、ＣＰＵ使用率が 100% になってしまうのを回避するのに役にたちます。ハイジャックされた Samba サーバプロセスがポリシーで許可されていない要求を繰り返すことによりＣＰＵを浪費している状況について以下のムービーで紹介しています。<br>
<object width="425" height="344"><param name="movie" value="http://www.youtube.com/v/7OE-ySG8fME&amp;hl=ja_JP&amp;fs=1"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://www.youtube.com/v/7OE-ySG8fME&amp;hl=ja_JP&amp;fs=1" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="344"></embed></object></p>

<h2>ステップ２：ソフトウェアのアップデート時に発生するポリシー違反を処理する</h2>

<p>システムの振る舞いをポリシーにより制限しているため、パッケージのアップデートに伴いポリシーの更新が必要になる場合があります。</p>

<p>以下のいずれかの場合に、ポリシーの更新が必要になります。</p>

<ul>
<li>ファイルのパス名が変化した場合
<li>ファイルの依存関係が変化した場合 
<li>必要なアクセス許可が増えた場合 
</ul>

<p>学習モードを使ってポリシーを最初から再取得するのが理想です。しかし、現実には、一度強制モードでの運用を開始したシステムを強制モード以外に変更することは困難です。ドメイン単位で強制モードにするかどうかを指定できますが、強制モードではないドメインに属しているアプリケーションの制御を奪われたら意味がありません。例えば、 http サーバのアクセス許可を再取得するために http サーバだけを学習モードにするだけでも、システム全体が無防備になってしまうわけです。そのため、 TOMOYO Linux では、強制モードのまま、パッケージのアップデートとポリシーの修正を行います。</p>

<p>TOMOYO Linux には、強制モードのままポリシーの修正を行うためのツールが付属しています。これらのツールを使うことで、軽微な変更ならば、ポリシーを最初から再取得することなくシステムの運用を継続できます。ただし、これらのツールは、全てのケースに対応できるとは限らず、最適なポリシーであることを保証するものではありません。</p>

<p>実際の操作手順について以下のムービーで紹介しています。<br>
<object width="425" height="344"><param name="movie" value="http://www.youtube.com/v/b9q1Jo25LPA&amp;hl=ja_JP&amp;fs=1"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://www.youtube.com/v/b9q1Jo25LPA&amp;hl=ja_JP&amp;fs=1" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="344"></embed></object></p>

<h3>操作例</h3>

<p>まず、コンソールまたはターミナルを開いて、以下のコマンドを起動してください。</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# /usr/sbin/ccs-queryd
</td></tr>
</table>

<p>ccs-queryd は、 /etc/ld.so.cache に登録されている共有ライブラリファイルの情報が変更された場合に、共有ライブラリのパス名を「無条件に読み込み可能なファイル」として例外ポリシーに追加します。
以下の例は、 /lib/libnss_hesiod-2.5.so というパス名が作成されて /etc/ld.so.cache に登録されたので例外ポリシーに追加したことを示しています。</p>

<table border="1">
<tr><td>
The pathname /lib/libnss_hesiod-2.5.so was created. Appended to globally readable file.
</td></tr>
</table>

<p>また、「無条件に読み込み可能なファイル」として例外ポリシーに登録されているパス名が消滅した場合、例外ポリシーから削除します。
以下の例は、/lib/libnss_hesiod-2.4.so というパス名が消滅したのでポリシーから削除したことを示しています。</p>

<table border="1">
<tr><td>
The pathname /lib/libnss_hesiod-2.4.so was deleted. Deleted from globally readable file.
</td></tr>
</table>

<p>この状態で、パッケージのアップデートを行うためのコマンドを実行します。</p>

<p>yum を使用している環境ならば yum update を、 apt を使用している環境ならば apt-get update および apt-get upgrade を実行します。</p>

<p>パッケージをアップデート中に、デーモンの再起動などでポリシー違反が発生するかもしれません。ポリシー違反が発生した場合、 ccs-queryd に以下のようなプロンプトが表示されます。.</p>

<table border="1">
<tr><td>
#2008-06-18 20:54:37# profile=3 mode=enforcing pid=2546 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0 state[0]=0 state[1]=0 state[2]=0 (global-pid=2546)<br>
&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash /bin/cat<br>
allow_read /etc/fstab<br>
Allow? ('Y'es/'N'o/'R'etry/'S'how policy/'A'dd to policy and retry):
</td></tr>
</table>

<p>上記の例は、 &lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash /bin/cat というドメインに属しているプロセスが /etc/fstab を読み込みモードでオープンしようとしたが、ポリシーによって拒否されたので、あなたの判断を仰いでいることを示しています。
アクセス要求の妥当性を判断して、答えを指定してください。 Y を押すと許可、 N を押すと拒否、 R を押すと再試行されます。また、 S を押すとそのプロセスのドメイン用ポリシが表示されます。 A を押すと編集した上でドメイン用ポリシーに追加後、再試行できます。</p>

<p>無条件にアクセス要求を許可しないようにしてください。ポリシー違反の原因がパッケージのアップデートによるものとは限らず、侵入者の攻撃によるものである可能性があるからです。もし、侵入者の攻撃によって発生したアクセス要求に対してアクセスを許可してしまった場合、侵入されてしまいます。</p>

<p>ccs-queryd が動作している場合、ポリシーによって拒否されたアクセス要求は、あなたが応答するまで保留状態となります。そのため、 ccs-queryd を動作させたままログアウトしないでください。</p>

<p>次に、強制アクセス制御の対象となっているプログラムの動作を確認するために、一通りの操作を試してください。もし、アクセス許可の不足が検出された場合は ccs-queryd に表示されますので、 ccs-queryd の監視を忘れないようにしてください。</p>

<p>なお、 ccs-queryd はメモリ上のポリシーを直接編集します。シャットダウンすると失われてしまいますので、忘れずに ccs-savepolicy を実行してポリシーを保存してください。</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# /usr/sbin/ccs-savepolicy
</td></tr>
</table>

<p>以上でパッケージの更新作業は完了です。 ccs-queryd を実行していたコンソールまたはターミナルを閉じてください。</p>

<hr>

<p><a href="index.html.ja">Return to index page.</a></p>
<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>
</body>
</html>
