<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="ja-JP">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>TOMOYO Linux LiveCD チュートリアル for Ubuntu 9.10</title>
<link rel="stylesheet" href="../startup.css" media="all" type="text/css">
<link rev="made" href="mailto:k.takeda26@gmail.com"> 
</head>
<body>
<p style="text-align:right;"><a href="index.html.en">English Page</a></p>
<h1><a href="http://tomoyo.sourceforge.jp/">TOMOYO Linux</a> LiveCD チュートリアル</h1>

<ul>
<li><a href="#l1">概要</a></li>
<li><a href="#l2">LiveCD を入手する</a></li>
<li><a href="#l3">LiveCD で起動する</a></li>
<li><a href="#l4">LiveCD を使ってみる</a></li>
<li><a href="#l5">アクセスを制限してみる</a></li>
<li><a href="#l6">（参考）ハードディスクにインストールする</a></li>
<li><a href="#l7">（参考）さらに TOMOYO Linux を使いこなす</a></li>
</ul>

<h2><a name="l1">概要</a></h2>

<p>以下では TOMOYO Linux の LiveCD の使い方について解説します。
TOMOYO Linux LiveCD は、 CD で起動できる Linux ディストリビューションである Ubuntu に、 TOMOYO Linux カーネルとツールをインストールして基本的な設定を行った状態で配布している CD イメージです。
TOMOYO Linux LiveCD を使うことで、既存の環境に影響を与えることなく手軽に TOMOYO Linux を体験できます。</p>

<h2><a name="l2">LiveCD を入手する</a></h2>

<p>TOMOYO Linux LiveCD の ISO イメージは、 TOMOYO Linux プロジェクトの <a href="http://tomoyo.sourceforge.jp/wiki/?TomoyoLive#n90f43ff">LiveCD のページ</a>からダウンロードできます。</p>

<p>ダウンロードした ISO イメージは書き込みソフトで CD-R に焼いてください。
CD-R に焼きたくない場合、 <a href="http://www.vmware.com/jp/products/player/">VMware Player</a> を使うことで ISO イメージのまま TOMOYO Linux LiveCD を起動することもできます。</p>

<h2><a name="l3">LiveCD で起動する</a></h2>

<p>CD-R に焼いた LiveCD を CD-ROM ドライブに入れてマシンを起動するか、前節で紹介した方法で VMware Player 上で ISO イメージから起動すると、以下の画面が表示されます。</p>

<p>'F2' キーを押して言語として「日本語」を選択することで、メニュー表示を日本語化できます。</p>

<p><img src="boot-langselect-ja.png" width="640" height="480" alt="起動画面（言語選択）" title="起動画面（言語選択）"></p>

<p>'F3' キーを押してキーマップとして「 Japan 」を選択することで、日本語キーボードを使えるようになります。</p>

<p><img src="boot-kbdselect-ja.png" width="640" height="480" alt="起動画面（キーマップ選択）" title="起動画面（キーマップ選択）"></p>

<p>「コンピュータに変更を加えないでUbuntuを使ってみる(T)」を選択すると、通常の Ubuntu と同様に起動します。</p>

<p><img src="boot-livecd-ja.png" width="640" height="480" alt="起動画面" title="起動画面"></p>

<p>以下のようなデスクトップが表示されれば LiveCD での起動は完了です。
通常の Ubuntu LiveCD とほとんど同じですが、デスクトップに TOMOYO Linux 関連のアイコンが追加されています。</p>

<p><img src="desktop-ja.png" width="800" height="600" alt="デスクトップ" title="デスクトップ"></p>

<h2><a name="l4">LiveCD を使ってみる</a></h2>

<!--
<p>
<img src="icon_editpolicy.png" width="138" height="88" alt="TOMOYO Linux ポリシーエディタ" title="TOMOYO Linux ポリシーエディタ">
<img src="icon_rejectlog.png" width="138" height="88" alt="TOMOYO Linux Policy Violation Log" title="TOMOYO Linux Policy Violation Log">
</p>
-->

<p>まずは「 TOMOYO Linux Policy Violation Log 」アイコンをダブルクリックしてみてください。
以下のようなウィンドウが表示されます。</p>

<p><img src="reject_log.png" width="800" height="600" alt="ポリシー違反ログウィンドウ" title="ポリシー違反ログウィンドウ"></p>

<p>この画面は TOMOYO Linux のポリシーに違反したアクセスログを表示しており、新たなポリシー違反が発生すればすぐに表示されるようになっています。
LiveCD では何の許可も与えていないポリシーで起動されるので、全てのアクセスがポリシー違反ログとして出力されます。
ウィンドウを開いたままで、さまざまな操作をしてみてください。
どんなプロセスがどんなファイルにアクセスしたかが逐次表示されます。</p>

<p>続けて、「 TOMOYO Linux Policy Editor 」アイコンをダブルクリックしてみてください。
以下のようなウィンドウが表示されます。</p>

<p><img src="editpolicy.png" width="800" height="600" alt="ポリシーエディタウィンドウ" title="ポリシーエディタウィンドウ"></p>

<p>この画面には今までにどのようなプロセスが起動されたかを木構造で表示しており、それぞれの行はドメインとよばれます。
システム起動時から、実行されたすべてのプロセスがTOMOYO Linuxカーネルで監視されており、どんなプロセスがどんなファイルにアクセスしたかなどの情報が、すべてポリシーとして記録されています。
ポリシーエディタを使ってポリシーをブラウズするだけで、システムの挙動を手に取るように把握することができるのが TOMOYO Linux の最大の特徴です。</p>

<p>ポリシーエディタの最初の画面では、 &lt;kernel&gt; を基点として、どんなプロセスがどんなプロセスを起動したのかが木構造で表示されます。
カーソルキーや PageUp ／ PageDown キーで適当にスクロールして、システム内でどんなプロセスが起動されたかを調べてみてください。</p>

<p>試しに gnome-terminal というプロセスを探してみましょう。
'F' キーを押すと最下行に検索のための1行入力が表示されますので、そこに 'gnome-terminal' と入力して Enter キーを押すことで、すぐに gnome-terminal を見つけられます。</p>

<p><img src="find.png" width="800" height="600" alt="gnome-terminal を検索" title="gnome-terminal を検索"></p>

<p>gnome-terminal の下には /usr/bin/sudo という行が存在し、さらにその下に、 /usr/bin/tail や /usr/sbin/ccs-editpolicyという行が存在するのが見てとれます。</p>

<p><img src="domain_gnome-terminal.png" width="800" height="600" alt="gnome-terminal のドメイン周辺" title="gnome-terminal のドメイン周辺"></p>

<p>表示されている /usr/bin/tail の行にカーソルを合わせて Enter キーを押してみましょう。</p>

<p><img src="acl_tail.png" width="800" height="600" alt="tail コマンドのアクセス許可" title="tail コマンドのアクセス許可"></p>

<p>それぞれの行の一番左が行番号で、その次に表示されている単語はアクセスの種類を表しています。
allow_execute が実行を許可、 allow_write が書き込みモードでのオープンを許可、 allow_read が読み込みモードでのオープンを許可、 allow_read/write が読み書きモードでのオープンを許可、 allow_env が環境変数名の受け取り許可を表しています。
画面から、 tail コマンドが各種ロケールファイルと、 /var/log/tomoyo/reject_log.txt というファイルを読み込んだことが読み取れます。
これはデスクトップの「 TOMOYO Linux ポリシー違反ログ」というアイコンをダブルクリックして実行した結果学習されたポリシーです。</p>

<p>もとのドメインの木構造の画面に戻るためには Enter キーを押します。
プロセスがどういう履歴で起動され、どんな資源にアクセスしているかをブラウズしてみてください。</p>

<h2><a name="l5">アクセスを制限してみる</a></h2>

<p>学習されたポリシーを見るだけでなく、 TOMOYO Linux によるアクセス制御を体験してみましょう。
先ほどのポリシーエディタの画面は閉じずにそのままにしておいて、画面上端に表示されている「アプリケーション」メニューから、「アクセサリ」「端末」を起動してください。</p>

<p><img src="menu_terminal-ja.png" width="800" height="600" alt="端末の起動" title="端末の起動"></p>

<p>端末が起動できたら、先ほどのポリシーエディタの画面に戻り、ドメインの木構造が表示されている状態で、 'R'キーを押してポリシーを再読み込みしてください。
そして、 gnome-terminal 以下の /bin/bash を探して見てください。
検索は先ほどと同じく 'F' キーで行えます。</p>

<p><img src="domain_bash.png" width="800" height="600" alt="gnome-terminal から起動された bash" title="gnome-terminal から起動された bash"></p>

<p>これは先ほど起動した端末内で実行されている bash で、すでに sed や uname などのプログラムを自動的に実行していることが分かります。
端末の画面で、以下のコマンドを実行してください。</p>

<pre>
$ head /etc/passwd
$ bash
$ tail /etc/passwd
$ exit
</pre>

<p><img src="bash_learning.png" width="800" height="600" alt="bash に適当なコマンドを学習させる" title="bash に適当なコマンドを学習させる"></p>

<p>再度ポリシーエディタの画面に戻って 'R' キーを押すと、実行したプログラムが追加されていることが分かります。</p>

<p><img src="bash_learned.png" width="800" height="600" alt="bash の学習結果" title="bash の学習結果"></p>

<p>この画面で、行番号の次に表示されている数字に注目してください。
今は全ての行で '1' と表示されています。</p>

<p><img src="all_learning.png" width="800" height="600" alt="プロファイル番号は全部 1" title="プロファイル番号は全部 1"></p>

<p>これはそのプロセスが動いている TOMOYO Linux のモードを表しており、プロファイル番号とよばれる値です。
プロファイルとして以下の 4 種類が定義されており、 LiveCD ではあらかじめ全て 1 （学習モード）に設定されています。 TOMOYO Linux のアクセス制御を有効にするには、プロファイル番号 3 の強制モードを割り当てる必要があります。</p>

<table border="1" summary="profile number">
<tr><th>プロファイル番号</th><th>意味</th></tr>
<tr><td>0</td><td>無効モード（TOMOYO Linuxは何もしない）</td></tr>
<tr><td>1</td><td>学習モード（ポリシー違反のアクセスは許可してポリシーに追加する）</td></tr>
<tr><td>2</td><td>確認モード（ポリシー違反のアクセスは許可してログを出力する）</td></tr>
<tr><td>3</td><td>強制モード（ポリシー違反のアクセスは拒否する）</td></tr>
</table>

<p>今回は gnome-terminal から起動された bash での操作をアクセス制御の対象としてみましょう。
まず、 gnome-terminal 直下の bash にカーソルを合わせてスペースキーを押します。
すると、行番号の左側に '&amp;' マークが表示されます。
これでこの行が選択された状態になります。</p>

<p><img src="select-1.png" width="800" height="600" alt="bash を選択した状態" title="bash を選択した状態"></p>

<p>この状態で 'C' キーを押すと、 '&amp;' マークの有無がカーソル行以下全部にコピーされます。</p>

<p><img src="select-2.png" width="800" height="600" alt="bash 以下すべてを選択した状態" title="bash 以下すべてを選択した状態"></p>

<p>次に、 sudo にカーソルを合わせてスペースキーを押します。
すると、行番号の左側の '&amp;' マークが消えます。
これでこの行が選択解除された状態になります。</p>

<p><img src="select-3.png" width="800" height="600" alt="sudo を選択解除した状態" title="sudo を選択解除した状態"></p>

<p>この状態で 'C' キーを押すと、 '&amp;' マークの有無がカーソル行以下全部にコピーされます。</p>

<p><img src="select-4.png" width="800" height="600" alt="sudo 以下すべてを選択解除した状態" title="sudo 以下すべてを選択解除した状態"></p>

<p>この状態で 'S' キーを押すと、ポリシーエディタの最下行にプロファイル番号を入力する 1 行入力が表示されます。
アクセス制御を体験するために、プロファイル 3 （強制モード）を割り当てましょう。</p>

<p><img src="setprofile.png" width="800" height="600" alt="プロファイル番号 3 を割り当てる" title="プロファイル番号 3 を割り当てる"></p>

<p>'&amp' マークが付いていたドメインにプロファイル番号 3 が割り当てられました。</p>

<p><img src="bash_enforced.png" width="800" height="600" alt="プロファイルが 3 になった" title="プロファイルが 3 になった"></p>

<p>これでもう gnome-terminal から起動された bash に対しては強制モードで動いています。
端末の画面で適当なコマンドを入力してみてください。
先ほど学習モードで実行したコマンド以外は拒否されるはずです。
以下の画面では、 head /etc/passwd の実行には成功していますが、 ls や ps コマンドの実行は拒否されています。</p>

<p><img src="1st_bash.png" width="800" height="600" alt="学習されたコマンド以外は拒否される" title="学習されたコマンド以外は拒否される"></p>

<p>また、 1 段階目の bash では tail /etc/passwd は拒否されますが、 bash をもう 1 段起動した場合には許可されます。</p>

<p><img src="2nd_bash.png" width="800" height="600" alt="シェルレベルによるアクセス許可の違い" title="シェルレベルによるアクセス許可の違い"></p>

<p>これは、 TOMOYO Linux がプロセスをその実行履歴によって区別していることに起因しています。
再度ポリシーエディタを見ると、</p>

<ul>
<li>gnome-terminal から実行された bash</li>
<li>gnome-terminal から実行された bash から起動された bash</li>
</ul>

<p>の 2 種類の bash が存在し、 head コマンドは 1 つ目の、 tail コマンドは 2 つ目の bash のみにしか許可されていないことが分かります。
TOMOYO Linux はシステム起動時から起動されたすべてのプロセスを監視しており、プロセスは実行履歴によって細かく区別されます。</p>

<h2><a name="l6">（参考）ハードディスクにインストールする</a></h2>

<p>設定や学習させたポリシーは LiveCD で起動している間のみで有効で、システムを終了させると失なわれてしまいます。
継続的に使用したい場合はハードディスクにインストールしてください。
デスクトップの「インストール」アイコンをダブルクリックしてあとの指示に従えば、 TOMOYO Linux が導入された状態の Ubuntu をハードディスクにインストールできます。
LiveCD として起動する分には既存の環境に影響を与えませんが、ハードディスクにインストールすると既存の OS 領域を上書きしてしまう可能性があります。
くれぐれも注意ください。</p>

<!--
<p><img src="icon_install-ja.png" width="75" height="72" alt="インストールアイコン" title="インストールアイコン"></p>
-->

<p>ハードディスクから起動し、 root ユーザ権限で ccs-savepolicy コマンドを実行すれば、 /etc/ccs/ ディレクトリにポリシーを保存でき、次回起動時からは保存したポリシーを参照するようになります。</p>

<h2><a name="l7">（参考）さらに TOMOYO Linux を使いこなす</a></h2>

<p>上記手順で解説した内容で、 TOMOYO Linux の基本的なアクセス制御を体験できました。
TOMOYO Linux にはここで紹介した機能以外にもさまざまな機能があります。
さらに TOMOYO Linux を使いこなしたいという方は、以下のドキュメントをご参照ください。</p>

<ul>
<li><a href="../../tool-editpolicy.html.ja">ポリシーエディタの使い方</a>: 上記手順で使用したポリシーエディタの詳細な使い方。</li>
<li><a href="../../policy-reference.html.ja">TOMOYO Linux ポリシー解説書</a>: TOMOYO Linux の機能のリファレンス。</li>
<li><a href="http://tomoyo.sourceforge.jp/wiki/?WorldOfTomoyoLinux">TOMOYO Linux の世界</a>: 2007 年 1 月～ 12 月の Software Design の連載。一通り機能を網羅したチュートリアルになっています。（ただし、内容は旧バージョンです。）</li>
<li><a href="http://www.thinkit.co.jp/free/article/0706/17/1/">初体験 TOMOYO Linux ！</a>: ThinkIT での TOMOYO Linux 連載。</li>
</ul>

<hr>
<address><a href="http://tomoyo.sourceforge.jp/">TOMOYO Linux</a> is supported by <a href="http://www.nttdata.co.jp/">NTT DATA CORPORATION</a><br>
<a href="mailto:haradats@gmail.com">Send message to Webadmin</a><br>
Last modified: $Date$<br>
<!--#include virtual="/cgi-bin/counter.pl" -->
</address>

<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>

<p><a href="http://validator.w3.org/check?uri=referer">
<img src="http://www.w3.org/Icons/valid-html401" alt="Valid HTML 4.01 Strict" height="31" width="88"></a></p>

</body>
</html>
