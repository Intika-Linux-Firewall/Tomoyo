<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>Access analysis using TOMOYO Linux</title>
<link rel="stylesheet" href="tomoyo.css" media="all" type="text/css">
</head>
<body>
<h1>Access Analysis using TOMOYO Linux</h1>
<p style="text-align:right;">Last modified: $Date$</p>

<p>Since the policy of TOMOYO Linux is represented using pathnames, TOMOYO Linux is applicable for tracing file accesses.<br>
You can use TOMOYO Linux to find how programs access files or what program is creating files on specific directories.</p>

<h1>Preparation</h1>

<h2>Install TOMOYO Linux kernel</h2>

<p>TOMOYO Linux provides some binary kernel packages. If you want to use binary kernel packages, download and install.</p>

<table border="1">
<tr><td>
RedHat Linux 9 (80386 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/kernel-2.4.20-46.9.legacy_tomoyo_1.4.i386.rpm
</td></tr><tr><td>
Fedora Core 3 (80586 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/kernel-2.6.12-2.3.legacy_FC3_tomoyo_1.4.i586.rpm
</td></tr><tr><td>
Fedora Core 4 (80586 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/kernel-2.6.17-1.2142_FC4_tomoyo_1.4.i586.rpm
</td></tr><tr><td>
Fedora Core 5 (80586 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/kernel-2.6.20-1.2316.fc5_tomoyo_1.4.i586.rpm
</td></tr><tr><td>
Fedora Core 6 (80586 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/kernel-2.6.20-1.2948.fc6_tomoyo_1.4.i586.rpm
</td></tr><tr><td>
CentOS 4.4 (80586 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/kernel-2.6.9-42.0.10.EL_tomoyo_1.4.i586.rpm
</td></tr><tr><td>
CentOS 5 (80686 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/kernel-2.6.18-8.1.3.el5_tomoyo_1.4.i686.rpm
</td></tr><tr><td>
Debian Sarge (80586 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/kernel-image-2.4.27-10sarge5-ccs-i586_1.4_i386.deb<br>
http://osdn.dl.sourceforge.jp/tomoyo/24616/kernel-image-2.6.8-16sarge6-ccs-i586_1.4_i386.deb
</td></tr><tr><td>
Debian Etch (80586 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/linux-image-2.6.18-12etch1-ccs-i586_1.4_i386.deb
</td></tr><tr><td>
OpenSUSE 10.1 (80586 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/kernel-default-2.6.16.27-0.9_tomoyo_1.4.i586.rpm
</td></tr><tr><td>
OpenSUSE 10.2 (80586 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/kernel-default-2.6.18.8-0.1_tomoyo_1.4.i586.rpm
</td></tr><tr><td>
Asianux 2.0 (80686 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/kernel-2.6.9-42.11AX_tomoyo_1.4.i686.rpm
</td></tr><tr><td>
Ubuntu 6.10 (80586 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/linux-image-2.6.17.14-ubuntu1-ccs-i586_1.4_i386.deb
</td></tr><tr><td>
Ubuntu 7.04 (80586 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/linux-image-2.6.20-15.27-ccs-i586_1.4_i386.deb
</td></tr><tr><td>
Vine Linux 4.1 (80586 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/kernel-2.6.16-0vl73_tomoyo_1.4.i586.rpm
</td></tr>
</table>

<p>If the CPU architecture differs or you want to customize kernel configuration, you need to compile kernel. To compile kernel, see <a href="compile.html">TOMOYO Linux kernel compilation</a>.</p>

<p>If you are using distributions that support SELinux, you might encounter errors while installing packages if SELinux is not disabled. If you see error messages shown below while installing packages, retry after you disable SELinux. You can disable SELinux by either "changing SELINUX=disabled in /etc/selinux/config and reboot" or "adding selinux=0 to the kernel's boot paramaters".</p>

<table border="1">
<tr><td>
[root@localhost ~]# rpm -ihv kernel-2.6.9-42.0.10.EL_tomoyo_1.4.i586.rpm<br>
Preparing...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;########################################### [100%]<br>
Error: %pre(kernel-2.6.9-42.0.10.EL_tomoyo_1.4.i586) scriptlet failed, exit status 255<br>
Error:&nbsp;&nbsp;&nbsp;install: %pre scriptlet failed (2), skipping kernel-2.6.9-42.0.10.EL_tomoyo_1.4
</td></tr>
</table>

<p>TOMOYO Linux itself can coexist with SELinux. You may continue with SELinux enabled if you want.</p>

<p>If you install rpm package, the following entry is added to /boot/grub/grub.conf upon successful installation.</p>

<table border="1">
<tr><td>
title CentOS (2.6.9-42.0.10.EL_tomoyo_1.4)<br>
&nbsp;&nbsp;&nbsp;&nbsp;root (hd0,0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;kernel /vmlinuz-2.6.9-42.0.10.EL_tomoyo_1.4 ro root=/dev/VolGroup00/LogVol00<br>
&nbsp;&nbsp;&nbsp;&nbsp;initrd /initrd-2.6.9-42.0.10.EL_tomoyo_1.4.img
</td></tr>
</table>

<p>Append "init=/.init" to the line of "kernel".</p>

<table border="1">
<tr><td>
title CentOS (2.6.9-42.0.10.EL_tomoyo_1.4)<br>
&nbsp;&nbsp;&nbsp;&nbsp;root (hd0,0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;kernel /vmlinuz-2.6.9-42.0.10.EL_tomoyo_1.4 ro root=/dev/VolGroup00/LogVol00 init=/.init<br>
&nbsp;&nbsp;&nbsp;&nbsp;initrd /initrd-2.6.9-42.0.10.EL_tomoyo_1.4.img
</td></tr>
</table>

<p>If you install deb package, the following entry is added to /boot/grub/menu.lst upon successful installation.</p>

<table border="1">
<tr><td>
title Debian GNU/Linux, kernel 2.6.8-16sarge6-ccs<br>
root (hd0,0)<br>
kernel /boot/vmlinuz-2.6.8-16sarge6-ccs root=/dev/sda1 ro<br>
initrd /boot/initrd.img-2.6.8-16sarge6-ccs<br>
savedefault<br>
boot
</td></tr>
</table>

<p>Append "init=/.init" to the line of "kernel".</p>

<table border="1">
<tr><td>
title Debian GNU/Linux, kernel 2.6.8-16sarge6-ccs<br>
root (hd0,0)<br>
kernel /boot/vmlinuz-2.6.8-16sarge6-ccs root=/dev/sda1 ro init=/.init<br>
initrd /boot/initrd.img-2.6.8-16sarge6-ccs<br>
savedefault<br>
boot
</td></tr>
</table>

<p>The "/.init" is a script to load TOMOYO Linux's policy files and is executed before starting "/sbin/init" .<br>
The "/.init" is included in the TOMOYO Linux tools package.</p>

<h2>Install TOMOYO Linux tools</h2>

<p>TOMOYO Linux provides some pre-compiled tools. If you want to use pre-compiled tools, download and extract under /root/ directory.</p>

<table border="1">
<tr><td>
RedHat Linux 9 (80386 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/ccs-tools-1.4-i386-RHL9.tar.gz
</td></tr><tr><td>
Fedora Core 3 (80386 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/ccs-tools-1.4-i386-FC3.tar.gz
</td></tr><tr><td>
Fedora Core 4 (80386 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/ccs-tools-1.4-i386-FC4.tar.gz
</td></tr><tr><td>
Fedora Core 5 (80386 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/ccs-tools-1.4-i386-FC5.tar.gz
</td></tr><tr><td>
Fedora Core 6 (80386 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/ccs-tools-1.4-i386-FC6.tar.gz
</td></tr><tr><td>
CentOS 4.4 (80386 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/ccs-tools-1.4-i386-CentOS4.4.tar.gz
</td></tr><tr><td>
CentOS 5 (80386 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/ccs-tools-1.4-i386-CentOS5.tar.gz
</td></tr><tr><td>
Debian Sarge (80386 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/ccs-tools-1.4-i386-Sarge.tar.gz
</td></tr><tr><td>
Debian Etch (80386 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/ccs-tools-1.4-i386-Etch.tar.gz
</td></tr><tr><td>
OpenSUSE 10.1 (80386 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/ccs-tools-1.4-i386-SUSE10.1.tar.gz
</td></tr><tr><td>
OpenSUSE 10.2 (80386 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/ccs-tools-1.4-i386-SUSE10.2.tar.gz
</td></tr><tr><td>
Asianux 2.0 (80386 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/ccs-tools-1.4-i386-AX2.tar.gz
</td></tr><tr><td>
Ubuntu 6.10 (80386 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/ccs-tools-1.4-i386-Ubuntu6.10.tar.gz
</td></tr><tr><td>
Ubuntu 7.04 (80386 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/ccs-tools-1.4-i386-Ubuntu7.04.tar.gz
</td></tr><tr><td>
Vine Linux 4.1 (80386 and later)</td><td>
http://osdn.dl.sourceforge.jp/tomoyo/24616/ccs-tools-1.4-i386-Vine4.1.tar.gz
</td></tr>
</table>

<p>Move extracted ".init" (policy loader) to / .</p>

<table border="1">
<tr><td>
mv ccstools/.init /
</td></tr>
</table>

<p>If the CPU architecture differs, you need to compile tools. To compile tools, run the following commands.</p>

<table border="1">
<tr><td>
cd /root/<br>
# Download source of tools for TOMOYO Linux.<br>
wget http://osdn.dl.sourceforge.jp/tomoyo/24615/ccs-tools-1.4-20070401.tar.gz<br>
# Extract.<br>
tar -zxf ccs-tools-1.4-20070401.tar.gz<br>
# Compile.<br>
make -sC ccstools/<br>
# Move policy loader to / .<br>
mv ccstools/.init /
</td></tr>
</table>

<h2>Create Policy</h2>

<p>Create /etc/ccs/manager.txt with the following contents.</p>

<table border="1">
<tr><td>
/root/ccstools/editpolicy
</td></tr>
</table>

<p>Create /etc/ccs/status.txt with the following contents.</p>

<table border="1">
<tr><td>
MAC_FOR_FILE=1<BR>
MAX_ACCEPT_ENTRY=1048576<BR>
MAX_GRANT_LOG=0<BR>
MAX_REJECT_LOG=0<BR>
TOMOYO_VERBOSE=0<BR>
</td></tr>
</table>

<p>Save the output of the following commands as /etc/ccs/exception_policy.txt .</p>

<table border="1">
<tr><td>
/root/ccstools/make_exception.sh | grep ^file_pattern | sort | uniq
</td></tr>
</table>

<h1>Analysis</h1>

<p>Reboot with TOMOYO Linux kernel.</p>

<p>The following messages will appear upon successful execution of "/.init", so press "Enter".</p>

<table border="1">
<tr><td>
Press 'Enter' or wait for 10 seconds to use default status.<br>
You may input 'disabled' and press 'Enter' to disable MAC in case of emergency.<br>
&gt;
</td></tr>
</table>

<p>/sbin/init will start and the system will boot if profiles are loaded successfully.<br>
On failure, the following messages will appear and the system halts.</p>

<table border="1">
<tr><td>
No profiles loaded. Run policy loader using 'init=' option.
</td></tr>
</table>

<p>If failed, check the following points.</p>

<ul>
<li>The "kernel" line of the entry of TOMOYO Linux kernel in /boot/grub/grub.conf ( or /boot/grub/menu.lst ) has "init=/.init" option.
<li> /.init has execute permission.
</ul>

<p>Run applications you want to analyze.</p>

<p>You can see the list of programs executed until now by executing /root/ccstools/editpolicy . Choose a program and press "Enter" to see the list of files accessed by the program.</p>

<p>You can save the list of all accessed files until now as /etc/ccs/domain_policy.txt by executing /root/ccstools/savepolicy .</p>

</body>
</html>
