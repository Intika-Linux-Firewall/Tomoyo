<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>TOMOYO Linux Maintenance manual</title>
<link rel="stylesheet" href="https://tomoyo.osdn.jp/tomoyo.css" media="all" type="text/css">
</head>
<body>
<p>Info: Version <a href="../../1.7/">1.7.x</a> is available.</p>
<p style="text-align:right;"><a href="../../ja/1.6.x/update.html">Japanese Page</a></p>
<h1>TOMOYO Linux Maintenance manual</h1>
<p style="text-align:right;">Last modified: $Date$</p>

<h1>Notes for updating packages</h1>

<p>Since the behavior of the system is restricted by policy, you may need to update policy when you update packages.</p>

<p>You need to update policy in the following cases.</p>

<ul>
<li>The pathname of files has changed.
<li>The dependency of files has changed.
<li>The access permissions required has increased.
</ul>

<p>The ideal way to update policy is to rebuild from the scratch using learning mode. But it is not desirable to change from enforcing mode to other mode if the system has once entered in production state. Suppose MAC could support per-application enforcing mode, the MAC becomes useless if an application that is not running in enforcing mode was cracked. For example, the whole system becomes vulnerable if only HTTP server application is running in learning mode to rebuild policy for the application. So, in TOMOYO Linux, updating policy is done while the system is running in enforcing mode.</p>

<p>TOMOYO Linux includes tools that help administrators update policy while the system is running in enforcing mode. By using these tools, you can continue running the system without rebuilding from the scratch using learning mode if the modification is trivial. But note that these tools cannot always support every cases and the result of updated policy is not always the optimized.</p>

<h1>Procedure</h1>

<p>Open three windows. Hereafter, this manual refers these windows as "Window-1", "Window-2" and "Window-3".</p>

<p>First, switch to Window-1. And switch to ALLOW_ENFORCE_GRACE=enabled for profiles which you want to allow interactively. For example, if you want to switch for profile 3, do the following command.</p>

<table border="1">
<tr><td>
/usr/sbin/ccs-setlevel 3-ALLOW_ENFORCE_GRACE=enabled
</td></tr>
</table>

<p>You may assign profiles for "enforcing mode" that only differ the value of ALLOW_ENFORCE_GRACE using "ccs-setprofile" command instead for directly changing the values of ALLOW_ENFORCE_GRACE of existent profiles for "enforcing mode" using "ccs-setlevel" command.</p>

<p>Start the following command.</p>

<table border="1">
<tr><td>
/usr/sbin/ccs-queryd
</td></tr>
</table>

<p>The "ccs-queryd" detects policy violation and displays the access request. You can tell the system whether the access request should be granted (or granted and policy should be appended to grant the access request) or rejected after you validate the access request.</p>

<p>Never grant access requests unconditionally. The cause of policy violation is not always updating packages, but may by malicious requests by attackers. If you grant access requests caused by malicious requests by attackers, the system gets intruded.</p>

<p>If either the profiles are configured with "ALLOW_ENFORCE_GRACE=disabled" or "ccs-queryd" is not running, the access requests that violated policy are rejected immediately. If both the profiles are configured with "ALLOW_ENFORCE_GRACE=enabled" and "ccs-queryd" is running, the access requests that violated policy are kept pending. Thus, you had better not to logout while "ccs-queryd" is running.</p>

<p>Next, start the following command at Window-2.</p>

<table border="1">
<tr><td>
/usr/sbin/ccs-ld-watch
</td></tr>
</table>

<p>The "ccs-ld-watch" automatically appends shared libraries to exception policy using "allow_read" directive when the location of shared libraries in /etc/ld.so.cache has changed. By using "ccs-ld-watch", you can avoid errors "unable to start applications because shared libraries are unreadable" when the pathnames of shared libraries accessed by general programs has changed.</p>

<p>Next, switch to Window-3, and run the commands for updating packages.</p>

<p>If you use "yum", run "you update". If you use "apt", run "apt-get update" and "apt-get upgrade".</p>

<p>Policy violation occurs while updating packages due to unusual behavior such as restarting daemons. So, don't forget to monitor Window-1.</p>

<p>After you finished updating packages, wait for 10 seconds, then, terminate "ld-watch" with Ctrl-C that is running in Window-2.</p>

<p>Next, save current policy manually.</p>

<table border="1">
<tr><td>
/usr/sbin/ccs-savepolicy
</td></tr>
</table>

<p>Run the following command to get the list of nonexistent pathnames.</p>

<table border="1">
<tr><td>
/usr/sbin/ccs-findtemp &lt; /etc/ccs/exception_policy.conf
</td></tr>
</table>

<p>Open /etc/ccs/exception_policy.conf using text editor and remove "allow_read" lines for nonexistent shared libraries. Then, reload the exception policy using the following command.</p>

<table border="1">
<tr><td>
/usr/sbin/ccs-loadpolicy ef
</td></tr>
</table>

<p>Run the following command to get the list of nonexistent pathnames.</p>

<table border="1">
<tr><td>
/usr/sbin/ccs-findtemp &lt; /etc/ccs/domain_policy.conf
</td></tr>
</table>

<p>You need to be careful if a lot of pathnames appeared. The directory part of pathnames may have changed by updating packages.</p>

<p>For example, logwatch included in Fedora Core 4 changes the pathnames by updating. The logwatch included in Fedora Core 4's installation CD holds configuration files in /etc/log.d/ directory. But by updating, the location changes to /etc/logwatch/ directory and /etc/log.d/ directory is removed.</p>

<p>If the patterns of changes are obvious, you can edit /etc/ccs/domain_policy.conf using text editor. Then, reload the domain policy using the following command.</p>

<table border="1">
<tr><td>
/usr/sbin/ccs-loadpolicy df
</td></tr>
</table>

<p>Do a series of operations to confirm that programs that are protected by MAC can run properly. If some access permissions are missing, the messages will be printed to Window-1, so don't forget to monitor Window-1.</p>

<p>Save policy again after you finished operation check.</p>

<table border="1">
<tr><td>
/usr/sbin/ccs-savepolicy
</td></tr>
</table>

<p>Terminate "ccs-queryd" with Ctrl-C that is running in Window-1.</p>

<p>Finally, switch the profiles back to "ALLOW_ENFORCE_GRACE=disabled". For example, if you switched profile 3, do the following command.</p>

<table border="1">
<tr><td>
/usr/sbin/ccs-setlevel 3-ALLOW_ENFORCE_GRACE=disabled
</td></tr>
</table>

<p>You have finished updating policies. Close all windows.</p>
<p><a href="https://osdn.jp/"><img src="https://osdn.jp/sflogo.php?group_id=1973" width="96" height="31" alt="sflogo.php" title="SourceForge.jp"></a></p>
</body>
</html>
