<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>TOMOYO Linux Maintenance manual</title>
<link rel="stylesheet" href="https://tomoyo.osdn.jp/tomoyo.css" media="all" type="text/css">
</head>
<body>
<p>Info: Version <a href="../../1.7/">1.7.x</a> is available.</p>
<p style="text-align:right;"><a href="../../ja/1.6.x/update.html">Japanese Page</a></p>
<h1>TOMOYO Linux Maintenance manual</h1>
<p style="text-align:right;">Last modified: $Date$</p>

<h1>Notes for updating packages</h1>

<p>Since the behavior of the system is restricted by policy, you may need to update policy when you update packages.</p>

<p>You need to update policy in the following cases.</p>

<ul>
<li>The pathname of files has changed.
<li>The dependency of files has changed.
<li>The access permissions required has increased.
</ul>

<p>The ideal way to update policy is to rebuild from the scratch using learning mode. But it is not desirable to change from enforcing mode to other mode if the system has once entered in production state. Suppose MAC could support per-application enforcing mode, the MAC becomes useless if an application that is not running in enforcing mode was cracked. For example, the whole system becomes vulnerable if only HTTP server application is running in learning mode to rebuild policy for the application. So, in TOMOYO Linux, updating policy is done while the system is running in enforcing mode.</p>

<p>TOMOYO Linux includes tools that help administrators update policy while the system is running in enforcing mode. By using these tools, you can continue running the system without rebuilding from the scratch using learning mode if the modification is trivial. But note that these tools cannot always support every cases and the result of updated policy is not always the optimized.</p>

<p>The procedure explained in this page is for TOMOYO Linux 1.6.2 and later. See <a href="old-update.html">here</a> for the procedure for TOMOYO Linux 1.6.1 and earlier.</p>

<h1>Demo</h1>

<p>You can see a <a href="https://tomoyo.osdn.jp/data/update_demo.avi" target="_blank">demo movie</a> that explains you how to handle software updates.</p>

<p>To see this movie, you need to install VMware codec. You can download the codec from <a href="http://www.vmware.com/download/eula/moviedecoder_v55.html">here</a> if you are using Windows.</p>

<h1>Procedure</h1>

<p>Open a console or terminal window. Then, start the following program.</p>

<table border="1">
<tr><td>
/usr/sbin/ccs-queryd
</td></tr>
</table>

<p>The "ccs-queryd" automatically appends shared libraries to exception policy using "allow_read" directive when the location of shared libraries in /etc/ld.so.cache has changed.
The example shown below indicates that the pathname /lib/libnss_hesiod-2.5.so was appended to exception policy because it was created and was registered to /etc/ld.so.cache .</p>

<table border="1">
<tr><td>
The pathname /lib/libnss_hesiod-2.5.so was created. Appended to globally readable file.
</td></tr>
</table>

<p>Also, the "ccs-queryd" automatically removes the pathname registered as globally readable files in exception policy when it was deleted.
The example shown below indicates that the pathname /lib/libnss_hesiod-2.4.so was removed from exception policy because it was deleted.</p>

<table border="1">
<tr><td>
The pathname /lib/libnss_hesiod-2.4.so was deleted. Deleted from globally readable file.
</td></tr>
</table>

<p>Run the commands for updating packages.</p>

<p>If you use "yum", run "you update". If you use "apt", run "apt-get update" and "apt-get upgrade".</p>

<p>Policy violation might occur while updating packages due to unusual behavior such as restarting daemons. When a policy violation occurs, a prompt shown below appears in the "ccs-queryd".</p>

<table border="1">
<tr><td>
#2008-06-18 20:54:37# profile=3 mode=enforcing pid=2546 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0 state[0]=0 state[1]=0 state[2]=0<br>
&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash /bin/cat<br>
allow_read /etc/fstab<br>
Allow? ('Y'es/Yes and 'A'ppend to policy/'N'o):
</td></tr>
</table>

<p>The example shown above indicates that a process which belongs to the domain "&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash /bin/cat" attempted to open /etc/fstab for reading but the attempt was denied by policy, and the kernel is asking for your decision.
Validate whether or not to permit the request and tell the kernel your decision (and also the attempt should be granted from the next time by adding to domain policy). 
You can press "Y" to grant the request. You can press "N" to reject the request. You can press "A" to grant the request and also append to domain policy after editing the request.</p>

<p>Never grant access requests unconditionally. The cause of policy violation is not always updating packages, but may by malicious requests by attackers. If you grant access requests caused by malicious requests by attackers, the system gets intruded.</p>

<p>If "ccs-queryd" is running, the access requests that violated policy are kept pending. Thus, you had better not to logout while "ccs-queryd" is running.</p>

<p>Do a series of operations to confirm that programs that are protected by MAC can run properly. If some access permissions are missing, the messages will be printed to "ccs-queryd", so don't forget to monitor "ccs-queryd".</p>

<p>Note that "ccs-queryd" directly edits the policy currently loaded into the kernel. Thus, the changes made by "ccs-queryd" are lost by the system's shutdown. Be sure to run "ccs-savepolicy" to save the latest policy.</p>

<table border="1">
<tr><td>
/usr/sbin/ccs-savepolicy
</td></tr>
</table>

<p>You have finished updating policies. Close the console or terminal you executed "ccs-queryd".</p>

<p><a href="https://osdn.jp/"><img src="https://osdn.jp/sflogo.php?group_id=1973" width="96" height="31" alt="sflogo.php" title="SourceForge.jp"></a></p>
</body>
</html>
