<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>How to use TOMOYO Linux</title>
<link rel="stylesheet" href="tomoyo.css" media="all" type="text/css">
</head>
<body>
<p style="text-align:right;"><a href="../../ja/2.2.x/index.html">Japanese Page</a></p>
<h1>TOMOYO Linux Installation</h1>
<p style="text-align:right;">Last modified: $Date$</p>

<p>This page describes how to install and experience TOMOYO Linux.</p>

<h2>Compiling TOMOYO Linux kernel</h2>

<p>Download source code from "<a href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=summary">linux-2.6 git tree</a>" or "<a href="http://www.kernel.org/pub/linux/kernel/v2.6/testing/linux-2.6.30-rc1.tar.bz2">linux-2.6.30-rc1.tar.bz2</a>" and extract it.</p>

<p>Next, create a kernel config with TOMOYO Linux enabled.</p>

<pre>
$ make -s menuconfig
</pre>

<p>Go to "Security options" screen and select "Enable different security models" and "TOMOYO Linux Support".</p>

<pre>
[&nbsp;] Enable access key retention support
[*] Enable different security models
-*- Enable the securityfs filesystem
[&nbsp;] Socket and Networking Security Hooks
-*- Security hooks for pathname based access control
[&nbsp;] File POSIX Capabilities
(0) Low address space to protect from user allocation
[*] TOMOYO Linux Support
</pre>

<p>After creating a kernel config, compile the kernel.</p>

<pre>
$ make -s
# make -s modules_install install
</pre>

<p>Create initrd if you need.</p>

<p>Edit /boot/grub/grub.conf or /boot/grub/menu.lst to add security=tomoyo to the kernel command line parameters.</p>

<h2>Compiling TOMOYO Linux tools</h2>

<p>Download source code from <a href="http://osdn.dl.sourceforge.jp/tomoyo/30298/">TOMOYO project at SourceForge.jp</a> and and extract it and compile it.</p>

<pre>
$ wget <a href="http://osdn.dl.sourceforge.jp/tomoyo/30298/ccs-tools-1.6.7-20090401.tar.gz">http://osdn.dl.sourceforge.jp/tomoyo/30298/ccs-tools-1.6.7-20090401.tar.gz</a>
$ tar -zxf ccs-tools-1.6.7-20090401.tar.gz
$ cd ccstools
$ make
# make install
</pre>

<h2>Initial Configuration</h2>

<p>Run tomoyo_init_policy.sh included in TOMOYO Linux tools to perform initial configuration.</p>

<pre>
# /usr/lib/ccs/tomoyo_init_policy.sh
</pre>

<p>You will get initial configuration files in /etc/tomoyo/ directory.</p>

<h1>Tutorial</h1>

<p>Before starting tutorial, configure TOMOYO Linux to learn whole system behavior.</p>

<pre>
# echo '&lt;kernel&gt;' &gt; /etc/tomoyo/domain_policy.conf
# echo 'use_profile 1' &gt;&gt; /etc/tomoyo/domain_policy.conf
</pre>

<p>Reboot and login to the system as root user, and run ccs-editpolicy included in TOMOYO Linux tools.</p>

<pre>
# /usr/sbin/ccs-editpolicy
</pre>

<img src="howtouse/editpolicy1.png" alt="Initial screen of ccs-editpolicy" title="Inital screen of ccs-editpolicy" width="720" height="400">

<p>ccs-editpolicy is a CUI tool to view and edit TOMOYO Linux's policy. The initial screen shows list of domains generated from the execution of /sbin/init till execution of /usr/sbin/ccs-editpolicy . All domains begin at &lt;kernel&gt; and new domain is created whenever execve() is called.</p>

<p>Each line shows an integer value between the line number and domain names. This integer value is called "profile number" and it represents profile currently assigned to a domain. A profile is a correction of TOMOYO Linux's access control level, and the contents of /etc/tomoyo/profile.conf is loaded into kernel via /sys/kernel/security/tomoyo/profile by /sbin/tomoyo-init .</p>

<p>The following 4 profiles were automatically generated by execution of tomoyo_init_policy.sh . A profile is assigned to domains.</p>

<ul>
<li>profile 0 (disabled): Disabled. Works as if regular kernel.</li>
<li>profile 1 (learning): Learning mode. Not rejected if the request violates policy. Automatically appended to policy.</li>
<li>profile 2 (permissive): Permissive mode. Not rejected if the request violates policy. Not appended to policy automatically.</li>
<li>profile 3 (enforcing): Enforce mode. Rejected if the request violates policy.</li>
</ul>

<p>Move the cursor to some domain you like and press 'Enter' key to see ACL given to the domain.</p>

<p><img src="howtouse/editpolicy2.png" alt="ACL of /sbin/init" title="ACL of /sbin/init" width="720" height="400"></p>

<p>Browse the policy which is the results of learning boot sequence. You can easily know what process accesses what pathnames and/or resources.</p>

<p>Detailed usage of ccs-editpolicy is in <a href="tool-editpolicy.html">How to use Policy Editor</a>.</p>

<p>To quit ccs-editpolicy, press 'Q' key.</p>

<h2>First step: learning and enforcing commands</h2>

<p>Now, the domain for login shell is already learning mode. Try the following commands.</p>

<pre>
# head /etc/passwd
# bash
# tail /etc/mtab
# exit
</pre>

<p>You can operate as if the normal Linux, but the TOMOYO Linux kernel is monitoring accesses and generating policies and storing on the memory in the background.</p>

<p>Now, run ccs-editpolicy again. Change profile for the domains for login shell and its children/descendants from "learning mode" to "enforcing mode".</p>

<ul>
<li>Move the cursor to the domain for login shell and press 'Space' key to show '&amp;' mark.</li>
<li>Press 'C' key to copy '&amp;' mark to all domains under the cursor line.</li>
<li>Move the cursor to the next domain of the domain for login shell's children/descendants.</li>
<li>Press 'Space' key to clear '&amp;' mark.</li>
<li>Press 'C' key to copy ' ' mark to all domains under the cursor line.</li>
</ul>

<p><img src="howtouse/editpolicy3.png" width="720" height="400" alt="Mark bash and its children's domains" title="Mark bash and its children's domains"></p>

<p>After you marked '&amp;' to domains for login shell and its children/descendants, press 'S' '3' 'Enter' key to change profile for these domains from 1 to 3.</p>

<p><img src="howtouse/editpolicy4.png" width="720" height="400" alt="Profiles of bash and its children's domains became 3" title="Profiles of bash and its children's domains became 3"></p>

<p>After changing the profile for domain for login shell to 3, press 'Q' key to quit ccs-editpolicy and run some commands.</p>

<pre>
# head /etc/passwd                 # OK
# head /etc/shadow                 # NG
# rm -fr /                         # NG
# tail /etc/mtab                   # NG
# bash                             # OK
# tail /etc/mtab                   # OK
# head /etc/passwd                 # NG
</pre>

<p><img src="howtouse/enforcing.png" width="720" height="400" alt="Enforcing mode" title="Enforcing mode"></p>

<p>You can only run the operations you have just executed in learning mode. You ran "tail /etc/mtab" while in "learning mode", but you can't run it at the first stage of shell and you can run it at the second stage of shell. This is because these shells (first stage and second stage) have different "process invocation history" (i.e. these shells are in different domains) and permissions accumulated into these domains differ.</p>

<p>After you tried a series of operations, change profiles for domains for login shell to 1 using ccs-editpolicy, and proceed to the next tutorial.</p>

<h2>Second step: learning and enforcing server</h2>

<p>Next, let us learn and tune Apache policy. If Apache is not installed on your system, please install it.</p>

<p>Execute ccs-editpolicy (see the first step) and assign profile number 1 to an Apache domain.</p>

<p>Restart Apache and see the Apache domain. You can see the access permissions needed in Apache start sequence like follows:</p>

<pre>
allow_read /etc/httpd/conf/httpd.conf
allow_create /var/run/httpd.pid
allow_unlink /var/run/httpd.pid
</pre>

<p>These permissions allow Apache to open configuration files for reading. Moreover, request some web contents using web browser.</p>

<p>When you reload Apache policy, you can see the new permissions:</p>

<pre>
allow_read /var/www/html/index.html
</pre>

<p>Some patterns for pathname is supported (See <a href="policy-reference.html#wildcard_expression_rules">Policy Specifications of TOMOYO Linux</a>) .</p>

<p>Using pattern and range, Apache policy can be written like follows:</p>

<pre>
allow_read /var/www/\*
allow_read /var/www/\*/\*
allow_read /var/www/\*/\*/\*
allow_read /var/www/\*/\*/\*/\*
allow_read /var/www/\*/\*/\*/\*/\*
</pre>

<p>'\*' means "more than or equals to 0 character other than '/'". To append an entry using ccs-editpolicy, press 'A' key and input content and press 'Enter' key.</p>

<h2>Other documents</h2>

<ul>
<li><a href="policy-reference.html">Policy Specifications of TOMOYO Linux</a>: Detailed description of TOMOYO Linux functionalities and policy.</li>
<li><a href="tools-doc.html">Tools Documentation</a>: Usage of userland tools.</li>
<li><a href="tool-editpolicy.html">How to use Policy Editor</a>: Detailed usage of ccs-editpolicy.</li>
</ul>
<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>
</body>
</html>
