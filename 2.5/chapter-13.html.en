<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="en-US">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="content-style-type" content="text/css">
<link rel="stylesheet" href="../media/tomoyolinux.css" media="all" type="text/css">
<title>TOMOYO Linux 2.5.x : The Official Guide : Chapter 13</title>
</head>

<body>

<div id="titlebar">
<a href="../index.html.en"><img src="../media/tomoyotitle.png" alt="tomoyotitle.png" width="320" height="40" border="0" align="left" title="TOMOYO Linux"></a>
</div>

<div id="navbar" class="tomoyo-documentation">
<ul id="navbarlist">
<li id="tomoyo-home"><a href="../index.html.en" title="TOMOYO Linux Home Page">Home</a></li>
<li id="tomoyo-about"><a href="../about.html.en" title="About TOMOYO Linux">About</a></li>
<li id="tomoyo-download"><a href="../download.html.en" title="Get TOMOYO Linux">Download</a></li>
<li id="tomoyo-changelogs"><a href="../changelogs.html.en" title="TOMOYO Linux ChangeLogs">ChangeLogs</a></li>
<li id="tomoyo-documentation"><a href="../documentation.html.en" title="Official Documentation">Documentation</a></li>
<li id="tomoyo-support"><a href="../support.html.en" title="Support information">Support</a></li>
<li id="tomoyo-links"><a href="../links.html.en" title="Links">Links</a></li>
</ul>
<ul id="switch-language">
<li id="tomoyo-switch-language"><a href="chapter-13.html.ja" title="Go to Japanese page">Japanese page</a></li>
</ul>
</div>

<div id="content">

<div id="documentation">

<div class="navheader">
<p><a href="chapter-12.html.en">&lt;Prev&gt;</a> <a href="index.html.en">&lt;Index&gt;</a> <a href="chapter-14.html.en">&lt;Next&gt;</a></p>
</div>

<h2>Chapter 13: Securing Apache with the mod_tomoyo module</h2>

<h3><a name="13.1">13.1. The mod_tomoyo module</a></h3>

<p>mod_tomoyo is an Apache 2.x module that allows more precise control over Apache. This module allows domain transition based on virtual host names and CGI pathnames without requiring program execution. This way, each virtual host or CGI script can be isolated from each other and given different permissions in policy.</p>

<h3><a name="13.2">13.2. Installing the module</a></h3>

<h4><a name="13.2.1">13.2.1. Install dependencies</a></h4>

<p>This module is available for Linux 2.6 kernels only, and will not work with Linux 2.4 kernels.</p>

<p>These packages are required for compiling the module:</p>

<p><strong>RedHat distributions</strong></p>

<pre class="command">
# yum -y install httpd-devel
</pre>

<p><strong>Debian distributions</strong></p>

<pre class="command">
# apt-get -y install apache2-threaded-dev apache2-prefork-dev
</pre>

<h4><a name="13.2.2">13.2.2. Downloading the module</a></h4>

<p>Download the source code for the mod_tomoyo:</p>

<pre class="command">
# wget -O mod_tomoyo.c 'https://osdn.jp/projects/tomoyo/svn/view/branches/mod_tomoyo.c?revision=5673&amp;root=tomoyo'
</pre>

<p>Compile, install and activate mod_tomoyo:</p>

<h4><a name="13.2.3">13.2.3. Installing the module</a></h4>

<p><strong>RedHat distributions</strong></p>

<pre class="command">
# apxs -i -a -c mod_tomoyo.c
</pre>

<p><strong>Debian distributions</strong></p>

<pre class="command">
# apxs2 -i -a -c mod_tomoyo.c
</pre>

<p>If installation completed successfully, the following should be present in the Apache configuration files:</p>

<pre>
LoadModule tomoyo_module /usr/lib/httpd/modules/mod_tomoyo.so
</pre>

<h3><a name="13.3">13.3. Configuration</a></h3>

<p>The mod_tomoyo module performs domain transition based on the pathname of a requested file by specifying the mapping table of pathnames and domain names using the TOMOYO_TransitionMap directive. This can be placed in the Apache configuration files like this (assuming that IP addresses for www.tomoyo00.com etc. are specified in "/etc/hosts"):</p>

<pre>
&lt;VirtualHost *:80&gt;
    DocumentRoot /var/www/html-00
    ServerName www.tomoyo00.com
    TOMOYO_TransitionMap /etc/tomoyo/httpd-tomoyo00.conf
&lt;/VirtualHost&gt;

&lt;VirtualHost *:80&gt;
    DocumentRoot /var/www/html-01
    ServerName www.tomoyo01.com
    TOMOYO_TransitionMap /etc/tomoyo/httpd-tomoyo01.conf
&lt;/VirtualHost&gt;

&lt;VirtualHost *:80&gt;
    DocumentRoot /var/www/html-02
    ServerName www.tomoyo02.com
    TOMOYO_TransitionMap /etc/tomoyo/httpd-tomoyo02.conf
&lt;/VirtualHost&gt;

&lt;VirtualHost *:80&gt;
    DocumentRoot /var/www/html-03
    ServerName www.tomoyo03.com
    TOMOYO_TransitionMap /etc/tomoyo/httpd-tomoyo03.conf
&lt;/VirtualHost&gt;
</pre>

<p>In the file specified by the TOMOYO_TransitionMap directive, the pathname of a requested file needs to be mapped to a domain name. For example, in "/etc/tomoyo/httpd-tomoyo00.com" the following might be specified:</p>

<pre>
/var/www/cgi-bin/\*         &lt;kernel&gt; //apache /www.tomoyo00.com /cgi-programs
/usr/share/horde/\{\*\}/\*  &lt;kernel&gt; //apache /www.tomoyo00.com /horde
/var/www/html/\{\*\}/\*     &lt;kernel&gt; //apache /www.tomoyo00.com /static-files
/\{\*\}/\*                  &lt;kernel&gt; //apache /www.tomoyo00.com /default
</pre>

<p>In domain policy, the domain transitions must be specified beforehand (otherwise Apache will fail with an Internal Server Error):</p>

<pre>
&lt;kernel&gt; /usr/sbin/httpd

task manual_domain_transition &lt;kernel&gt; //apache /www.tomoyo00.com /cgi-programs
task manual_domain_transition &lt;kernel&gt; //apache /www.tomoyo00.com /horde
task manual_domain_transition &lt;kernel&gt; //apache /www.tomoyo00.com /static-files
task manual_domain_transition &lt;kernel&gt; //apache /www.tomoyo00.com /default
</pre>

<p>Restart Apache. If the following error occurs on startup, then writing to the <a href="policy-specification/securityfs-interface.html.en#self_domain">/sys/kernel/security/tomoyo/self_domain</a> interface failed:</p>

<pre class="output">
mod_tomoyo: Unable to open /sys/kernel/security/tomoyo/self_domain for writing. (errno = 13)
</pre>

<p>This may appear in the error logs for Apache (e.g. "/var/log/httpd/error_log"):</p>

<pre class="output">
[Thu Jul 01 16:31:10 2010] [error] [client 127.0.0.1] (13)Permission denied: mod_tomoyo: Unable to open /sys/kernel/security/tomoyo/self_domain for writing.
</pre>

<p>Other error messages may appear if there are problems in the mapping file specified by the TOMOYO_TransitionMap directive.</p>

<p>To confirm that domain transitions are performed, create a simple CGI program:</p>

<pre class="command">
# cat &gt; /var/www/cgi-bin/test.cgi &lt;&lt; "EOF"
#!/usr/bin/perl

print "Content-type:text/html\r\n\r\n";
print "&lt;HTML&gt;\n";
print "&lt;HEAD&gt;\n";
print "&lt;TITLE&gt;test&lt;/TITLE&gt;\n";
print "&lt;/HEAD&gt;\n";
print "&lt;BODY&gt;\n";

open(IN, "/sys/kernel/security/tomoyo/self_domain") || print "error";
$domain = &lt;IN&gt;;
$domain =~ s/&amp;/&amp;amp;/g;
$domain =~ s/&lt;/&amp;lt;/g;
$domain =~ s/&gt;/&amp;gt;/g;
close(IN);
print $domain;
print "\n";

print "&lt;/BODY&gt;\n";
print "&lt;/HTML&gt;\n";
EOF
# chmod 755 /var/www/cgi-bin/test.cgi
</pre>

<p>Run the CGI programs using the curl command (or web browsers) and confirm that domain transitions are performed:</p>

<pre class="command">
# curl http://www.tomoyo00.com/cgi-bin/test.cgi
</pre>

<pre class="output">
&lt;HTML&gt;
&lt;HEAD&gt;
&lt;TITLE&gt;test&lt;/TITLE&gt;
&lt;/HEAD&gt;
&lt;BODY&gt;
&amp;lt;kernel&amp;gt; //apache /www.tomoyo00.com /cgi-programs /var/www/cgi-bin/test.cgi
&lt;/BODY&gt;
&lt;/HTML&gt;
[root@tomoyo ~]# curl http://www.tomoyo01.com/cgi-bin/test.cgi
&lt;HTML&gt;
&lt;HEAD&gt;
&lt;TITLE&gt;test&lt;/TITLE&gt;
&lt;/HEAD&gt;
&lt;BODY&gt;
&amp;lt;kernel&amp;gt; //apache /www.tomoyo01.com /cgi-programs /var/www/cgi-bin/test.cgi
&lt;/BODY&gt;
&lt;/HTML&gt;
[root@tomoyo ~]# curl http://www.tomoyo02.com/cgi-bin/test.cgi
&lt;HTML&gt;
&lt;HEAD&gt;
&lt;TITLE&gt;test&lt;/TITLE&gt;
&lt;/HEAD&gt;
&lt;BODY&gt;
&amp;lt;kernel&amp;gt; //apache /www.tomoyo02.com /cgi-programs /var/www/cgi-bin/test.cgi
&lt;/BODY&gt;
&lt;/HTML&gt;
[root@tomoyo ~]# curl http://www.tomoyo03.com/cgi-bin/test.cgi
&lt;HTML&gt;
&lt;HEAD&gt;
&lt;TITLE&gt;test&lt;/TITLE&gt;
&lt;/HEAD&gt;
&lt;BODY&gt;
&amp;lt;kernel&amp;gt; //apache /www.tomoyo03.com /cgi-programs /var/www/cgi-bin/test.cgi
&lt;/BODY&gt;
&lt;/HTML&gt;
</pre>

<p>Policy can now be developed for these domains as described in the <a href="index.html.en#core">core topics</a>.</p>

</div><!-- documentation -->

</div><!-- content -->

<div id="navfooter">
<hr>
<table>
<tr>
<td class="docs-previous">
<a href="chapter-12.html.en">Prev</a>
</td>
<td class="docs-index">
<a href="index.html.en">Index</a>
</td>
<td class="docs-next">
<a href="chapter-14.html.en">Next</a>
</td>
</tr>
<tr>
<td class="docs-previous-description">
<p>Chapter 12: Reinforced authentication</p>
</td>
<td class="docs-home">
</td>
<td class="docs-next-description">
<p>Chapter 14: How do I manage policy namespace?</p>
</td>
</tr>
</table>
</div>

<div id="footer">
<p class="language">Go to <a href="chapter-13.html.ja">Japanese page</a>.</p>
<p class="timestamp">Last modified: $Date$</p>
<p class="trademark">Linux&reg; is a registered trademark of Linus Torvalds world-wide. TOMOYO&reg; is a registered trademark of <a href="https://www.nttdata.com/global/en/">NTT DATA Corporation</a>.</p>
<p><a href="https://osdn.jp/"><img src="https://osdn.jp/sflogo.php?group_id=1973" width="96" height="31" alt="sflogo.php" title="SourceForge.jp"></a></p>
</div>

</body>
</html>
