<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="ja">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=shift_jis">
    <meta http-equiv="Content-Style-Type" content="text/css">
    <title>TOMOYO Linux 導入手順書 （Debian sarge版）</title>
    <link rel="stylesheet" href="../startup.css" media="all" type="text/css">
    <link rev="made" href="mailto:takedakn@nttdata.co.jp"> 
  </head>

  <body>
    <h1><a href="http://tomoyo.sourceforge.jp/">TOMOYO Linux</a> 導入手順書 （Debian sarge版）</h1>
    
    <ul>
      <li><a href="#l0">概要</a></li>
      <li><a href="#l1">インストール</a>
	<ul>
	  <li><a href="#l3">TOMOYO Linuxのカーネルのインストール</a></li>
	  <li><a href="#l5">TOMOYO Linuxのツールのインストール</a></li>
	</ul>
      </li>
      <li><a href="#l6">設定</a>
	<ul>
	  <li><a href="#l7">プロファイルの作成</a></li>
	  <li><a href="#l8">読み込むプロファイルの設定</a></li>
	  <li><a href="#l9">ポリシーの作成準備</a>
	    <ul>
              <li><a href="#l10">ポリシーの変更を許可するプログラムの指定</a></li>
              <li><a href="#l11">シャットダウン処理の修正</a></li>
              <li><a href="#l12">監査ログの取得準備</a></li>
              <li><a href="#l13">例外ポリシーの作成</a></li>
	    </ul>
	  </li>
	</ul>
      </li>
      <li><a href="#l14">運用</a>
	<ul>
	  <li><a href="#l15">自動学習モード</a></li>
	  <li><a href="#l16">ポリシーの参照と編集</a></li>
	  <li><a href="#l17">強制アクセス制御モード</a></li>
	</ul>
      </li>
    </ul>
    
    <h2><a name="l0">概要</a></h2>

    <p>以下では、Debian GNU/Linux 3.1 (sarge)にTOMOYO Linux 1.2を導入する手順を解説します。この手順書に従って操作すれば、TOMOYO Linuxの基本的な機能を理解し、簡単な設定と運用が行えるようになります。</p>
    <p>導入の流れは以下の通りです。</p>
    <ol>
      <li>TOMOYO Linuxのカーネルとツールのインストール</li>
      <li>基本的な設定</li>
      <li>ポリシーの自動学習と試験運用</li>
    </ol>

    <h2><a name="l1">インストール</a></h2>

    <h3><a name="l3">TOMOYO Linuxのカーネルのインストール</a></h3>
    <p>TOMOYO LinuxはLinuxカーネルへのパッチとして提供されており、本来はLinuxカーネルのソースコードにパッチを適用する作業が必要になります。しかしsargeの場合は、TOMOYO Linuxのパッチを当てたコンパイル済みカーネルパッケージが提供されているので、今回はそれを利用します。</p>
    <p>まずはパッケージをダウンロードします。</p>
    <pre>
      # <span class="user">wget http://osdn.dl.sourceforge.jp/tomoyo/21518/kernel-image-2.6.8-16sarge5-ccs_1.2_i586.deb</span>
    </pre>
    <p>次に、ダウンロードしてきたパッケージをインストールします。</p>
    <pre>
      # <span class="user">dpkg --install kernel-image-2.6.8-16sarge5-ccs_1.2_i586.deb</span>
      Selecting previously deselected package kernel-image-2.6.8-16sarge5-ccs-i586.
      (Reading database ... 11049 files and directories currently installed.)
      Unpacking kernel-image-2.6.8-16sarge5-ccs-i586 (from kernel-image-2.6.8-16sarge5-ccs_1.2_i586.deb) ...
      Setting up kernel-image-2.6.8-16sarge5-ccs-i586 (1.2) ...
      Searching for GRUB installation directory ... found: /boot/grub .
      Testing for an existing GRUB menu.list file... found: /boot/grub/menu.lst .
      Searching for splash image... none found, skipping...
      Found kernel: /boot/vmlinuz-2.6.8-16sarge5-ccs
      Found kernel: /boot/vmlinuz-2.6.8-2-386
      Updating /boot/grub/menu.lst ... done
    </pre>
    <p>インストールに成功すれば/boot/grub/menu.lstに以下の記述が追加されているはずです。</p>

    <pre>
      title           Debian GNU/Linux, kernel 2.6.8-16sarge5-ccs
      root            (hd0,0)
      kernel          /boot/vmlinuz-2.6.8-16sarge5-ccs root=/dev/sda1 ro
      initrd          /boot/initrd.img-2.6.8-16sarge5-ccs
      savedefault
      boot

      title           Debian GNU/Linux, kernel 2.6.8-16sarge5-ccs (recovery mode)
      root            (hd0,0)
      kernel          /boot/vmlinuz-2.6.8-16sarge5-ccs root=/dev/sda1 ro single
      initrd          /boot/initrd.img-2.6.8-16sarge5-ccs
      savedefault
      boot
    </pre>

    <p>今後カーネルの選択を行いやすくするために、/boot/grub/menu.lstの"timeout"の行をコメントアウトしておきます。</p>
    <pre>
      <span class="user">#</span>timeout 5
    </pre>

    <h3><a name="l5">TOMOYO Linuxのツールのインストール</a></h3>
    <p>カーネルの次は、TOMOYO Linuxのツールをインストールします。ツールには、ポリシーの管理を行うプログラムが収録されています。</p>
    <p>カーネルと同様、sargeにはコンパイル済みのtarballが用意されていますので、それをダウンロードします。
      ツールは/root/ccstoolsディレクトリに置くことにします。</p>
    <pre>
      # <span class="user">cd /root</span>
      # <span class="user">wget http://osdn.dl.sourceforge.jp/tomoyo/21518/ccs-tools-1.2-i386-Sarge.tar.gz</span>
    </pre>
    <p>ダウンロードしてきたファイルを解凍すればツールのインストールは終了です。</p>
    <pre>
      # <span class="user">tar zxf ccs-tools-1.2-i386-Sarge.tar.gz</span>
    </pre>

    <h2><a name="l6">設定</a></h2>

    <h3><a name="l7">プロファイルの作成</a></h3>
    <p>TOMOYO Linuxには多くの機能があり、どの機能をON/OFFにするのかの設定をプロファイルとよびます。プロファイルは/root/security/profile$INDEX.txt（$INDEXは整数）というファイルに保存し、TOMOYO Linuxのカーネルの引数でどのプロファイルを用いるかを指定することができます。</p>
    <p>今回はファイルに対するアクセス制御の機能のみを利用するため、そのためのプロファイルを2つ（1つは自動学習モード、もう1つは強制アクセス制御モード）用意します。</p>
    <p>まず、プロファイルやその他の設定ファイルを保存するためのディレクトリをつくります。</p>
    <pre>
      # <span class="user">mkdir /root/security</span>
      # <span class="user">cd /root/security</span>
    </pre>
    <p>そして、/root/securityに、profile0.txtとprofile1.txtというファイルを作成します。</p>

    <pre>
      # <span class="user">cat &gt; profile0.txt &lt;&lt; EOF</span>
      <span class="user">MAC_FOR_FILE=1</span>
      <span class="user">EOF</span>
      # <span class="user">cat &gt; profile1.txt &lt;&lt; EOF</span>
      <span class="user">MAC_FOR_FILE=3</span>
      <span class="user">EOF</span>
    </pre>
    <p>MAC_FOR_FILE=1が「ファイルに対するアクセスの自動学習モード」であり、MAC_FOR_FILE=3が「ファイルに対する強制アクセス制御モード」です。自動学習モードでおこなったアクセスを元に、強制アクセス制御モードでアクセス制御をおこなう、というのが基本的な運用の流れです。</p>
    <h3><a name="l8">読み込むプロファイルの設定</a></h3>
    <p>カーネルの読み込み時にどのプロファイルを使用するかは、カーネルの引数で指定します。カーネルにCCS=$INDEXという引数を与えて起動すると、/root/security/profile$INDEX.txtというプロファイルを読み込みます。</p>

    <p>それでは、TOMOYO Linuxの起動モードの設定をおこないましょう。</p>
    <p>カーネルのインストール時にも一部確認しましたが、/boot/grub/menu.lstの末尾は以下のようになっているはずです。</p>

    <pre>
      title           Debian GNU/Linux, kernel 2.6.8-16sarge5-ccs
      root            (hd0,0)
      kernel          /boot/vmlinuz-2.6.8-16sarge5-ccs root=/dev/sda1 ro
      initrd          /boot/initrd.img-2.6.8-16sarge5-ccs
      savedefault
      boot

      title           Debian GNU/Linux, kernel 2.6.8-16sarge5-ccs (recovery mode)
      root            (hd0,0)
      kernel          /boot/vmlinuz-2.6.8-16sarge5-ccs root=/dev/sda1 ro single
      initrd          /boot/initrd.img-2.6.8-16sarge5-ccs
      savedefault
      boot

      title           Debian GNU/Linux, kernel 2.6.8-2-386
      root            (hd0,0)
      kernel          /boot/vmlinuz-2.6.8-2-386 root=/dev/sda1 ro
      initrd          /boot/initrd.img-2.6.8-2-386
      savedefault
      boot

      title           Debian GNU/Linux, kernel 2.6.8-2-386 (recovery mode)
      root            (hd0,0)
      kernel          /boot/vmlinuz-2.6.8-2-386 root=/dev/sda1 ro single
      initrd          /boot/initrd.img-2.6.8-2-386
      savedefault
      boot
    </pre>

    <p>今回はprofile0.txtを読み込むモードとprofile1.txtを読み込むモード2つを選択したいので、TOMOYO Linuxカーネルの項目を2つにして、それぞれのタイトルと引数を変えます。引数のCCSは大文字でなければいけないことに注意してください。</p>

    <pre>
      title           Debian GNU/Linux, kernel 2.6.8-16sarge5-ccs <span class="user">ACCEPT MODE</span>
      root            (hd0,0)
      kernel          /boot/vmlinuz-2.6.8-16sarge5-ccs root=/dev/sda1 ro <span class="user">CCS=0</span>
      initrd          /boot/initrd.img-2.6.8-16sarge5-ccs
      savedefault
      boot

      title           Debian GNU/Linux, kernel 2.6.8-16sarge5-ccs <span class="user">ENFORCE MODE</span>
      root            (hd0,0)
      kernel          /boot/vmlinuz-2.6.8-16sarge5-ccs root=/dev/sda1 ro <span class="user">CCS=1</span>
      initrd          /boot/initrd.img-2.6.8-16sarge5-ccs
      savedefault
      boot

      title           Debian GNU/Linux, kernel 2.6.8-16sarge5-ccs (recovery mode)
      root            (hd0,0)
      kernel          /boot/vmlinuz-2.6.8-16sarge5-ccs root=/dev/sda1 ro single
      initrd          /boot/initrd.img-2.6.8-16sarge5-ccs
      savedefault
      boot

      title           Debian GNU/Linux, kernel 2.6.8-2-386
      root            (hd0,0)
      kernel          /boot/vmlinuz-2.6.8-2-386 root=/dev/sda1 ro
      initrd          /boot/initrd.img-2.6.8-2-386
      savedefault
      boot

      title           Debian GNU/Linux, kernel 2.6.8-2-386 (recovery mode)
      root            (hd0,0)
      kernel          /boot/vmlinuz-2.6.8-2-386 root=/dev/sda1 ro single
      initrd          /boot/initrd.img-2.6.8-2-386
      savedefault
      boot
    </pre>

    <p>"ACCEPT MODE"がprofile0.txtを読み込む自動学習モード、"ENFORCE MODE"がprofile1.txtを読み込む強制アクセス制御モードです。</p>
    <h3><a name="l9">ポリシーの作成準備</a></h3>

    <p>TOMOYO Linuxのポリシーの作成は、先ほどカーネルの起動オプションで設定した自動学習モードでおこなえますが、その前にいくつか準備が必要です。この準備作業はTOMOYO Linuxのカーネルではなく、必ず通常のカーネルで行ってください。TOMOYO Linuxのカーネルで準備作業を行っても、シャットダウン時に設定が上書きされてしまいます。</p>
    <p>現在動作中のカーネルの情報を出力するには、unameコマンドを使います。</p>
    <pre>
      # <span class="user">uname --kernel-release</span>
      2.6.8-2-386
    </pre>
    <p>上記のように、kernel-releaseに"ccs"が含まれていなければOKです。</p>
    <p>ポリシーの作成準備は以下の流れでおこないます。</p>
    <ol>
      <li>ポリシーの変更を許可するプログラムの指定</li>
      <li>シャットダウン処理の修正</li>
      <li>監査ログの取得準備</li>

      <li>例外ポリシーの作成</li>
    </ol>
    <p>ポリシーの設定ファイルは、プロファイルと同様にすべて/root/securityディレクトリに置きます。</p>
    <h4><a name="l10">ポリシーの変更を許可するプログラムの指定</a></h4>
    <p>ポリシーを変更することができるプログラムを、/root/security/manager.txtというファイルで指定します。ccs-toolsの中の3つのプログラムを以下のように指定してください。</p>
    <pre>
      # <span class="user">cat &gt; /root/security/manager.txt &lt;&lt; EOF</span>
      <span class="user">/root/ccstools/loadpolicy</span>
      <span class="user">/root/ccstools/editpolicy</span>
      <span class="user">/root/ccstools/setlevel</span>
      <span class="user">EOF</span>
    </pre>

    <h4><a name="l11">シャットダウン処理の修正</a></h4>
    <p>TOMOYO Linuxの動作中、ポリシーはメモリ上に置かれています。電源が切れる直前のポリシーをファイルに保存するため、シャットダウンスクリプトとリブートスクリプトの中で/root/ccstools/savepolicyが実行されるように修正を加えます。</p>

    <p>まずはシャットダウンスクリプトである/etc/init.d/haltの末尾を以下のように書き換えます。</p>

    <table><tr><th>変更前</th><th>変更後</th></tr><tr>
	  <td>
	    <pre>
	      halt -d -f -i $poweroff $hddown
	      : exit 0
	    </pre>
	  </td>
	  <td>
	    <pre>
	      <span class="user">halt --help 2&gt; /dev/null</span>
	      <span class="user">/root/ccstools/savepolicy a</span>
	      halt -d -f -i $poweroff $hddown
	      : exit 0
	    </pre>
	  </td>
	</tr></table>

    <p>次に、リブートスクリプトである/etc/init.d/rebootの末尾を以下のように書き換えます。</p>

    <table><tr><th>変更前</th><th>変更後</th></tr><tr>
	  <td>
	    <pre>
	      reboot -d -f -i
	    </pre>
	  </td>
	  <td>
	    <pre>
	      <span class="user">reboot --help 2&gt; /dev/null</span>
	      <span class="user">/root/ccstools/savepolicy a</span>
	      reboot -d -f -i
	    </pre>
	  </td>
	</tr></table>

    <p>savepolicyの前にhalt/rebootを一度実行しているのは、halt/rebootをポリシーに追加するためです。また、savepolicyの引数"a"は、すべてのポリシーを保存するオプションです。</p>

    <h4><a name="l12">監査ログの取得準備</a></h4>
    <p>TOMOYO Linuxのログは、アクセスが許可された要求のログと、アクセスが拒否された要求のログの2種類に分けることができます。今回は、アクセス拒否ログのみを保存する設定を行います。</p>
    <p>ログを保存するには、ccs-toolsのccs-auditdというデーモンプログラムを使用します。アクセス拒否ログのみを保存する設定でccs-auditdをLinuxの起動時に実行するには、まず、以下のコマンドで/etc/init.dにシェルスクリプトを作成し、実行権限を与えます。</p>
    <pre>
      # <span class="user">cat &gt; /etc/init.d/ccs-auditd &lt;&lt; EOF</span>
      <span class="user">#!/bin/sh</span>
      <span class="user">/root/ccstools/ccs-auditd /dev/null /var/log/tomoyo/reject_log.txt</span>
      <span class="user">EOF</span>
      # <span class="user">chmod +x /etc/init.d/ccs-auditd</span>
    </pre>
    <p>そして、以下のコマンドでLinuxの起動時に呼び出すシンボリックリンクを作成します。</p>
    <pre>
      # <span class="user">update-rc.d ccs-auditd start 99 2 3 4 5 .</span>
      Adding system startup for /etc/init.d/ccs-auditd ...
      /etc/rc2.d/S99ccs-auditd -&gt; ../init.d/ccs-auditd
      /etc/rc3.d/S99ccs-auditd -&gt; ../init.d/ccs-auditd
      /etc/rc4.d/S99ccs-auditd -&gt; ../init.d/ccs-auditd
      /etc/rc5.d/S99ccs-auditd -&gt; ../init.d/ccs-auditd
    </pre>
    <p>この設定では、/var/log/tomoyo/reject_log.txtにアクセス拒否ログが保存されます。ログを保存するディレクトリをあらかじめ作っておきます。</p>
    <pre>
      # <span class="user">mkdir /var/log/tomoyo</span>
    </pre>
    <h4><a name="l13">例外ポリシーの作成</a></h4>

    <p>ポリシー生成の前には、以下の4種類の例外を設定しておく必要があります。</p>
    <ol>
      <li>/proc/PID のように同様のパス名をパターン化する際のパターン名</li>
      <li>すべてのプログラムに対して参照することを許可するパス名</li>
      <li>デーモンとして動作させるプログラムのパス名</li>
      <li>強制アクセス制御が適用されない信頼済みドメイン</li>
    </ol>
    <p>以上の4種類の例外ポリシーを自動的に生成するスクリプトmake_exception.shが、ccs-toolsに用意されています。make_exception.shを使って例外ポリシーを生成して保存するには以下のようにします。</p>
    <pre>
      # <span class="user">/root/ccstools/make_exception.sh &gt; /root/security/exception_policy.txt</span>
    </pre>
    <p>以上でTOMOYO Linuxを使うための基本的な設定は終わりです。</p>

    <h2><a name="l14">運用</a></h2>

    <h3><a name="l15">自動学習モード</a></h3>
    <p>それでは、TOMOYO Linuxにポリシーを学習させましょう。今回は、ログイン後の以下の操作をTOMOYO Linuxに学習させることにします。</p>
    <ol>
      <li>dateコマンドを実行する</li>
      <li>headコマンドで/etc/passwdの先頭3行を表示する</li>
      <li>tcshを起動する</li>
      <li>tailコマンドで/etc/passwdの末尾3行を表示する</li>
    </ol>
    <p>まずは学習モードで起動するために、Linuxを再起動します。</p>

    <pre>
      # <span class="user">reboot</span>
    </pre>
    <p>カーネルの選択画面で"ACCEPT MODE"を選択してEnterを押します。</p>
    <p><img alt="grub_accept.png" width="720" height="400" src="grub_accept.png"></p>
    <p>rootでログインし、上記の操作を行います。</p>
    <p><img alt="ope_accept.png" width="640" height="480" src="ope_accept.png"></p>
    <p>一見普通のLinuxと変わりなく操作できますが、裏ではTOMOYO Linuxがアクセス許可を監視し、操作ごとにポリシーとしてメモリ上に記憶しています。</p>
    <h3><a name="l16">ポリシーの参照と編集</a></h3>
    <p>生成されたポリシーの参照・編集には、ccs-toolsのeditpolicyを用います。</p>
    <p>editpolicyを起動すると、TOMOYO Linuxが学習したドメイン遷移が表示されます。</p>

    <p><img alt="editpolicy1.png" width="640" height="480" src="editpolicy1.png"></p>
    <p>ドメイン遷移はプロセスの親子関係をそのまま反映しており、どのプロセスからどのプロセスが実行されたのかを見て取ることができます。</p>
    <p>ドメイン遷移の中から、gettyを探してみてください。</p>
    <p><img alt="editpolicy2.png" width="640" height="480" src="editpolicy2.png"></p>
    <p>/sbin/getty下の/bin/login以下では、ログインしてからのプロセス実行履歴が分かります。その中からさらに、/usr/bin/headコマンドを探してみてください。headコマンドの行でEnterキーを押すと、以下の画面が表示されます。</p>
    <p><img alt="editpolicy3.png" width="640" height="480" src="editpolicy3.png"></p>
    <p>これは先ほどの操作で学習したポリシーで、</p>
    <blockquote>
      <p>&lt;kernel&gt; /sbin/getty /bin/login /bin/bash /usr/bin/headというドメイン（赤下線）には/etc/passwdへの読み込みアクセス（青下線）を許可する</p>
    </blockquote>

    <p>ということを意味しています。</p>
    <p>
      このようにTOMOYO Linuxでは、絶対パスを用いたプロセスの実行履歴を用いてドメイン分けを行っており、同じコマンドであっても、実行履歴により区別されたアクセス制御を行うことができます。また、ドメインにおけるファイルに対するアクセス許可は、  通常のLinuxにおけるファイルに対するパーミッションと同様の3種類（読み込み・書き込み・実行）の他に、ファイルの新規作成・削除・名前変更なども設定できます。</p>
    <p>学習モードで学習されたポリシーはシャットダウン時にファイルに保存され、次回の起動時には自動的に読み込まれます。実際の運用では、再起動を含めて許可したい操作を何回か学習させ、ポリシーエディタで不要なアクセス許可を除いていく、という操作を繰り返します。</p>
    <h3><a name="l17">強制アクセス制御モード</a></h3>
    <p>それでは、先ほど自動学習したポリシーを使って、強制アクセス制御を行います。Linuxを再起動し、今度は"ENFORCE MODE"のカーネルでLinuxを起動してください。このモードでは、TOMOYO Linuxは起動時にポリシーの読み込みを行い、ポリシーに含まれない操作を拒否します。</p>
    <p>rootでログインした後、以下の操作を行ってみます。</p>
    <ol>
      <li>dateコマンドを実行</li>
      <li>headコマンドで/etc/passwdの先頭3行を表示</li>

      <li>tailコマンドで/etc/passwdの末尾3行を表示（エラー）</li>
      <li>headコマンドで/etc/shadowの先頭3行を表示（エラー）</li>
      <li>tcshを起動</li>
      <li>dateコマンドを実行（エラー）</li>
    </ol>
    <p><img alt="ope_enforce.png" width="640" height="480" src="ope_enforce.png"></p>
    <p>図中の赤下線のコマンドは先ほど学習モードで行った操作ですので、問題なく実行できます。逆に青下線のコマンドはエラーになります。</p>
    <p>エラーになった操作のログは、ccs-toolsのccs-auditdによって/var/log/tomoyo/reject_log.txtに保存されています。</p>
    <pre>
      #2006-08-07 12:16:43# pid=1691 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0
      &lt;kernel&gt; /sbin/getty /bin/login /bin/bash
      1 /usr/bin/tail

      #2006-08-07 12:16:43# pid=1691 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0
      &lt;kernel&gt; /sbin/getty /bin/login /bin/bash
      4 /usr/bin/tail

      #2006-08-07 12:16:51# pid=1692 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0
      &lt;kernel&gt; /sbin/getty /bin/login /bin/bash /usr/bin/head
      4 /etc/shadow

      #2006-08-07 12:16:56# pid=1694 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0
      &lt;kernel&gt; /sbin/getty /bin/login /bin/bash /bin/tcsh
      1 /bin/date
    </pre>
    
    <hr>
    <address><a href="/">TOMOYO Linux</a> is supported by <a href="http://www.nttdata.co.jp/">NTT DATA CORPORATION</a><br>
      <a href="mailto:haradats@gmail.com">Send message to Webadmin</a><br>
      Last modified: $Date$<br>
      <!--#include virtual="/cgi-bin/counter.pl" -->
    </address>

    <p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>
    <p><a href="http://validator.w3.org/check?uri=referer">
	<img src="http://www.w3.org/Icons/valid-html401"
	  alt="Valid HTML 4.01 Strict" height="31" width="88"></a></p>
  </body>
</html>
