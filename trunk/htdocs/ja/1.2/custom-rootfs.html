<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="ja-JP">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=shift_jis">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>カスタムルートファイルシステムの構築マニュアル</title>
<link rel="stylesheet" href="tomoyo.css" media="all" type="text/css">
</head>
<body>
<h1>カスタムルートファイルシステムの構築マニュアル</h1>
<p style="text-align:right;">Last modified: $Date$</p>
<hr>
<p>必要最小限のファイルのみを含んだカスタマイズされたルートファイルシステムを作成する手順について説明します。</p>

<h1><a name="1">１．準備</a></h1>

<p><a href="minimum-install.html">TOMOYO Linux導入手順（簡易版）</a>の<a href="minimum-install.html#update-exception">「例外ポリシーの更新」</a>の直前までの操作を行います。<br>
ただし、<a href="minimum-install.html#create-exceptions">「例外ポリシーの作成」</a>において、 /root/security/exception_policy.txt を作成後、以下のように修正する必要があります。</p>

<ul>
<li>allow_read で始まる行を除外する
<li>/dev/ /proc/ /sys/ /root/security/ 以外で始まる file_pattern を除外する
</ul>

<p>毎回ファイル名が変化するテンポラリファイルに関するエラーメッセージは無視してください。</p>

<h1><a name="2">２．イメージファイルの作成</a></h1>

<h2><a name="2.1">2.1 ファイル一覧の抽出</a></h2>
<p>ここから先は通常のカーネルで操作してください。</p>
<p>以下のコマンドを実行して、 /root/security/domain_policy.txt からファイル名の一覧を抽出します。</p>
<table border="1">
<tr><td>
grep -v '&lt;kernel&gt;' ~/security/domain_policy.txt | grep / | awk ' { print $2; print $3; } ' | grep -v ^/proc/ | grep -v ^/sys/ | grep -v ^/root/ccstools/ | grep -v /root/security/ | sort | uniq &gt; ~/filelist.tmp
</td></tr>
</table>
<p>抽出されたファイル名の一覧から、不要なファイル（ログファイル、PIDファイル、一時ファイル等）を除外します。</p>

<table border="1">
<tr><td>
grep -v /tmp/ ~/filelist.tmp | grep -v /var/log/ | grep -v /var/run/ | grep -v /var/tmp/ &gt; ~/filelist.txt
</td></tr>
</table>
<p>~/filelist.txt に、不要なファイルが含まれていないことを確認してください。ロケールファイル（/usr/lib/locale/locale-archive）は非常に大きいため、容量の制限がある場合は除外してください。</p>

<h2><a name="2.2">2.2 リンク情報の取得</a></h2>
<p>以下のコマンドを実行し、ハードリンクとシンボリックリンクの一覧を作成します。</p>
<table border="1">
<tr><td>
find / -type l -print0 | /root/ccstools/dumpsymlink &gt; ~/symlink.txt<br>
find / -links +1 -print0 | /root/ccstools/dumplink &gt; ~/link.txt
</td></tr>
</table>

<h2><a name="2.3">2.3 コピー先領域のマウント</a></h2>
<p>コピー先を用意し、適当な場所にマウントします。ここでは、 /tmp/rootfs という名前のループバックイメージファイルを /data.tmp/ にマウントする場合で説明します。initramfsとして作成する場合はcpioで固めれば良いので、マウントする必要はありません。</p>
<table border="1">
<tr><td>
mkdir -p /data.tmp<br>
mount -o loop /tmp/rootfs /data.tmp/
</td></tr>
</table>

<h2><a name="2.4">2.4 ファイルのコピー</a></h2>
<p>必要なディレクトリを作成し、ファイルをコピーします。</p>
<p>カーネル 2.4 系の場合は sys と selinux ディレクトリは不要です。</p>
<p>~/filelist.txt で使用しているファイル名の表記はTOMOYO Linux独自形式であり、 cpio が受け取るファイル名の形式とは異なっていますが、ほとんどの場合、空白や改行などを含むファイル名は含まれていないので問題は発生しないはずです。</p>
<table border="1">
<tr><td>
cd /data.tmp/<br>
mkdir -pm 755 sys selinux<br>
mkdir -pm 755 proc dev dev/shm dev/pts var/log var/run var/tmp var/run/netreport<br>
mkdir -pm 1777 tmp<br>
mkdir -pm 111 var/empty/sshd<br>
mknod dev/console c 5 1<br>
mknod dev/null c 1 3<br>
mknod dev/zero c 1 5<br>
cpio -pdm . &lt; ~/filelist.txt<br>
find var/log/ -type f -print0 | xargs -0 rm<br>
find var/lock/ -type f -print0 | xargs -0 rm<br>
find var/run/ -type f -print0 | xargs -0 rm
</td></tr>
</table>

<h2><a name="2.5">2.5 リンク情報の反映</a></h2>
<p>必要なハードリンクとシンボリックリンクを作成します。ハードリンクとシンボリックリンクが互いに依存している場合があるため、１回で全て作成できるとは限らないので、交互に数回繰り返してください。</p>
<table border="1">
<tr><td>
for i in 1 2 3 4 5<br>
do<br>
/root/ccstools/makelink /data.tmp/ &lt; ~/link.txt<br>
/root/ccstools/makesymlink /data.tmp/ &lt; ~/symlink.txt<br>
done
</td></tr>
</table>

<h2><a name="2.6">2.6 コピー先領域のアンマウント</a></h2>
<p>アンマウントします。必要に応じて gzip で圧縮します。</p>
<table border="1">
<tr>
<td>cd<br>
umount -d /data.tmp/<br></td>
</tr>
</table>
<p>initramfs として作成している場合は以下のコマンドを実行します。</p>
<table border="1">
<tr><td>
cd /data.tmp/<br>
find -print0 | cpio -o0 -H newc | gzip -9 &gt; /tmp/initrd.img
</td></tr>
</table>
<hr>
<p><a href="index.html#manual">目次へ戻る</a></p>
</body>
</html>
