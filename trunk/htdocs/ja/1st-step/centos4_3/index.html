<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="ja">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=shift_jis">
    <meta http-equiv="Content-Style-Type" content="text/css">
    <title>TOMOYO Linux 導入手順書 （CentOS 4.4版）</title>
    <link rel="stylesheet" href="../startup.css" media="all" type="text/css">
    <link rev="made" href="mailto:takedakn@nttdata.co.jp"> 
  </head>

  <body>
    <h1><a href="http://tomoyo.sourceforge.jp/">TOMOYO Linux</a> 導入手順書 （CentOS 4.4版）</h1>
    
    <ul>
      <li><a href="#l0">概要</a></li>
      <li><a href="#l1">インストール</a>
	<ul>
	  <li><a href="#l2">SELinuxを一時的に無効にする</a></li>
	  <li><a href="#l3">TOMOYO Linuxのカーネルのインストール</a></li>
	  <li><a href="#l4">SELinuxを再度有効にする</a></li>
	  <li><a href="#l5">TOMOYO Linuxのツールのインストール</a></li>
	</ul>
      </li>
      <li><a href="#l6">設定</a>
	<ul>
	  <li><a href="#l7">プロファイルの作成</a></li>
	  <li><a href="#l8">読み込むプロファイルの設定</a></li>
	  <li><a href="#l9">ポリシーの作成準備</a>
	    <ul>
              <li><a href="#l10">ポリシーの変更を許可するプログラムの指定</a></li>
              <li><a href="#l11">シャットダウン処理の修正</a></li>
              <li><a href="#l12">監査ログの取得準備</a></li>
              <li><a href="#l13">例外ポリシーの作成</a></li>
	    </ul>
	  </li>
	</ul>
      </li>
      <li><a href="#l14">運用</a>
	<ul>
	  <li><a href="#l15">自動学習モード</a></li>
	  <li><a href="#l16">ポリシーの参照と編集</a></li>
	  <li><a href="#l17">強制アクセス制御モード</a></li>
	</ul>
      </li>
    </ul>

    <h2><a name="l0">概要</a></h2>

    <p>以下では、CentOS 4.4にTOMOYO Linux 1.2を導入する手順を解説します。この手順書に従って操作すれば、TOMOYO Linuxの基本的な機能を理解し、簡単な設定と運用が行えるようになります。</p>
    <p>導入の流れは以下の通りです。</p>
    <ol>
      <li>TOMOYO Linuxのカーネルとツールのインストール</li>
      <li>基本的な設定</li>
      <li>ポリシーの自動学習と試験運用</li>
    </ol>

    <h2><a name="l1">インストール</a></h2>

    <h3><a name="l2">SELinuxを一時的に無効にする</a></h3>
    <p>CentOSは、インストール時のデフォルトでSELinuxが有効になっています。
      TOMOYO Linuxの導入の際には、カーネルのインストールのため、一時的にSELinuxを無効にする必要があります。</p>
    <p>現在SELinuxが有効になっているかどうかは、getenforceコマンドで確認できます。</p>

    <pre>
      # <span class="user">getenforce</span>
      Enforcing
    </pre>
    <p>上記のように、"Enforcing"が表示されればSELinuxは有効になっています。</p>

    <p>
      SELinuxによるアクセス制御を一時的に無効にするには、setenforceコマンドを使います。
    </p>
    <pre>
      # <span class="user">setenforce Permissive</span>
    </pre>

    <p>再度getenforceコマンドを実行し、"Permissive"が表示されることを確かめてください。</p>

    <pre>
      # <span class="user">getenforce</span>
      Permissive
    </pre>
    <h3><a name="l3">TOMOYO Linuxのカーネルのインストール</a></h3>
    <p>TOMOYO LinuxはLinuxカーネルへのパッチとして提供されており、
      本来はLinuxカーネルのソースコードにパッチを適用する作業が必要になります。
      しかしCentOS 4.4の場合は、TOMOYO Linuxのパッチを当てたコンパイル済みカーネルパッケージが
      提供されているので、今回はそれを利用します。</p>
    <p>まずはパッケージをダウンロードします。</p>
    <pre>
      # <span class="user">wget http://osdn.dl.sourceforge.jp/tomoyo/21518/kernel-2.6.9-42.0.3.EL_tomoyo_1.2.i586.rpm</span>
    </pre>
    <p>次に、ダウンロードしてきたパッケージをインストールします。</p>
    <pre>
      # <span class="user">rpm --install kernel-2.6.9-42.0.3.EL_tomoyo_1.2.i586.rpm</span>
    </pre>
    <p>この際特にメッセージは表示されませんが、
      インストールに成功すれば/etc/grub.confに以下の記述が追加されているはずです。</p>
    <pre>
      title CentOS (2.6.9-42.0.3.EL_tomoyo_1.2)
      root (hd0,0)
      kernel /vmlinuz-2.6.9-42.0.3.EL_tomoyo_1.2 ro root=/dev/VolGroup00/LogVol00
      initrd /initrd-2.6.9-42.0.3.EL_tomoyo_1.2.img
    </pre>
    <p>今後カーネルの選択を行いやすくするために、
      /etc/grub.confの"timeout="と"hiddenmenu"の行を
      コメントアウトしておきます。</p>
    <pre>
      <span class="user">#</span>timeout=5
    </pre>
    <pre>
      <span class="user">#</span>hiddenmenu
    </pre>

    <h3><a name="l4">SELinuxを再度有効にする</a></h3>
    <p>
      前の手順でSELinuxを無効にした場合は、再度setenforceコマンドを実行して
      SELinuxを有効にします。
    </p>
    <pre>
      # <span class="user">setenforce Enforcing</span>
    </pre>

    <h3><a name="l5">TOMOYO Linuxのツールのインストール</a></h3>
    <p>カーネルの次は、TOMOYO Linuxのツールをインストールします。
      ツールには、ポリシーの管理を行うプログラムが収録されています。</p>
    <p>カーネルと同様、CentOS 4.4にはコンパイル済みのtarballが用意されていますので、
      それをダウンロードします。
      ツールは/root/ccstoolsディレクトリに置くことにします。</p>
    <pre>
      # <span class="user">cd /root</span>
      # <span class="user">wget http://osdn.dl.sourceforge.jp/tomoyo/21518/ccs-tools-1.2-i386-CentOS4.4.tar.gz</span>
    </pre>
    <p>ダウンロードしてきたファイルを解凍すればツールのインストールは終了です。</p>
    <pre>
      # <span class="user">tar zxf ccs-tools-1.2-i386-CentOS4.4.tar.gz</span>
    </pre>

    <h2><a name="l6">設定</a></h2>

    <h3><a name="l7">プロファイルの作成</a></h3>
    <p>TOMOYO Linuxには多くの機能があり、どの機能をON/OFFにするのかの設定をプロファイルとよびます。プロファイルは/root/security/profile$INDEX.txt（$INDEXは整数）というファイルに保存し、TOMOYO Linuxのカーネルの引数でどのプロファイルを用いるかを指定することができます。</p>
    <p>今回はファイルに対するアクセス制御の機能のみを利用するため、
      そのためのプロファイルを2つ（1つは自動学習モード、もう1つは強制アクセス制御モード）用意します。</p>
    <p>まず、プロファイルやその他の設定ファイルを保存するためのディレクトリをつくります。</p>
    <pre>
      # <span class="user">mkdir /root/security</span>
      # <span class="user">cd /root/security</span>
    </pre>
    <p>そして、/root/securityに、profile0.txtとprofile1.txtというファイルを作成します。</p>

    <pre>
      # <span class="user">cat &gt; profile0.txt &lt;&lt; EOF</span>
      <span class="user">MAC_FOR_FILE=1</span>
      <span class="user">EOF</span>
      # <span class="user">cat &gt; profile1.txt &lt;&lt; EOF</span>
      <span class="user">MAC_FOR_FILE=3</span>
      <span class="user">EOF</span>
    </pre>
    <p>MAC_FOR_FILE=1が「ファイルに対するアクセスの自動学習モード」であり、
      MAC_FOR_FILE=3が「ファイルに対する強制アクセス制御モード」です。
      自動学習モードでおこなったアクセスを元に、強制アクセス制御モードでアクセス制御をおこなう、
      というのが基本的な運用の流れです。</p>
    <h3><a name="l8">読み込むプロファイルの設定</a></h3>
    <p>カーネルの読み込み時にどのプロファイルを使用するかは、カーネルの引数で指定します。カーネルにCCS=$INDEXという引数を与えて起動すると、/root/security/profile$INDEX.txtというプロファイルを読み込みます。</p>

    <p>それでは、TOMOYO Linuxの起動モードの設定をおこないましょう。</p>
    <p>カーネルのインストール時にも一部確認しましたが、/etc/grub.conf全体は以下のようになっているはずです。</p>
    <pre>
      # grub.conf generated by anaconda
      #
      # Note that you do not have to rerun grub after making changes to this file
      # NOTICE:  You have a /boot partition.  This means that
      #          all kernel and initrd paths are relative to /boot/, eg.
      #          root (hd0,0)
      #          kernel /vmlinuz-version ro root=/dev/VolGroup00/LogVol00
      #          initrd /initrd-version.img
      #boot=/dev/sda
      default=0
      #timeout=5
      splashimage=(hd0,0)/grub/splash.xpm.gz
      #hiddenmenu
      title CentOS (2.6.9-42.0.3.EL_tomoyo_1.2)
      root (hd0,0)
      kernel /vmlinuz-2.6.9-42.0.3.EL_tomoyo_1.2 ro root=/dev/VolGroup00/LogVol00
      initrd /initrd-2.6.9-42.0.3.EL_tomoyo_1.2.img
      title CentOS-4 i386 (2.6.9-42.0.3.EL)
      root (hd0,0)
      kernel /vmlinuz-2.6.9-42.0.3.EL ro root=/dev/VolGroup00/LogVol00
      initrd /initrd-2.6.9-42.0.3.EL.img
    </pre>
    <p>今回はprofile0.txtを読み込むモードとprofile1.txtを読み込むモード2つを選択したいので、TOMOYO Linuxカーネルの項目を2つにして、それぞれのタイトルと引数を変えます。引数のCCSは大文字でなければいけないことに注意してください。</p>
    <pre>
      # grub.conf generated by anaconda
      #
      # Note that you do not have to rerun grub after making changes to this file
      # NOTICE:  You have a /boot partition.  This means that
      #          all kernel and initrd paths are relative to /boot/, eg.
      #          root (hd0,0)
      #          kernel /vmlinuz-version ro root=/dev/VolGroup00/LogVol00
      #          initrd /initrd-version.img
      #boot=/dev/sda
      default=0
      #timeout=5
      splashimage=(hd0,0)/grub/splash.xpm.gz
      #hiddenmenu
      title CentOS (2.6.9-42.0.3.EL_tomoyo_1.2) <span class="user">ACCEPT MODE</span>
      root (hd0,0)
      kernel /vmlinuz-2.6.9-42.0.3.EL_tomoyo_1.2 ro root=/dev/VolGroup00/LogVol00 <span class="user">CCS=0</span>
      initrd /initrd-2.6.9-42.0.3.EL_tomoyo_1.2.img
      title CentOS (2.6.9-42.0.3.EL_tomoyo_1.2) <span class="user">ENFORCE MODE</span>
      root (hd0,0)
      kernel /vmlinuz-2.6.9-42.0.3.EL_tomoyo_1.2 ro root=/dev/VolGroup00/LogVol00 <span class="user">CCS=1</span>
      initrd /initrd-2.6.9-42.0.3.EL_tomoyo_1.2.img
      title CentOS-4 i386 (2.6.9-42.0.3.EL)
      root (hd0,0)
      kernel /vmlinuz-2.6.9-42.0.3.EL ro root=/dev/VolGroup00/LogVol00
      initrd /initrd-2.6.9-42.0.3.EL.img
    </pre>
    <p>"ACCEPT MODE"がprofile0.txtを読み込む自動学習モード、"ENFORCE MODE"がprofile1.txtを読み込む強制アクセス制御モードです。</p>
    <h3><a name="l9">ポリシーの作成準備</a></h3>

    <p>TOMOYO Linuxのポリシーの作成は、先ほどカーネルの起動オプションで設定した自動学習モードでおこなえますが、
      その前にいくつか準備が必要です。
      この準備作業はTOMOYO Linuxのカーネルではなく、必ず通常のカーネルで行ってください。
      TOMOYO Linuxのカーネルで準備作業を行っても、シャットダウン時に設定が上書きされてしまいます。</p>
    <p>現在動作中のカーネルの情報を出力するには、unameコマンドを使います。</p>
    <pre>
      # <span class="user">uname --kernel-release</span>
      2.6.9-42.0.3.EL
    </pre>
    <p>上記のように、kernel-releaseに"tomoyo"が含まれていなければOKです。</p>
    <p>ポリシーの作成準備は以下の流れでおこないます。</p>
    <ol>
      <li>ポリシーの変更を許可するプログラムの指定</li>
      <li>シャットダウン処理の修正</li>
      <li>監査ログの取得準備</li>

      <li>例外ポリシーの作成</li>
    </ol>
    <p>ポリシーの設定ファイルは、プロファイルと同様にすべて/root/securityディレクトリに置きます。</p>
    <h4><a name="l10">ポリシーの変更を許可するプログラムの指定</a></h4>
    <p>ポリシーを変更することができるプログラムを、/root/security/manager.txtというファイルで指定します。ccs-toolsの中の3つのプログラムを以下のように指定してください。</p>
    <pre>
      # <span class="user">cat &gt; /root/security/manager.txt &lt;&lt; EOF</span>
      <span class="user">/root/ccstools/loadpolicy</span>
      <span class="user">/root/ccstools/editpolicy</span>
      <span class="user">/root/ccstools/setlevel</span>
      <span class="user">EOF</span>
    </pre>

    <h4><a name="l11">シャットダウン処理の修正</a></h4>
    <p>TOMOYO Linuxの動作中、ポリシーはメモリ上に置かれています。電源が切れる直前のポリシーをファイルに保存するため、シャットダウンスクリプトの中で/root/ccstools/savepolicyが実行されるように修正を加えます。</p>
    <p>CentOSのシャットダウンスクリプトは/etc/rc.d/init.d/haltです。haltの最後の行は以下のようになっているはずです。</p>
    <pre>
      exec $command $HALTARGS
    </pre>
    <p>このコマンドの直前にsavepolicyを実行するように変更します。</p>
    <pre>
      <span class="user">/root/ccstools/savepolicy a</span>
      exec $command $HALTARGS
    </pre>
    <p>savepolicyの引数"a"は、すべてのポリシーを保存するオプションです。</p>

    <h4><a name="l12">監査ログの取得準備</a></h4>
    <p>TOMOYO Linuxのログは、アクセスが許可された要求のログと、アクセスが拒否された要求のログの2種類に分けることができます。
      今回は、アクセス拒否ログのみを保存する設定を行います。</p>
    <p>ログを保存するには、ccs-toolsのccs-auditdというデーモンプログラムを使用します。
      アクセス拒否ログのみを保存する設定でccs-auditdをLinuxの起動時に実行するには、
      /etc/rc.d/rc.localの末尾に以下の1行を追加します。</p>
    <pre>
      <span class="user">/root/ccstools/ccs-auditd /dev/null /var/log/tomoyo/reject_log.txt</span>
    </pre>
    <p>この設定では、/var/log/tomoyo/reject_log.txtにアクセス拒否ログが保存されます。
      ログを保存するディレクトリをあらかじめ作っておきます。</p>
    <pre>
      # <span class="user">mkdir /var/log/tomoyo</span>
    </pre>
    <h4><a name="l13">例外ポリシーの作成</a></h4>

    <p>ポリシー生成の前には、以下の4種類の例外を設定しておく必要があります。</p>
    <ol>
      <li>/proc/PID のように同様のパス名をパターン化する際のパターン名</li>
      <li>すべてのプログラムに対して参照することを許可するパス名</li>
      <li>デーモンとして動作させるプログラムのパス名</li>
      <li>強制アクセス制御が適用されない信頼済みドメイン</li>
    </ol>
    <p>以上の4種類の例外ポリシーを自動的に生成するスクリプトmake_exception.shが、ccs-toolsに用意されています。
      make_exception.shを使って例外ポリシーを生成して保存するには以下のようにします。</p>
    <pre>
      # <span class="user">/root/ccstools/make_exception.sh &gt; /root/security/exception_policy.txt</span>
    </pre>
    <p>以上でTOMOYO Linuxを使うための基本的な設定は終わりです。</p>

    <h2><a name="l14">運用</a></h2>

    <h3><a name="l15">自動学習モード</a></h3>
    <p>それでは、TOMOYO Linuxにポリシーを学習させましょう。
      今回は、ログイン後の以下の操作をTOMOYO Linuxに学習させることにします。</p>
    <ol>
      <li>dateコマンドを実行する</li>
      <li>headコマンドで/etc/passwdの先頭3行を表示する</li>
      <li>tcshを起動する</li>
      <li>tailコマンドで/etc/passwdの末尾3行を表示する</li>
    </ol>
    <p>まずは学習モードで起動するために、Linuxを再起動します。</p>

    <pre>
      # <span class="user">reboot</span>
    </pre>
    <p>カーネルの選択画面で"ACCEPT MODE"を選択してEnterを押します。</p>
    <p><img alt="grub_accept.png" width="640" height="480" src="grub_accept.png"></p>
    <p>rootでログインし、上記の操作を行います。</p>
    <p><img alt="ope_accept.png" width="720" height="400" src="ope_accept.png"></p>
    <p>一見普通のLinuxと変わりなく操作できますが、
      裏ではTOMOYO Linuxがアクセス許可を監視し、
      操作ごとにポリシーとしてメモリ上に記憶しています。</p>
    <h3><a name="l16">ポリシーの参照と編集</a></h3>
    <p>生成されたポリシーの参照・編集には、ccs-toolsのeditpolicyを用います。</p>
    <p>editpolicyを起動すると、TOMOYO Linuxが学習したドメイン遷移が表示されます。</p>

    <p><img alt="editpolicy1.png" width="720" height="400" src="editpolicy1.png"></p>
    <p>ドメイン遷移はプロセスの親子関係をそのまま反映しており、
      どのプロセスからどのプロセスが実行されたのかを見て取ることができます。</p>
    <p>ドメイン遷移の中から、mingettyを探してみてください。</p>
    <p><img alt="editpolicy2.png" width="720" height="400" src="editpolicy2.png"></p>
    <p>/sbin/mingetty下の/bin/login以下では、ログインしてからのプロセス実行履歴が分かります。
      その中からさらに、/usr/bin/headコマンドを探してみてください。
      headコマンドの行でEnterキーを押すと、以下の画面が表示されます。</p>
    <p><img alt="editpolicy3.png" width="720" height="400" src="editpolicy3.png"></p>
    <p>これは先ほどの操作で学習したポリシーで、</p>
    <blockquote>
      <p>&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash /usr/bin/headというドメイン（赤下線）には/etc/passwdへの読み込みアクセス（青下線）を許可する</p>
    </blockquote>

    <p>ということを意味しています。</p>
    <p>
      このようにTOMOYO Linuxでは、
      絶対パスを用いたプロセスの実行履歴を用いてドメイン分けを行っており、
      同じコマンドであっても、実行履歴により区別されたアクセス制御を行うことができます。
      また、ドメインにおけるファイルに対するアクセス許可は、
      通常のLinuxにおけるファイルに対するパーミッションと
      同様の3種類（読み込み・書き込み・実行）の他に、
      ファイルの新規作成・削除・名前変更なども設定できます。
    </p>
    <p>学習モードで学習されたポリシーはシャットダウン時にファイルに保存され、
      次回の起動時には自動的に読み込まれます。
      実際の運用では、再起動を含めて許可したい操作を何回か学習させ、
      ポリシーエディタで不要なアクセス許可を除いていく、
      という操作を繰り返します。</p>
    <h3><a name="l17">強制アクセス制御モード</a></h3>
    <p>それでは、先ほど自動学習したポリシーを使って、強制アクセス制御を行います。
      Linuxを再起動し、今度は"ENFORCE MODE"のカーネルでLinuxを起動してください。
      このモードでは、TOMOYO Linuxは起動時にポリシーの読み込みを行い、
      ポリシーに含まれない操作を拒否します。</p>
    <p>rootでログインした後、以下の操作を行ってみます。</p>
    <ol>
      <li>dateコマンドを実行</li>
      <li>headコマンドで/etc/passwdの先頭3行を表示</li>

      <li>tailコマンドで/etc/passwdの末尾3行を表示（エラー）</li>
      <li>headコマンドで/etc/shadowの先頭3行を表示（エラー）</li>
      <li>tcshを起動</li>
      <li>dateコマンドを実行（エラー）</li>
    </ol>
    <p><img alt="ope_enforce.png" width="720" height="400" src="ope_enforce.png"></p>
    <p>図中の赤下線のコマンドは先ほど学習モードで行った操作ですので、問題なく実行できます。
      逆に青下線のコマンドはエラーになります。</p>
    <p>エラーになった操作のログは、ccs-toolsのccs-auditdによって/var/log/tomoyo/reject_log.txtに保存されています。</p>
    <pre>
      #2006-08-02 11:51:34# pid=2953 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0
      &lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash
      1 /usr/bin/tail

      #2006-08-02 11:51:34# pid=2953 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0
      &lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash
      4 /usr/bin/tail

      #2006-08-02 11:51:40# pid=2954 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0
      &lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash /usr/bin/head
      4 /etc/shadow

      #2006-08-02 11:51:47# pid=2980 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0
      &lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash /bin/tcsh
      1 /bin/date
    </pre>
    
    <hr>
    <address><a href="/">TOMOYO Linux</a> is supported by <a href="http://www.nttdata.co.jp/">NTT DATA CORPORATION</a><br>
    <a href="mailto:haradats@gmail.com">Send message to Webadmin</a><br>
    Last modified: $Date: 2006-11-21 21:53:39 +0900 (Tue, 21 Nov 2006) $<br>
    <!--#include virtual="/cgi-bin/counter.pl" -->
    </address>

    <p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>
   <p><a href="http://validator.w3.org/check?uri=referer">
   <img src="http://www.w3.org/Icons/valid-html401"
    alt="Valid HTML 4.01 Strict" height="31" width="88"></a></p>
  </body>
</html>
