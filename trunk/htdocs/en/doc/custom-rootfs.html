<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>Manual for creating customized root fs</title>
<link rel="stylesheet" href="tomoyo.css" media="all" type="text/css">
</head>
<body>
<h1>Manual for creating customized root fs</h1>
<p style="text-align:right;">Last modified: $Date: 2006-11-21 21:53:39 +0900 (Tue, 21 Nov 2006) $ JST</p>
<hr>
<p>This manual describes how to create a customized root fs that contains minimum files.</p>

<h1><a name="1">1. Preparation</a></h1>

<p>Do operations until just before <a href="minimum-install.html#update-exception">Updating Exception Policy</a> described in <a href="minimum-install.html">TOMOYO Linux Install manual (Simplified version)</a>.<br>
But you need to modify /root/security/exception_policy.txt as follows after creating /root/security/exception_policy.txt at <a href="minimum-install.html#create-exceptions">Creating Exception Policy</a>.</p>

<ul>
<li>Exclude lines that starts with "allow_read".
<li>Exclude lines that starts with "file_pattern" but does not include "/dev/" "/proc/" "/sys/" or "/root/security/".
</ul>

<p>Ignore error messages related to temporary files that have no fixed filenames.</p>

<h1><a name="2">2. Creating image file</a></h1>

<h2><a name="2.1">2.1 Extracting file list</a></h2>
<p>From now on, you can use normal kernels.</p>
<p>Extract a list of filenames from /root/security/domain_policy.txt .</p>
<table border="1">
<tr><td>
grep -v '&lt;kernel&gt;' ~/security/domain_policy.txt | grep / | awk ' { print $2; print $3; } ' | grep -v ^/proc/ | grep -v ^/sys/ | grep -v ^/root/ccstools/ | grep -v /root/security/ | sort | uniq &gt; ~/filelist.tmp
</td></tr>
</table>
<p>Exclude unnecessary filenames (such as log files, PID files, temporary files).</p>
<table border="1">
<tr><td>
grep -v /tmp/ ~/filelist.tmp | grep -v /var/log/ | grep -v /var/run/ | grep -v /var/tmp/ &gt; ~/filelist.txt
</td></tr>
</table>
<p>Check that ~/filelist.txt doesn't contain unnecessary filenames.<br>
The locale file ( /usr/lib/locale/locale-archive ) is very large, you may remove if the capacity limit exists.</p>

<h2><a name="2.2">2.2 Getting link information</a></h2>
<p>Get the list of hard links and symbolic links.</p>
<table border="1">
<tr><td>
find / -type l -print0 | /root/ccstools/dumpsymlink &gt; ~/symlink.txt<br>
find / -links +1 -print0 | /root/ccstools/dumplink &gt; ~/link.txt
</td></tr>
</table>

<h2><a name="2.3">2.3 Mounting destination</a></h2>
<p>Create temporal directory for copying files. Mount the loopback image file on the directory.<br>
In this manual, the loopback image file /tmp/rootfs is mounted on the directory /data.tmp/ .<br>
If you want to create root fs as initramfs, you needn't to mount, for initramfs is created by cpio.</p>
<table border="1">
<tr><td>
mkdir -p /data.tmp<br>
mount -o loop /tmp/rootfs /data.tmp/
</td></tr>
</table>

<h2><a name="2.4">2.4 Copying files</a></h2>
<p>Create necessary directories and copy files.</p>
<p>You needn't to create sys and selinux directories if you are using kernel 2.4 series.</p>
<p>The pathname representation rule for ~/filelist.txt and cpio differs, but in most cases it's OK,<br>
for pathnames in ~/filelist.txt seldom contains non-printable characters (such as white space, carriage return).</p>
<table border="1">
<tr><td>
cd /data.tmp/<br>
mkdir -pm 755 sys selinux<br>
mkdir -pm 755 proc dev dev/shm dev/pts var/log var/run var/tmp var/run/netreport<br>
mkdir -pm 1777 tmp<br>
mkdir -pm 111 var/empty/sshd<br>
mknod dev/console c 5 1<br>
mknod dev/null c 1 3<br>
mknod dev/zero c 1 5<br>
cpio -pdm . &lt; ~/filelist.txt<br>
find var/log/ -type f -print0 | xargs -0 rm<br>
find var/lock/ -type f -print0 | xargs -0 rm<br>
find var/run/ -type f -print0 | xargs -0 rm
</td></tr>
</table>

<h2><a name="2.5">2.5 Reflecting link information</a></h2>
<p>Create minimum and necessary hard links and symbolic links.<br>
Since the hard link and the symbolic link might depend each other, repeat creating for several times.</p>
<table border="1">
<tr><td>
for i in 1 2 3 4 5<br>
do<br>
/root/ccstools/makelink /data.tmp/ &lt; ~/link.txt<br>
/root/ccstools/makesymlink /data.tmp/ &lt; ~/symlink.txt<br>
done
</td></tr>
</table>

<h2><a name="2.6">2.6 Unmounting destination</a></h2>
<p>Unmount the directory. Compress using gzip if you need.</p>
<table border="1">
<tr><td>
cd<br>
umount -d /data.tmp/
</td></tr>
</table>
<p>If you want to create as initramfs, do the following.</p>
<table border="1">
<tr><td>
cd /data.tmp/<br>
find -print0 | cpio -o0 -H newc | gzip -9 &gt; /tmp/initrd.img
</td></tr>
</table>
<hr>
<p><a href="index.html#manual">Return to index</a></p>
</body>
</html>
