<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="ja-JP">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>TOMOYO Linux LiveCD チュートリアル for CentOS 5.3</title>
<link rel="stylesheet" href="http://tomoyo.sourceforge.jp/tomoyo.css" media="all" type="text/css">
<link rev="made" href="mailto:k.takeda26@gmail.com"> 
</head>
<body>
<p style="text-align:right;"><a href="http://tomoyo.sourceforge.jp/en/1.6.x/1st-step/centos5-live/index.html">English Page</a></p>
<h1><a href="http://tomoyo.sourceforge.jp/">TOMOYO Linux</a> LiveCD チュートリアル</h1>

<ul>
<li><a href="#l1">概要</a></li>
<li><a href="#l2">LiveCDを入手する</a></li>
<li><a href="#l3">LiveCDで起動する</a></li>
<li><a href="#l4">LiveCDを使ってみる</a></li>
<li><a href="#l5">アクセスを制限してみる</a></li>
<li><a href="#l7">（参考）さらにTOMOYO Linuxを使いこなす</a></li>
</ul>

<h2><a name="l1">概要</a></h2>

<p>
以下ではTOMOYO LinuxのLiveCDの使い方について解説します。
TOMOYO Linux LiveCDは、CDで起動できるLinuxディストリビューションであるCentOSに、
TOMOYO Linuxカーネルとツールをインストールして基本的な設定を行った状態で配布しているCDイメージです。
TOMOYO Linux LiveCDを使うことで、既存の環境に影響を与えることなく手軽にTOMOYO Linuxを体験できます。
</p>

<h2><a name="l2">LiveCDを入手する</a></h2>

<p>
TOMOYO Linux LiveCDのISOイメージは、TOMOYO Linuxプロジェクトの
<a href="http://tomoyo.sourceforge.jp/wiki/?TomoyoLive#h3ff15c3">LiveCDのページ</a>
からダウンロードできます。
</p>

<p>
ダウンロードしたISOイメージは書き込みソフトでCD-Rに焼いてください。
また、無料で利用できる<a href="http://www.vmware.com/jp/products/player/">VMware Player</a>で
ISOイメージのままTOMOYO Linux LiveCDを起動することもできます。
</p>

<h2><a name="l3">LiveCDで起動する</a></h2>

<p>
CD-Rに焼いたLiveCDをCD-ROMドライブに入れてマシンを起動するか、
前節で紹介した方法でVMware Player上でISOイメージから起動すると、
以下の画面が表示されます。
</p>

<p><img src="isolinux.png" width="640" height="480" alt="起動画面" title="起動画面"></p>

<p>
この状態でしばらく待つかEnterキーを押すと、通常のCentOSと同様に起動します。
以下のようなデスクトップが表示されればLiveCDでの起動は完了です。
</p>


<p><img src="desktop.png" width="800" height="600" alt="デスクトップ" title="デスクトップ"></p>

<h2><a name="l4">LiveCDを使ってみる</a></h2>

<p>
基本的に通常のCentOSとほとんど同じですが、
デスクトップにTOMOYO Linux独自の2つのアイコンが存在します。
</p>

<p>
<img src="icon_editpolicy.png" width="138" height="88" alt="TOMOYO Linuxポリシーエディタ" title="TOMOYO Linuxポリシーエディタ">
<img src="icon_rejectlog.png" width="138" height="88" alt="TOMOYO Linuxポリシー違反ログ" title="TOMOYO Linuxポリシー違反ログ">
</p>

<p>
まずは「TOMOYO Linuxポリシー違反ログ」アイコンをダブルクリックしてみてください。
以下のようなウィンドウが表示されます。
</p>

<p><img src="reject_log.png" width="665" height="462" alt="ポリシー違反ログウィンドウ" title="ポリシー違反ログウィンドウ"></p>

<p>
この画面はTOMOYO Linuxのポリシーに違反したアクセスログを表示しており、
新たなアクセス違反が発生すればすぐに表示されるようになっています。
LiveCDは何も許可を与えないポリシーで起動されるので、
全てのアクセスがポリシー違反ログとして出力されます。
ウィンドウを開いたままで、さまざまな操作をしてみてください。
どんなプロセスがどんなファイルにアクセスしたかが逐次表示されます。
</p>

<p>
続けて、「TOMOYO Linuxポリシーエディタ」アイコンをダブルクリックしてみてください。
以下のようなウィンドウが表示されます。
</p>

<p><img src="editpolicy.png" width="665" height="462" alt="ポリシーエディタウィンドウ" title="ポリシーエディタウィンドウ"></p>

<p>
この画面には今までにどのようなプロセスが起動されたかを木構造で表示しており、
それぞれの行はドメインとよばれます。
システム起動時から、実行されたすべてのプロセスがTOMOYO Linuxカーネルで監視されており、
どんなプロセスがどんなファイルにアクセスしたかなどの情報が、すべてポリシーとして記録されています。
ポリシーエディタを使ってポリシーをブラウズするだけで、
システムの挙動を手に取るように把握することができるのがTOMOYO Linux LiveCDの最大の特徴です。
</p>

<p>
ポリシーエディタの最初の画面では、&lt;kernel&gt;を基点として、
どんなプロセスがどんなプロセスを起動したのかが木構造で表示されます。
カーソルキーやPageUp, PageDownキーで適当にスクロールして、
システム内でどんなプロセスが起動されたかを調べてみてください。
</p>

<p>
試しにgnome-terminalというプロセスを探してみましょう。
'F'キーを押すと最下行に検索のための1行入力が表示されますので、
そこに'gnome-terminal'と入力してEnterキーを押すことで、
すぐにgnome-terminalを見つけられます。
</p>

<p><img src="find.png" width="311" height="59" alt="gnome-terminalを検索" title="gnome-terminalを検索"></p>

<p>
gnome-terminalの下には/usr/bin/sudoという行が存在し、
さらにその下に、/usr/bin/tailや/usr/lib/ccs/editpolicyという行が
存在するのが見てとれます。
</p>

<p><img src="domain_gnome-terminal.png" width="686" height="84" alt="gnome-terminalのドメイン周辺" title="gnome-terminalのドメイン周辺"></p>

<p>
表示されている/usr/bin/tailの行にカーソルを合わせてEnterキーを押してみましょう。
</p>

<p><img src="acl_tail.png" width="665" height="462" alt="tailコマンドのアクセス許可" title="tailコマンドのアクセス許可"></p>

<p>
それぞれの行の一番左が行番号で、その次に表示されている単語はアクセスの種類を表しています。
allow_executeが実行を許可、allow_writeが書き込みモードでのオープンを許可、allow_readが読み込みモードでのオープンを許可、allow_read/writeが読み書きモードでのオープンを許可、allow_envが環境変数名の受け取り許可を表しています。
画面から、tailコマンドが各種ロケールファイルと、/var/log/tomoyo/reject_log.txtというファイルを読み込んだことが読み取れます。
これはデスクトップの「TOMOYO Linuxポリシー違反ログ」という
アイコンをダブルクリックして実行した結果学習されたポリシーです。
</p>

<p>
もとのドメインの木構造の画面に戻るためにはEnterキーを押します。
プロセスがどういう履歴で起動され、どんな資源にアクセスしているかをブラウズしてみてください。
</p>

<h2><a name="l5">アクセスを制限してみる</a></h2>

<p>
学習されたポリシーを見るだけでなく、TOMOYO Linuxによるアクセス制御を体験してみましょう。
先ほどのポリシーエディタの画面は閉じずにそのままにしておいて、
画面上端に表示されている「アプリケーション」メニューから、「アクセサリ」「端末」を起動してください。
</p>

<p><img src="menu_terminal.png" width="380" height="320" alt="端末の起動" title="端末の起動"></p>

<p>
端末が起動できたら、先ほどのポリシーエディタの画面に戻り、ドメインの木構造が表示されている状態で、
'R'キーを押してポリシーを再読み込みしてください。
そして、gnome-terminal以下の/bin/bashを探して見てください。
検索は先ほどと同じく'F'キーで行えます。
</p>

<p><img src="domain_bash.png" width="667" height="192" alt="gnome-terminalから起動されたbash" title="gnome-terminalから起動されたbash"></p>

<p>
これは先ほど起動した端末内で実行されているbashで、すでにsedやunameなどのプログラムを自動的に実行していることが分かります。
端末の画面で、以下のコマンドを実行してください。
</p>

<pre>
$ head /etc/passwd
$ bash
$ tail /etc/passwd
$ exit
</pre>

<p><img src="bash_learning.png" width="665" height="496" alt="bashに適当なコマンドを学習させる" title="bashに適当なコマンドを学習させる"></p>

<p>
再度ポリシーエディタの画面に戻って'R'キーを押すと、実行したプログラムが追加されていることが分かります。
</p>

<p><img src="bash_learned.png" width="665" height="262" alt="bashの学習結果" title="bashの学習結果"></p>

<p>
この画面で、行番号の次に表示されている数字に注目してください。
今は全ての行で'1'と表示されています。
</p>

<p><img src="profilenumber.png" width="665" height="262" alt="プロファイル番号は全部1" title="プロファイル番号は全部1"></p>

<p>
これはそのプロセスが動いているTOMOYO Linuxのモードを表しており、プロファイル番号とよばれる値です。
LiveCDのプロファイル番号は以下の4種類が存在し、あらかじめ全て1（学習モード）に設定されています。
</p>

<table border="1" summary="profile number">
<tr><th>プロファイル番号</th><th>意味</th></tr>
<tr><td>0</td><td>無効モード（TOMOYO Linuxは何もしない）</td></tr>
<tr><td>1</td><td>学習モード（ポリシー違反のアクセスは許可してポリシーに追加する）</td></tr>
<tr><td>2</td><td>確認モード（ポリシー違反のアクセスは許可してログを出力する）</td></tr>
<tr><td>3</td><td>強制モード（ポリシー違反のアクセスは拒否する）</td></tr>
</table>

<p>
TOMOYO Linuxのアクセス制御を有効にするには、プロファイル番号3の強制モードを割り当てる必要があります。
今回はプロセスツリーに存在する2つのbashをアクセス制御の対象としてみましょう。
まず、gnome-terminal直下のbashにカーソルを合わせてスペースキーを押します。
すると、行番号の左側に'&amp;'マークが表示されます。これでこの行が選択された状態になります。
</p>

<p><img src="bash_selected1.png" width="665" height="56" alt="1つ目のbashを選択した状態" title="1つ目のbashを選択した状態"></p>

<p>
さらに1つ下の行のbashも選択しましょう。カーソルを2つ目のbashに合わせてスペースキーを押すことで、
2つ目のbashに'&amp;'マークをつけることができます。
</p>

<p><img src="bash_selected2.png" width="665" height="56" alt="2つのbashを選択した状態" title="2つのbashを選択した状態"></p>

<p>
この状態で'S'キーを押すと、ポリシーエディタの最下行にプロファイル番号を入力する1行入力が表示されます。
アクセス制御を体験するために、選択した2つのbashにプロファイル3（強制モード）を割り当てましょう。
</p>

<p><img src="setprofile.png" width="665" height="40" alt="プロファイル番号3を割り当てる" title="プロファイル番号3を割り当てる"></p>

<p>2つのbashにプロファイル番号3が割り当てられました。</p>

<p><img src="bash_enforced.png" width="665" height="56" alt="2つのbashのプロファイルが3になった" title="2つのbashのプロファイルが3になった"></p>

<p>
これでもうbashは強制モードで動いています。端末の画面で適当なコマンドを入力してみてください。
先ほど学習モードで実行したコマンド以外は拒否されるはずです。以下の画面では、
head /etc/passwdの実行には成功していますが、lsやpsコマンドの実行は拒否されています。
</p>

<p><img src="1st_bash.png" width="665" height="340" alt="学習されたコマンド以外は拒否される" title="学習されたコマンド以外は拒否される"></p>

<p>
また、1段階目のbashではtail /etc/passwdは拒否されますが、bashをもう1段起動した場合には許可されます。
</p>

<p><img src="2nd_bash.png" width="665" height="330" alt="シェルレベルによるアクセス許可の違い" title="シェルレベルによるアクセス許可の違い"></p>

<p>
これは、TOMOYO Linuxがプロセスをその実行履歴によって区別していることに起因しています。
再度ポリシーエディタを見ると、
</p>

<ul>
<li>gnome-terminalから実行されたbash</li>
<li>gnome-terminalから実行されたbashから起動されたbash</li>
</ul>

<p>
の2種類のbashが存在し、headコマンドは1つ目の、tailコマンドは2つ目のbashのみにしか許可されていないことが分かります。
TOMOYO Linuxはシステム起動時から起動されたすべてのプロセスを監視しており、プロセスは実行履歴によって細かく区別されます。
</p>

<h2><a name="l7">（参考）さらにTOMOYO Linuxを使いこなす</a></h2>

<p>
上記手順で解説した内容で、TOMOYO Linuxの基本的な機能であるファイルに対するアクセス制御を体験できました。
TOMOYO Linuxにはここで紹介した機能以外にもさまざまな機能があります。
さらにTOMOYO Linuxを使いこなしたいという方は、以下のドキュメントをご参照ください。
</p>

<ul>
<li><a href="../../policy-reference.html">TOMOYO Linuxポリシー解説書</a>: TOMOYO Linuxの機能のリファレンス。</li>
<li><a href="/wiki/?WorldOfTomoyoLinux">TOMOYO Linuxの世界</a>: 2007年1月～12月のSoftware Designの連載。一通り機能を網羅したチュートリアルになっています。</li>
<li><a href="../../tool-editpolicy.html">ポリシーエディタの使い方</a>: 上記手順で使用したポリシーエディタの詳細な使い方。</li>
<li><a href="http://www.thinkit.co.jp/free/article/0706/17/1/">初体験 TOMOYO Linux！</a>: ThinkITでのTOMOYO Linux連載。</li>
</ul>

<hr>
<address><a href="http://tomoyo.sourceforge.jp/">TOMOYO Linux</a> is supported by <a href="http://www.nttdata.co.jp/">NTT DATA CORPORATION</a><br>
<a href="mailto:haradats@gmail.com">Send message to Webadmin</a><br>
Last modified: $Date$<br>
<!--#include virtual="/cgi-bin/counter.pl" -->
</address>

<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>

<p><a href="http://validator.w3.org/check?uri=referer">
<img src="http://www.w3.org/Icons/valid-html401" alt="Valid HTML 4.01 Strict" height="31" width="88"></a></p>

</body>
</html>
