<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja-JP">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>TOMOYO Linux 導入手順書 （Turbolinux 10 Server版）</title>
<link rel="stylesheet" href="http://tomoyo.sourceforge.jp/tomoyo.css" media="all" type="text/css">
<link rev="made" href="mailto:k.takeda26@gmail.com">
</head>
<body>

<h1><a href="http://tomoyo.sourceforge.jp/">TOMOYO Linux</a> 導入手順書 （Turbolinux 10 Server版）</h1>

<ul>
<li><a href="#l1">概要</a></li>
<li><a href="#l2">ツールのインストール</a></li>
<li><a href="#l3">自動設定スクリプトの実行</a></li>
<li><a href="#l4">監査ログの取得準備</a></li>
<li><a href="#l5">運用</a>
<ul>
<li><a href="#l6">システムの起動</a></li>
<li><a href="#l7">ログイン後の操作の学習</a></li>
<li><a href="#l8">ポリシーの参照</a></li>
<li><a href="#l9">強制アクセス制御</a></li>
</ul></li>
</ul>

<h2><a name="l1">概要</a></h2>

<p>以下では、Turbolinux 10 Server（カーネルバージョン 2.6.8-?? 以降）で
TOMOYO Linux 1.6.6を利用する手順を解説します。この手順書に従って操作すれば、
TOMOYO Linuxの基本的な機能を体験し、簡単な設定と運用が行えるようになります。</p>

<p>導入の流れは以下の通りです。</p>

<ol>
<li>ツールのインストール</li>
<li>基本的な設定</li>
<li>ポリシーの自動学習と試験運用</li>
</ol>

<h2><a name="l2">ツールのインストール</a></h2>

<p>TOMOYO Linuxのツールをインストールします。ツールには、ポリシーの管理を行うプログラムが収録されています。</p>

<p>Turbolinux 10 Serverにはバイナリパッケージが提供されていますので、それを利用します。</p>

<pre>
# <span class="user">wget -O ccs-tools-1.6.6-1.TL10S.i586.rpm 'http://sourceforge.jp/frs/redir.php?m=jaist&amp;f=/tomoyo/30299/ccs-tools-1.6.6-1.TL10S.i586.rpm'</span>
# <span class="user">rpm -ivh ccs-tools-1.6.6-1.TL10S.i586.rpm</span>
</pre>

<p>以上でTOMOYO Linuxのインストールは終了です。続いて設定に移ります。</p>

<h2><a name="l3">自動設定スクリプトの実行</a></h2>

<p>この節の操作を自動で行うスクリプトが付属しているのでそれを実行します。</p>

<pre>
# <span class="user">/usr/lib/ccs/init_policy.sh --file-only-profile</span>
</pre>

<p>init_policy.shは10分以上時間を要する場合がありますので気長にお待ちください。</p>

<h3>設定の保存ディレクトリについて</h3>

<p>TOMOYO Linuxの設定を保存するディレクトリは/etc/ccsです。</p>

<h3>プロファイルについて</h3>

<p>TOMOYO Linuxには多くの機能があり、どの機能をON/OFFにするのかの設定をプロファイルとよびます。
プロファイルは複数作成して切り替えて使うことができます。
すべてのプロファイルは/etc/ccs/profile.confという単一のファイルに保存します。</p>

<p>今回はファイルに対するアクセス制御の機能のみを利用するため、
/etc/ccs/profile.confの内容は以下のようなっているはずです。</p>

<pre>
0-COMMENT=-----Disabled Mode-----
0-MAC_FOR_FILE=disabled
0-TOMOYO_VERBOSE=disabled
1-COMMENT=-----Learning Mode-----
1-MAC_FOR_FILE=learning
1-TOMOYO_VERBOSE=disabled
2-COMMENT=-----Permissive Mode-----
2-MAC_FOF_FILE=permissive
2-TOMOYO_VERBOSE=enabled
3-COMMENT=-----Enforcing Mode-----
3-MAC_FOR_FILE=enforcing
3-TOMOYO_VERBOSE=enabled
</pre>

<p>profile.confの1行は以下のような構文になっています。</p>

<pre>
（プロファイル番号）-（設定項目）=（制御モード）
</pre>

<p>すなわち、行頭の番号がプロファイルを切り替えるためのプロファイル番号で、
'=' の左が設定項目、'=' の右が制御モードです。</p>

<p>設定項目COMMENTは、プロファイルを区別しやすくするためのコメントで、TOMOYO Linuxの機能には影響を与えません。</p>

<p>設定項目MAC_FOR_FILEは「ファイルに対するアクセス制御」を表しており、
制御モードがdisabledなら無効、learningなら学習、permissiveなら確認（アクセス拒否ログを出力するが実際には拒否しない）、enforcingなら強制、という設定が行えます。</p>

<p>設定項目TOMOYO_VERBOSEは「アクセス拒否の情報をコンソールに出力するかどうか」を表しており、
制御モードがdisabledなら出力なし、enabledなら出力ありになります。</p>

<p>上記設定では、プロファイル番号が0～3の4つのプロファイルを作成しており、それぞれの意味は以下のようになります。</p>

<table><tbody>
<tr><th>プロファイル0</th><td>ファイルに対するアクセス制御を無効にする、コンソールにアクセス拒否を出力しない</td></tr>
<tr><th>プロファイル1</th><td>ファイルに対するアクセス制御を学習モードにする、コンソールにアクセス拒否を出力しない</td></tr>
<tr><th>プロファイル2</th><td>ファイルに対するアクセス制御を確認モードにする、コンソールにアクセス拒否を出力する</td></tr>
<tr><th>プロファイル3</th><td>ファイルに対するアクセス制御を強制モードにする、コンソールにアクセス拒否を出力する</td></tr>
</tbody></table>

<p>プロファイル1の学習モードで行ったアクセスを元にポリシーを作成し、
プロファイル2の確認モードで仮運用して必要なポリシーが作成できているかを確かめ、
プロファイル3の強制モードで本運用としてアクセス制御を行う、
というのが基本的な運用の流れです。</p>

<h3>ポリシーの変更を許可するプログラムについて</h3>

<p>ポリシーを変更することができるプログラムは、/etc/ccs/manager.confというファイルで指定します。
以下のプログラムが指定されているはずです。</p>

<pre>
/usr/lib/ccs/loadpolicy
/usr/lib/ccs/editpolicy
/usr/lib/ccs/setlevel
/usr/lib/ccs/setprofile
/usr/lib/ccs/ld-watch
/usr/lib/ccs/ccs-queryd
</pre>

<h3>例外ポリシーについて</h3>

<p>/etc/ccs/exception_policy.conf には以下の 12 種類の例外が指定されています。</p>

<ol>
<li>パス名のパターン</li>
<li>パス名のグループ</li>
<li>アドレスのグループ</li>
<li>無条件に参照を許可するファイル</li>
<li>無条件に利用を許可する環境変数</li>
<li>内容を上書きすることを禁止するファイル</li>
<li>シンボリックリンク経由で実行できるプログラム</li>
<li>類似するプログラムの集約</li>
<li>ドメイン遷移を初期化させるプログラム</li>
<li>ドメイン遷移の初期化を抑制させるプログラム</li>
<li>ドメイン遷移を抑制させるプログラム</li>
<li>ドメイン遷移を再開させるプログラム</li>
</ol>

<h2><a name="l4">監査ログの取得準備</a></h2>

<p>TOMOYO Linuxのログは、アクセスが許可された要求のログと、アクセスが拒否された要求のログの2種類に分けることができます。
今回は、アクセス拒否ログのみを保存する設定を行います。</p>

<p>ログを保存するには、ccs-toolsのccs-auditdというデーモンプログラムを使用します。
アクセス拒否ログのみを保存する設定でccs-auditdをLinuxの起動時に実行するには、
以下のコマンドで/etc/rc.d/rc.localの末尾にccs-auditdの起動コマンドを追加します。</p>

<pre>
# <span class="user">echo "/usr/sbin/ccs-auditd /dev/null /var/log/tomoyo/reject_log.txt" &gt;&gt; /etc/rc.d/rc.local</span>
</pre>

<p>この設定では、/var/log/tomoyo/reject_log.txtにアクセス拒否ログが保存されます。
ログを保存するディレクトリをあらかじめ作っておきます。</p>

<pre>
# <span class="user">mkdir -p /var/log/tomoyo</span>
</pre>

<p>以上でTOMOYO Linuxを使うための基本的な設定は終わりです。</p>

<h2><a name="l5">運用</a></h2>

<h3><a name="l6">システムの再起動</a></h3>

<p>/sbin/ccs-init を実行してください。</p>

<pre>
# <span class="user">/sbin/ccs-init</span>
</pre>

<p>問題が無ければすぐに終了します。</p>

<p>Linux を再起動してください。</p>

<pre>
# <span class="user">reboot</span>
</pre>

<p>起動プロセスが終了するとログインプロンプトが表示されるので、rootでログインしてください。</p>

<p><img alt="rootでログイン" title="rootでログイン" width="720" height="400" src="login.png"></p>

<h3><a name="l7">ログイン後の操作の学習</a></h3>

<p>今回は、以下の操作をTOMOYO Linuxに学習させ、強制モードでは学習させた操作以外が拒否されることを確かめます。</p>

<ol>
<li>dateコマンドを実行する</li>
<li>headコマンドで/etc/passwdの先頭3行を表示する</li>
<li>tcshを起動する</li>
<li>tailコマンドで/etc/passwdの末尾3行を表示する</li>
<li>tcshを終了する</li>
</ol>

<p>まずは学習モードの設定を行います。</p>

<p>プロファイル1が学習モードです。
このプロファイルを以下のコマンドで/sbin/mingettyから起動されるプログラムに割り当てます。
</p>

<pre>
# <span class="user">/usr/sbin/ccs-setprofile -r 1 '&lt;kernel&gt; /sbin/mingetty'</span>
</pre>

<p>このコマンドは、</p>

<blockquote><p>/sbin/mingettyから起動されるプログラムすべてにプロファイル1を割り当てる</p></blockquote>

<p>という意味です。/sbin/mingettyはログインシェルを起動するプログラムで、
/sbin/mingetty以下にプロファイル1を割り当てることで、ログイン後の操作を学習する設定になります。
設定は即時に有効になるので、上記ccs-setprofileコマンドを実行したあとは既に学習モードになっています。</p>

<p>&lt;kernel&gt; /sbin/mingettyを引用符で囲まないと、シェルのリダイレクト機能が働いて
/sbin/mingettyの内容が書き換えられてしまいますのでくれぐれもご注意ください。</p>

<p>それでは、前述の4つの操作を学習させましょう。学習は通常のLinuxのように操作することで行えます。</p>

<p><img alt="操作の学習" title="操作の学習" width="720" height="400" src="ope_learning.png"></p>

<p>一見普通のLinuxと変わりなく操作できますが、
裏ではTOMOYO Linuxがアクセス許可を監視し、
操作ごとにポリシーとしてメモリ上に記憶しています。</p>

<h3><a name="l8">ポリシーの参照</a></h3>

<p>生成されたポリシーの参照・編集には、ccs-toolsのccs-editpolicyを用います。</p>

<pre>
# <span class="user">/usr/sbin/ccs-editpolicy</span>
</pre>

<p>ccs-editpolicyを起動すると、TOMOYO Linux起動後に、プロセスがどのように呼び出されたかが表示されます。
この「プロセスの呼び出し」を、TOMOYO Linuxでは「ドメイン遷移」とよびます。</p>

<p><img alt="ドメイン遷移" title="ドメイン遷移" width="720" height="400" src="editpolicy1.png"></p>

<p>ドメイン遷移の中から、mingettyを探してみてください。ドメイン遷移からmingettyを検索するには、
'f'キーを押して、下に出たプロンプトで"mingetty"と入力してEnterキーを押します。</p>

<p><img alt="mingetty以下のドメイン" title="mingetty以下のドメイン" width="720" height="400" src="editpolicy2.png"></p>

<p>行番号の右側に表示されている数字は、そのドメインに割り当てられているプロファイル番号です。 /sbin/mingetty 以下のドメインが 1 になっているのは、先ほど ccs-setprofile コマンドを用いて 1 を割り当てたためです。</p>

<p>/sbin/mingetty下の/bin/login以下では、ログインしてからのプロセス実行履歴が分かります。
その中からさらに、/bin/headコマンドを探してみてください。
headコマンドの行でEnterキーを押すと、以下の画面が表示されます。</p>

<p><img alt="headのポリシー" title="headのポリシー" width="720" height="400" src="editpolicy3.png"></p>

<p>これは先ほどの操作で学習したポリシーで、</p>

<blockquote>
<p>&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash /bin/headというドメイン（赤下線）は、</p>
<ul>
<li>/etc/passwdへの読み込みアクセスを許可する（青下線）</li>
</ul>
</blockquote>

<p>ということを意味しています。</p>

<p>TOMOYO Linuxでは、
「プログラムの絶対パスで表現したプロセスの実行履歴」をドメインとよびます。
すべてのプロセスはいずれか1つのドメインに所属しており、
アクセス制御はドメインごとにポリシーとして設定します。</p>

<p>ドメインにおけるファイルに対するアクセス許可は、
通常のLinuxにおけるファイルに対するパーミッションと
同様の3種類（読み込み・書き込み・実行）の他にも、
ファイルの新規作成・削除・名前変更なども設定できます。</p>

<p>ポリシーはメモリ上に置かれており、このままLinuxをシャットダウンしてしまうと、
学習したポリシーも失われてしまいます。ポリシーをハードディスクの/etc/ccs以下に
保存するには以下のようにします。</p>

<pre>
# <span class="user">/usr/sbin/ccs-savepolicy</span>
</pre>

<h3><a name="l9">強制アクセス制御</a></h3>

<p>それでは、先ほど自動学習したポリシーを使って、強制アクセス制御を体験してみましょう。</p>

<p>'q'キーでccs-editpolicyを終了してから、以下のコマンドを実行します。</p>

<pre>
# <span class="user">/usr/sbin/ccs-setprofile -r 3 '&lt;kernel&gt; /sbin/mingetty'</span>
</pre>

<p>この操作により、/sbin/mingetty以下のドメインに強制アクセス制御が適用されるようになります。</p>

<p>この状態で以下の操作を行ってみます。</p>

<ol>
<li>dateコマンドを実行</li>
<li>headコマンドで/etc/passwdの先頭3行を表示</li>
<li>tailコマンドで/etc/passwdの末尾3行を表示（エラー）</li>
<li>headコマンドで/etc/shadowの先頭3行を表示（エラー）</li>
<li>tcshを起動</li>
<li>dateコマンドを実行（エラー）</li>
</ol>

<p><img alt="強制アクセス制御の様子" title="強制アクセス制御の様子" width="720" height="400" src="ope_enforcing.png"></p>

<p>図中の赤下線のコマンドは先ほど学習モードで行った操作ですので、問題なく実行できます。
逆に青下線のコマンドはエラーになります。</p>

<p>エラーになった操作のログは、ccs-auditdによって/var/log/tomoyo/reject_log.txtに保存されています。</p>

<blockquote><p>
#2009-02-20 13:25:12# profile=3 mode=enforcing pid=2864 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0 state[0]=0 state[1]=0 state[2]=0 argc=3 envc=24 argv[]={ "tail" "-3" "/etc/passwd" } envp[]={ "MANPATH=/usr/lib/qt3/doc/man:" "HOSTNAME=tomoyo" "TERM=linux" "SHELL=/bin/bash" "HISTSIZE=1000" "QTDIR=/usr/lib/qt3" "HISTFILESIZE=1000" "USER=root" "LS_COLORS=no=00:fi=00:di=01;34:ln=01;36:pi=40;33:so=01;35:bd=40;33;01:cd=40;33;01:or=01;05;37;41:mi=01;05;37;41:ex=01;32:*.cmd=01;32:*.exe=01;32:*.com=01;32:*.btm=01;32:*.bat=01;32:*.sh=01;32:*.csh=01;32:*.tar=01;31:*.tgz=01;31:*.arj=01;31:*.taz=01;31:*.lzh=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.gz=01;31:*.bz2=01;31:*.bz=01;31:*.tz=01;31:*.rpm=01;31:*.cpio=01;31:*.jpg=01;35:*.gif=01;35:*.bmp=01;35:*.xbm=01;35:*.xpm=01;35:*.png=01;35:*.tif=01;35:" "ENV=/root/.bashrc" "USERNAME=" "MAIL=/var/spool/mail/root" "PATH=/usr/lib/qt3/bin:/usr/kerberos/sbin:/usr/kerberos/bin:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/usr/X11R6/bin:/sbin/:/usr/sbin/:/usr/sbin/" "PWD=/root" "LANG=C" "PS1=[\\u@\\h\040\\W]\\$\040" "HISTCONTROL=ignoredups" "SHLVL=1" "HOME=/root" "LESS=-X" "LOGNAME=root" "LESSOPEN=|/usr/bin/lesspipe.sh\040%s" "G_BROKEN_FILENAMES=1" "_=/bin/tail" }<br>
&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash<br>
allow_execute /bin/tail <br>
<br>
#2009-02-20 13:25:12# profile=3 mode=enforcing pid=2864 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0 state[0]=0 state[1]=0 state[2]=0 <br>
&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash<br>
allow_read /bin/tail <br>
<br>
#2009-02-20 13:25:22# profile=3 mode=enforcing pid=2867 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0 state[0]=0 state[1]=0 state[2]=0 <br>
&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash /bin/head<br>
allow_read /etc/shadow <br>
<br>
#2009-02-20 13:25:29# profile=3 mode=enforcing pid=2891 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0 state[0]=0 state[1]=0 state[2]=0 <br>
&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash /bin/tcsh<br>
allow_create /tmp/langrc.csh.2868 <br>
<br>
#2009-02-20 13:25:33# profile=3 mode=enforcing pid=2892 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0 state[0]=0 state[1]=0 state[2]=0 argc=1 envc=30 argv[]={ "date" } envp[]={ "MANPATH=/usr/lib/qt3/doc/man:/usr/lib/qt3/doc/man:" "HOSTNAME=tomoyo" "TERM=linux" "SHELL=/bin/bash" "HISTSIZE=1000" "QTDIR=/usr/lib/qt3" "HISTFILESIZE=1000" "USER=root" "LS_COLORS=no=00:fi=00:di=01;34:ln=01;36:pi=40;33:so=01;35:bd=40;33;01:cd=40;33;01:or=01;05;37;41:mi=01;05;37;41:ex=01;32:*.cmd=01;32:*.exe=01;32:*.com=01;32:*.btm=01;32:*.bat=01;32:*.sh=01;32:*.csh=01;32:*.tar=01;31:*.tgz=01;31:*.arj=01;31:*.taz=01;31:*.lzh=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.gz=01;31:*.bz2=01;31:*.bz=01;31:*.tz=01;31:*.rpm=01;31:*.cpio=01;31:*.jpg=01;35:*.gif=01;35:*.bmp=01;35:*.xbm=01;35:*.xpm=01;35:*.png=01;35:*.tif=01;35:" "ENV=/root/.bashrc" "USERNAME=" "MAIL=/var/spool/mail/root" "PATH=/usr/lib/qt3/bin:/usr/kerberos/sbin:/usr/kerberos/bin:/usr/lib/qt3/bin:/usr/kerberos/sbin:/usr/kerberos/bin:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/usr/X11R6/bin:/sbin/:/usr/sbin/:/usr/sbin/:/usr/X11R6/bin" "PWD=/root" "LANG=C" "PS1=[\\u@\\h\040\\W]\\$\040" "HISTCONTROL=ignoredups" "SHLVL=2" "HOME=/root" "LESS=-X" "LOGNAME=root" "LESSOPEN=|/usr/bin/lesspipe.sh\040%s" "G_BROKEN_FILENAMES=1" "_=/bin/tcsh" "HOSTTYPE=i586-linux" "VENDOR=intel" "OSTYPE=linux" "MACHTYPE=i586" "GROUP=root" "HOST=tomoyo" }<br>
&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash /bin/tcsh<br>
allow_execute /bin/date 
</p></blockquote>

<p>上記のログから、 Turbolinux 10 Serverの「/bin/tcsh」を起動すると「~/.tcshrc」から呼ばれた「~/.lang/langrc.csh」により「/tmp/langrc.csh.プロセスID」というテンポラリファイルが生成されていたことが判明しました。今回は確認モードによる確認を経ずに強制モードにしたので、エラーになってしまいました。実際のシステムで使う場合には、確認モードを利用してアクセス許可の不足が無いことを確認してから強制モードにするようにしてください。</p>

<p>このようにTOMOYO Linuxのファイルに対するアクセス制御を用いれば、</p>

<ul>
<li>どのような実行履歴を持つプロセスが</li>
<li>いつ</li>
<li>どんなファイルに</li>
<li>どんなアクセスを</li>
</ul>

<p>行ったかを監視することもできます。</p>

<hr>
<address><a href="http://tomoyo.sourceforge.jp/">TOMOYO Linux</a> is supported by <a href="http://www.nttdata.co.jp/">NTT DATA CORPORATION</a><br>
<a href="mailto:haradats@gmail.com">Send message to Webadmin</a><br>
Last modified: $Date$<br>
<!--#include virtual="/cgi-bin/counter.pl" -->
</address>

<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="sflogo.php" title="SourceForge.jp"></a></p>
</body>
</html>
