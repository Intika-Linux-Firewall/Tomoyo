<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja-JP">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>TOMOYO Linuxメンテナンス手順</title>
<link rel="stylesheet" href="https://tomoyo.osdn.jp/tomoyo.css" media="all" type="text/css">
</head>
<body>
<p>Info: Version <a href="../1.3.2/">1.3.2</a> is available.</p>
<h1>TOMOYO Linuxメンテナンス手順</h1>
<p style="text-align:right;">Last modified: $Date$</p>

<h1>パッケージのアップデートについて</h1>

<p>システムの振る舞いをポリシーにより制限しているため、パッケージのアップデートに伴いポリシーの更新が必要になる場合があります。</p>

<p>以下のいずれかの場合に、ポリシーの更新が必要になります。</p>

<ul>
<li>ファイルのパス名が変化した場合
<li>ファイルの依存関係が変化した場合
<li>必要なアクセス許可が増えた場合
</ul>

<p>学習モードを使ってポリシーを最初から再取得するのが理想です。しかし、現実には、一度強制モードでの運用を開始したシステムを強制モード以外に変更することは困難です。ドメイン単位で強制モードにするかどうかを指定できますが、強制モードではないドメインに属しているアプリケーションの制御を奪われたら意味がありません。例えば、 http サーバのアクセス許可を再取得するために http サーバだけを学習モードにするだけでも、システム全体が無防備になってしまうわけです。そのため、 TOMOYO Linux では、強制モードのまま、パッケージのアップデートとポリシーの修正を行います。</p>

<p>TOMOYO Linux には、強制モードのままポリシーの修正を行うためのツールが付属しています。これらのツールを使うことで、軽微な変更ならば、ポリシーを最初から再取得することなくシステムの運用を継続できます。ただし、これらのツールは、全てのケースに対応できるとは限らず、最適なポリシーであることを保証するものではありません。</p>

<h1>手順</h1>

<p>ウィンドウを３つ開きます。以後、これらのウィンドウをそれぞれ Window-1 Window-2 Window-3 と表記します。</p>

<p>まず、 Window-1 に切り替えます。そして、対話的に許可したいプロファイルの ALLOW_ENFORCE_GRACE を 1 に変更します。例えば、プロファイル番号 3 について設定したい場合は以下のようになります。</p>

<table border="1">
<tr><td>
setlevel 3-ALLOW_ENFORCE_GRACE=1
</td></tr>
</table>

<p>プロファイルの内容を setlevel コマンドで変更するのではなく、 ALLOW_ENFORCE_GRACE の設定だけが異なる強制モード用のプロファイルを setprofile コマンドでドメインに割り当てても構いません。</p>

<p>次に、以下のコマンドを起動してください。</p>

<table border="1">
<tr><td>
ccs-queryd
</td></tr>
</table>

<p>ccs-queryd は、ポリシー違反の発生を検知して、アクセス要求の内容を表示します。管理者は、そのアクセス要求の妥当性を判断して、アクセスを許可するか否か、ドメイン用ポリシーに追加するか否かを指定することができます。</p>

<p>無条件にアクセス要求を許可しないようにしてください。ポリシー違反の原因がパッケージのアップデートによるものとは限らず、侵入者の攻撃によるものである可能性があるからです。もし、侵入者の攻撃によって発生したアクセス要求に対してアクセスを許可してしまった場合、侵入されてしまいます。</p>

<p>ALLOW_ENFORCE_GRACE が 0 に設定されているまたは ccs-queryd が動作していない場合、ポリシー違反が発生するとそのアクセス要求は直ちに拒否されます。 ALLOW_ENFORCE_GRACE が 1 に設定されていてさらに ccs-queryd が動作している場合、ポリシー違反が発生しても管理者が応答するまでそのアクセス要求は保留状態となります。そのため、 ccs-queryd を動作させたままログアウトしないでください。</p>

<p>次に、 Window-2 で以下のコマンドを起動してください。</p>

<table border="1">
<tr><td>
ld-watch
</td></tr>
</table>

<p>ld-watch は、 /etc/ld.so.cache に登録されている共有ライブラリファイルの情報が変更された場合に、共有ライブラリを自動的に allow_read ディレクティブを使用して例外ポリシーに追加します。これにより、不特定多数のプログラムからアクセスされるライブラリファイルのパス名が変化した場合に、ライブラリファイルを読み込めないことが原因でプログラムが動作しなくなる状況を回避することができます。</p>

<p>次に、 Window-3 に切り替えて、パッケージのアップデートを行うためのコマンドを実行します。</p>

<p>yum を使用している環境ならば yum update を、 apt を使用している環境ならば apt-get update および apt-get upgrade を実行します。</p>

<p>パッケージをアップデート中に、デーモンの再起動などでポリシー違反が発生しますので、 Window-1 に注目してください。</p>

<p>パッケージのアップデートが完了したら、１０秒ほど待ってから、 Window-2 で動作中の ld-watch を Ctrl-C で終了させてください。</p>

<p>次に、手作業でポリシーを保存してください。</p>

<table border="1">
<tr><td>
savepolicy
</td></tr>
</table>

<p>以下のコマンドを実行して、存在しないパス名の一覧を取得します。</p>

<table border="1">
<tr><td>
findtemp &lt; /etc/ccs/exception_policy.txt
</td></tr>
</table>

<p>テキストエディタで /etc/ccs/exception_policy.txt を開き、存在しない共有ライブラリファイルに対する allow_read 等の無意味なアクセス許可を削除してください。そして、以下のコマンドを実行して例外ポリシーを再読み込みしてください。</p>

<table border="1">
<tr><td>
loadpolicy ef
</td></tr>
</table>

<p>以下のコマンドを実行して、存在しないパス名の一覧を取得します。</p>

<table border="1">
<tr><td>
findtemp &lt; /etc/ccs/domain_policy.txt
</td></tr>
</table>

<p>もし、大量のパス名が表示された場合は注意が必要です。パッケージのアップデートにより、ディレクトリ名ごとパス名が変化してしまった可能性があります。</p>

<p>例えば、 Fedora Core 4 に付属の logwatch は、アップデートによりパス名が変化します。
Fedora Core 4 をインストールした直後の logwatch は /etc/log.d/ ディレクトリに設定ファイルなどを保持しています。しかし、アップデートにより /etc/logwatch/ ディレクトリに設定ファイルなどを保持するようになり、 /etc/log.d/ ディレクトリは削除されてしまいます。</p>

<p>規則性が明確な場合は、テキストエディタで /etc/ccs/domain_policy.txt を編集してください。そして、以下のコマンドを実行してドメイン用ポリシーを再読み込みしてください。</p>

<table border="1">
<tr><td>
loadpolicy df
</td></tr>
</table>

<p>次に、強制アクセス制御の対象となっているプログラムの動作を確認するために、一通りの操作を試してください。もし、アクセス許可の不足が検出された場合は Window-1 に表示されますので、 Window-1 の監視を忘れないようにしてください。</p>

<p>動作確認が完了したら、再度ポリシーを保存してください。</p>

<table border="1">
<tr><td>
savepolicy
</td></tr>
</table>

<p>そして、 Window-1 で動作中の ccs-queryd を Ctrl-C で終了させてください。</p>

<p>最後に、プロファイルの ALLOW_ENFORCE_GRACE を 0 に戻します。例えば、プロファイル番号 3 について設定した場合は以下のようになります。</p>

<table border="1">
<tr><td>
setlevel 3-ALLOW_ENFORCE_GRACE=0
</td></tr>
</table>

<p>以上でパッケージの更新作業は完了です。ウィンドウを３つとも閉じてください。</p>
<p><a href="https://osdn.jp/"><img src="https://osdn.jp/sflogo.php?group_id=1973" width="96" height="31" alt="sflogo.php" title="SourceForge.jp"></a></p>
</body>
</html>
