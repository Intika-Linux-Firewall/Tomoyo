<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="ja-JP">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=shift_jis">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>TOMOYO Linuxによるアクセス解析手順</title>
<link rel="stylesheet" href="tomoyo.css" media="all" type="text/css">
</head>
<body>
<p>Info: Version <a href="../1.4.1/">1.4.1</a> is available.</p>
<h1>TOMOYO Linuxによるアクセス解析手順</h1>
<p style="text-align:right;">Last modified: $Date$</p>

<p>TOMOYO Linux のポリシーはパス名で表現されるため、ファイルのアクセスを追跡するためにも利用できます。<br>
特定のプログラムがどのようなファイルにアクセスしているかを知りたい場合や、特定のディレクトリにファイルを作成しているプログラムを知りたい場合に利用できます。</p>

<h1>準備</h1>

<h2>TOMOYO Linux カーネルのインストール</h2>

<p>カーネルをコンパイルする方法については、<a href="compile.html">TOMOYO Linuxカーネルの作成手順</a>を参照してください。</p>

<p>SELinux をサポートするディストリビューションでは、 SELinux が無効になっていないとインストール時にエラーが発生する場合があります。インストール時に以下のようなエラーメッセージが表示される場合は、 SELinux を無効にしてからインストールしてください。 /etc/selinux/config の SELINUX= の行を SELINUX=disabled に書き換えてからシステムを再起動するか、あるいは、カーネル起動時のコマンドラインに selinux=0 というオプションを渡すことで SELinux を無効にできます。</p>

<table border="1">
<tr><td>
[root@localhost ~]# rpm -ihv kernel-2.6.9-55.EL_tomoyo_1.4.i586.rpm<br>
Preparing...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;########################################### [100%]<br>
Error: %pre(kernel-2.6.9-55.EL_tomoyo_1.4.i586) scriptlet failed, exit status 255<br>
Error:&nbsp;&nbsp;&nbsp;install: %pre scriptlet failed (2), skipping kernel-2.6.9-55.EL_tomoyo_1.4
</td></tr>
</table>

<p>なお、 TOMOYO Linux 自身は SELinux と同時に使用することができます。以下の操作では SELinux を有効にした状態でも構いません。</p>

<p> rpm の場合、インストールに成功すると /boot/grub/grub.conf に以下のような記述が追加されているはずです。</p>

<table border="1">
<tr><td>
title CentOS (2.6.9-55.EL_tomoyo_1.4)<br>
&nbsp;&nbsp;&nbsp;&nbsp;root (hd0,0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;kernel /vmlinuz-2.6.9-55.EL_tomoyo_1.4 ro root=/dev/VolGroup00/LogVol00<br>
&nbsp;&nbsp;&nbsp;&nbsp;initrd /initrd-2.6.9-55.EL_tomoyo_1.4.img
</td></tr>
</table>

<p>ここで、 kernel の行の末尾に init=/.init を追加します。</p>

<table border="1">
<tr><td>
title CentOS (2.6.9-55.EL_tomoyo_1.4)<br>
&nbsp;&nbsp;&nbsp;&nbsp;root (hd0,0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;kernel /vmlinuz-2.6.9-55.EL_tomoyo_1.4 ro root=/dev/VolGroup00/LogVol00 init=/.init<br>
&nbsp;&nbsp;&nbsp;&nbsp;initrd /initrd-2.6.9-55.EL_tomoyo_1.4.img
</td></tr>
</table>

<p> deb の場合、インストールに成功すると /boot/grub/menu.lst に以下のような記述が追加されているはずです。</p>

<table border="1">
<tr><td>
title Debian GNU/Linux, kernel 2.6.8-16sarge6-ccs<br>
root (hd0,0)<br>
kernel /boot/vmlinuz-2.6.8-16sarge6-ccs root=/dev/sda1 ro<br>
initrd /boot/initrd.img-2.6.8-16sarge6-ccs<br>
savedefault<br>
boot
</td></tr>
</table>

<p>ここで、 kernel の行の末尾に init=/.init を追加します。</p>

<table border="1">
<tr><td>
title Debian GNU/Linux, kernel 2.6.8-16sarge6-ccs<br>
root (hd0,0)<br>
kernel /boot/vmlinuz-2.6.8-16sarge6-ccs root=/dev/sda1 ro init=/.init<br>
initrd /boot/initrd.img-2.6.8-16sarge6-ccs<br>
savedefault<br>
boot
</td></tr>
</table>

<p>/.init は TOMOYO Linux のポリシーをカーネルに読み込むためのスクリプトで、 /sbin/init の開始前に実行されます。<br>
/.init は次の手順でインストールするツールの中に含まれています。</p>

<h2>TOMOYO Linux ツールのインストール</h2>

<p>ツールをコンパイルするには、以下のコマンドを実行してください。</p>

<table border="1">
<tr><td>
cd /root/<br>
# TOMOYO Linux ツールのソースをダウンロードする。<br>
wget http://osdn.dl.sourceforge.jp/tomoyo/24615/ccs-tools-1.4-20070401.tar.gz<br>
# 展開する。<br>
tar -zxf ccs-tools-1.4-20070401.tar.gz<br>
# コンパイルする。<br>
make -sC ccstools/<br>
# ポリシーローダーを / へ移動する。<br>
mv ccstools/.init /
</td></tr>
</table>

<h2>ポリシーの作成</h2>

<p>/etc/ccs/manager.txt を作成し、以下の内容を指定します。</p>

<table border="1">
<tr><td>
/root/ccstools/editpolicy
</td></tr>
</table>

<p>/etc/ccs/status.txt を作成し、以下の内容を指定します。</p>

<table border="1">
<tr><td>
MAC_FOR_FILE=1<BR>
MAX_ACCEPT_ENTRY=1048576<BR>
MAX_GRANT_LOG=0<BR>
MAX_REJECT_LOG=0<BR>
TOMOYO_VERBOSE=0<BR>
</td></tr>
</table>

<p>以下のコマンドを実行した結果を /etc/ccs/exception_policy.txt として保存してください。</p>

<table border="1">
<tr><td>
/root/ccstools/make_exception.sh | grep ^file_pattern | sort | uniq
</td></tr>
</table>

<h1>解析</h1>

<p>TOMOYO Linuxカーネルで起動します。

<p>/.init の実行に成功すると、以下のようなメッセージが表示されますので、そのまま Enter を押してください。</p>

<table border="1">
<tr><td>
Press 'Enter' or wait for 10 seconds to use default status.<br>
You may input 'disabled' and press 'Enter' to disable MAC in case of emergency.<br>
&gt;
</td></tr>
</table>

<p>プロファイルの読み込みが成功すると、 /sbin/init が開始されてシステムが起動します。<br>
失敗した場合は、以下のようにメッセージが表示されて停止します。</p>

<table border="1">
<tr><td>
No profiles loaded. Run policy loader using 'init=' option.
</td></tr>
</table>

<p>失敗した場合は以下の点を確認してください。</p>

<ul>
<li> /boot/grub/grub.conf （または /boot/grub/menu.lst ）の TOMOYO カーネルに init=/.init が指定されているか？
<li> /.init に実行許可が与えられているか？
</ul>

<p>解析したいアプリケーションを動作させます。</p>

<p>/root/ccstools/editpolicy を実行すると、現在に至るまでに実行されたプログラムの一覧を表示できます。プログラムを選択して Enter を押すと、そのプログラムがアクセスしたファイルの一覧が表示されます。ポリシーエディタの使い方については、<a href="tool-editpolicy.html">ポリシーエディタの使い方</a>を参照してください。</p>

<p>/root/ccstools/savepolicy を実行すると、現在に至るまでにアクセスされたファイルの一覧を /etc/ccs/domain_policy.txt に保存することができます。</p>

</body>
</html>
