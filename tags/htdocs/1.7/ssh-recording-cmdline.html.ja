<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="ja-JP">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>シェルセッションのコマンドラインを記録する</title>
<link rel="stylesheet" href="http://tomoyo.sourceforge.jp/tomoyo.css" media="all" type="text/css">
</head>
<body>
<p style="text-align:right;"><a href="ssh-recording-cmdline.html.en">English Page</a></p>
<p style="text-align:right;">Last modified: $Date$</p>
<h1>シェルセッションのコマンドラインを記録する</h1>

<h2>概要</h2>

<p>このページでは、 TOMOYO Linux の execute_handler 機能を用いて、ＳＳＨのログインセッションで行われた操作内容を記録する手順について紹介します。</p>

<hr>

<h2>ステップ１：ソースコードのコンパイル</h2>

<p>以下のソースコードをコンパイルします。</p>

<table border="1">
<tr><td><pre>
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;syslog.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/file.h&gt;
#include &lt;fcntl.h&gt;

static void fprintf_encoded(FILE *fp, const char *string)
{
	while (1) {
		const unsigned char c = *(const unsigned char *) string++;
		if (!c)
			break;
		else if (c == '\\')
			fprintf(fp, "\\\\");
		else if (c &gt; 32 &amp;&amp; c < 127)
			fputc(c, fp);
		else
			fprintf(fp, "\\%03o", c);
	}
}

int main(int raw_argc, char *raw_argv[])
{
	int i;
	int argc;
	int envc;
	char *filename;
	char **argv;
	char **envp;
	{ /* Check that I'm an execute handler process.  */
		int fd = open("/proc/ccs/.execute_handler", 0);
		close(fd);
		if (fd == EOF) {
			fprintf(stderr, "FATAL: I'm not execute_handler.\n");
			return 1;
		}
	}
	if (raw_argc &lt; 7)
		return 1;
	filename = raw_argv[4];
	argc = atoi(raw_argv[5]);
	envc = atoi(raw_argv[6]);
	if (raw_argc != argc + envc + 7)
		return 1;
	for (i = 5; i &lt; argc + 5; i++)
		raw_argv[i] = raw_argv[i + 2];
	raw_argv[argc + 5] = NULL;
	for (i = argc + 6; i &lt; argc + envc + 6; i++)
		raw_argv[i] = raw_argv[i + 1];
	raw_argv[argc + envc + 6] = NULL;
	argv = raw_argv + 5;
	envp = raw_argv + argc + 6;

	{
		FILE *fp = fopen("/var/log/commandline.log", "a");
		if (!fp || flock(fileno(fp), LOCK_EX) == EOF)
			return 1;
		fprintf(fp, "Domain = %s\n", raw_argv[1]);
		fprintf(fp, "Caller Program = %s\n", raw_argv[2]);
		fprintf(fp, "Process Status = %s\n", raw_argv[3]);
		fprintf(fp, "Requested Program = %s\n", filename);
		fprintf(fp, "argc=%d\n", argc);
		fprintf(fp, "envc=%d\n", envc);
		for (i = 0; i &lt; argc; i++) {
			fprintf(fp, "argv[%d] = \"", i);
			fprintf_encoded(fp, argv[i]);
			fprintf(fp, "\"\n");
		}
		for (i = 0; i &lt; envc; i++) {
			fprintf(fp, "envp[%d] = \"", i);
			fprintf_encoded(fp, envp[i]);
			fprintf(fp, "\"\n");
		}
		fclose(fp);
	}

	execve(filename, argv, envp);
	fprintf(stderr, "ERROR: Can't execute %s .\n", filename);
	return 1;
}
</pre></td></tr>
</table>

<p>このページでは、コンパイルされたプログラムの名前を /bin/record_cmdline とします。また、ＳＳＨサーバのパス名を /usr/sbin/sshd とします。また、ログインシェルのパス名を /bin/bash とします。</p>

<h2>ステップ２： TOMOYO Linux のインストールと初期化</h2>

<p>TOMOYO Linux をインストールして初期設定を行ってください。</p>

<p>初期設定が終わったら、 TOMOYO Linux カーネルで再起動する前に以下の操作を行ってください。</p>

<p>/usr/sbin/sshd が実行された場合にはドメイン遷移が初期化されるようにするために、 /etc/ccs/exception_policy.conf に以下の内容を追加します。</p>

<table border="1">
<tr><td>
initialize_domain /usr/sbin/sshd
</td></tr>
</table>

<p>ＳＳＨサーバから起動されたログインシェル以降はドメイン遷移を行わないようにするために、 /etc/ccs/exception_policy.conf に以下の内容を追加します。</p>

<table border="1">
<tr><td>
keep_domain &lt;kernel&gt; /usr/sbin/sshd /bin/bash
</td></tr>
</table>

<p>ＳＳＨサーバから起動されたログインシェルからのプログラムの実行要求が /bin/record_cmdline に渡されるようにするために、 /etc/ccs/domain_policy.conf に以下の内容を追加します。</p>

<table border="1">
<tr><td>
&lt;kernel&gt; /usr/sbin/sshd /bin/bash<br>
execute_handler /bin/record_cmdline
</td></tr>
</table>

<h2>ステップ３：運用</h2>

<p>以上で設定は完了です。 TOMOYO Linux カーネルで再起動してください。</p>

<p>SSH ログインして、適当に操作を行ってください。コンソールからログインして、以下のコマンドを実行すると、コマンドラインが記録されていることを確認することができます。</p>

<table border="1">
<tr><td>
tail -f /var/log/commandline.log
</td></tr>
</table>

<h2>説明</h2>

<p>TOMOYO Linux の execute_handler 機能が /usr/sbin/sshd から起動された /bin/bash からのプログラムの実行要求を横取りして、 /bin/record_cmdline に渡しています。 /bin/record_cmdline がプログラムの実行要求に渡されたパラメータを記録してから、要求されたプログラムを実行します。</p>

<h2>応用</h2>

<p>プログラム実行時のパラメータが渡されるので、その内容に基づいてプログラムの実行を許可するかどうか判断できます。</p>

<hr>

<p><a href="index.html.ja">目次へ戻る</a></p>
<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>
</body>
</html>
