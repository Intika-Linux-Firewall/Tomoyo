<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja-JP">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="content-style-type" content="text/css">
<link rel="stylesheet" href="../media/tomoyolinux.css" media="all" type="text/css">
<title>TOMOYO Linux 2.3.x : 導入ガイド : Chapter 6</title>
</head>

<body>

<div id="titlebar">
<a href="../index.html.ja"><img src="../media/tomoyotitle.png" alt="tomoyotitle.png" width="320" height="40" border="0" align="left" title="TOMOYO Linux"></a>
</div>

<div id="navbar" class="tomoyo-documentation">
<ul id="navbarlist">
<li id="tomoyo-home"><a href="../index.html.ja" title="TOMOYO Linux ホーム">ホーム</a></li>
<li id="tomoyo-about"><a href="../about.html.ja" title="TOMOYO Linux の詳細">詳細</a></li>
<li id="tomoyo-download"><a href="../download.html.ja" title="TOMOYO Linux を入手">ダウンロード</a></li>
<li id="tomoyo-changelogs"><a href="../changelogs.html.ja" title="TOMOYO Linux 変更履歴">変更履歴</a></li>
<li id="tomoyo-documentation"><a href="../documentation.html.ja" title="公式ドキュメント">ドキュメント</a></li>
<li id="tomoyo-support"><a href="../support.html.ja" title="サポート情報">サポート</a></li>
<li id="tomoyo-links"><a href="../links.html.ja" title="Links">リンク</a></li>
</ul>
<ul id="switch-language">
<li id="tomoyo-switch-language"><a href="chapter-6.html.en" title="Go to English page">English page</a></li>
</ul>
</div>

<div id="content">

<div id="documentation">

<div class="navheader">
<p><a href="chapter-5.html.ja">&lt;前&gt;</a> <a href="index.html.ja">&lt;目次&gt;</a> <a href="chapter-7.html.ja">&lt;次&gt;</a></p>
</div>

<h2>Chapter 6: ポリシーはどのように作成しますか？</h2>

<h3><a name="6.1">6.1. テンポラリファイルをパターン化する</a></h3>

<p>特定のドメインでは、多数の資源に対して多数のアクセス許可を必要とすることがあります。「強制モード」では明示的に許可された資源へのアクセスだけが認められるため、必要な資源を全て網羅しておくことが重要です。網羅するために、アクセス許可をパターン化することができます。パターン化されたアクセス許可を使うと、多数のドメインポリシーのエントリを１個に集約することができます。</p>

<p>パターン化は、使い捨てのパス名が利用されるテンポラリファイルへの対処を行うのに有効です。以下に紹介する手順で対処することもできますし、ポリシーエディタを用いて対話的に対処することもできます。対話的に対処する手順の詳細については<a href="tool-editpolicy.html.ja#redundant">冗長なエントリを削除する</a>を参照してください。</p>

<p><code>tomoyo-findtemp</code> コマンドを利用して、テンポラリファイルの可能性があるパス名を抽出します：</p>

<pre class="command">
# /usr/sbin/tomoyo-findtemp &lt; /sys/kernel/security/tomoyo/domain_policy
</pre>
<pre class="output">
/etc/mtab.tmp
/etc/mtab~
/etc/mtab~2302
/etc/mtab~2328
/etc/mtab~2329
/etc/mtab~2330
/etc/mtab~2331
/etc/mtab~2332
/etc/mtab~2339
/etc/mtab~2383
/halt
/selinux/disable
/selinux/enforce
/selinux/policyvers
/tmp/sh-thd-1163110572
/tmp/sh-thd-1163113704
/var/cache/samba/browse.dat.
/var/lib/nfs/etab.tmp
/var/lib/nfs/xtab.tmp
/var/lock/mrtg/mrtg_l
</pre>

<p>この例では、 /etc/mtab~数値 および /tmp/sh-thd-数値 がテンポラリファイルであると考えられます。そのため、これらのパス名をパターン化します。</p>

<p>最初に、どのようなパターンを利用するかを決めます。１０進数の数値が使用されていると考えられます。そのため、１桁以上の１０進数に一致する <strong>\$</strong> が妥当だと考えられます。詳細については<a href="policy-specification/expression-rules.html.ja#wildcard">パターンの表記規則</a>を参照してください。</p>

<p><code>tomoyo-patternize</code> コマンドを利用して、ドメインポリシーの中の「 /etc/mtab~数値 」および「 /tmp/sh-thd-数値」を「 /etc/mtab~\$ 」および「 /tmp/sh-thd-\$ 」に置換します：</p>

<pre class="command">
# /usr/sbin/tomoyo-savepolicy -d | /usr/sbin/tomoyo-patternize '/etc/mtab~\$' '/tmp/sh-thd-\$' | /usr/sbin/tomoyo-loadpolicy -d
</pre>

<p>必要であれば、学習する際に自動的にパターン化されるようにするために、例外ポリシーにパターンを登録しておくことができます：</p>

<pre class="command">
# echo 'file_pattern /etc/mtab~\$' | /usr/sbin/tomoyo-loadpolicy -e
# echo 'file_pattern /tmp/sh-thd-\$' | /usr/sbin/tomoyo-loadpolicy -e
</pre>

<h3><a name="6.2">6.2. ファイルのアクセス許可をパターン化する</a></h3>

<p>学習モードでは必ずしもアクセスされないファイルに対するアクセス許可を追加します。例えば、 WWW サーバがアクセスするコンテンツを扱うために、以下のようにパターン化を行うことができます：</p>

<div class="simple-table">
<table>
<tr>
<th>
<p>修正前</p>
</th>
<th>
<p>修正後</p>
</th>
</tr>
<tr>
<td>
<p>&lt;kernel&gt; /usr/sbin/httpd</p>
<br>
<p>allow_read /var/www/html/index.html</p>
<p>allow_read /var/www/html/alice/index.html</p>
<p>allow_read /var/www/html/alice/page1.html</p>
<p>allow_read /var/www/html/alice/page2.html</p>
<p>allow_read /var/www/html/alice/image1.jpg</p>
<p>allow_read /var/www/html/alice/image2.jpg</p>
<p>allow_read /var/www/html/alice/archive/page1.html</p>
<p>allow_read /var/www/html/alice/archive/image1.jpg</p>
<p>allow_read /var/www/html/alice/archive/page2.html</p>
<p>allow_read /var/www/html/alice/archive/image2.jpg</p>
<p>allow_read /var/www/html/bob/index.html</p>
<p>allow_read /var/www/html/bob/page1.html</p>
<p>allow_read /var/www/html/bob/page2.html</p>
<p>allow_read /var/www/html/bob/image1.jpg</p>
<p>allow_read /var/www/html/bob/image2.jpg</p>
<p>allow_read /var/www/html/bob/archive/page1.html</p>
<p>allow_read /var/www/html/bob/archive/image1.jpg</p>
<p>allow_read /var/www/html/bob/archive/page2.html</p>
<p>allow_read /var/www/html/bob/archive/image2.jpg</p>
</td>
<td>
<p>&lt;kernel&gt; /usr/sbin/httpd</p>
<br>
<p>allow_read /var/www/html/\*.html</p>
<p>allow_read /var/www/html/\{\*\}/\*.html</p>
<p>allow_read /var/www/html/\{\*\}/\*.jpg</p>
</td>
</tr>
</table>
</div>

<p>例外ポリシーで以下のようなグループを定義しておくことにより：</p>

<pre>
path_group WEB-CONTENTS /var/www/html/\*.html
path_group WEB-CONTENTS /var/www/html/\{\*\}/\*.html
path_group WEB-CONTENTS /var/www/html/\{\*\}/\*.jpg
</pre>

<p>ドメインポリシーでの記述を以下のように単純化することができます：</p>

<pre>
&lt;kernel&gt; /usr/sbin/httpd

allow_read @WEB-CONTENTS
</pre>

<h3><a name="6.3">6.3. 数値パラメータをパターン化する</a></h3>

<p>ファイルのＤＡＣモードなどの数値で表現されるパラメータについてもパターン化を行うことができます。</p>

<p>以下のドメインポリシーの例では &lt;kernel&gt; /sbin/init ドメインに対して /dev/console への任意の ioctl 要求を許可するようにパターン化しています：</p>

<div class="simple-table">
<table>
<tr>
<th>
<p>修正前</p>
</th>
<th>
<p>修正後</p>
</th>
</tr>
<tr>
<td>
<p>&lt;kernel&gt; /sbin/init</p>
<br>
<p>allow_ioctl /dev/console 0x5401</p>
<p>allow_ioctl /dev/console 0x5402</p>
<p>allow_ioctl /dev/console 0x540B</p>
<p>allow_ioctl /dev/console 0x540E</p>
<p>allow_ioctl /dev/console 0x540F</p>
</td>
<td>
<p>&lt;kernel&gt; /sbin/init</p>
<br>
<p>allow_ioctl /dev/console 0-0xFFFFFFFF</p>
</td>
</tr>
</table>
</div>

<p>例外ポリシーで以下のようなグループを定義しておくことにより：</p>

<pre>
number_group ANY_NUMBER 0-0xFFFFFFFF
</pre>

<p>ドメインポリシーでの記述を以下のように単純化することができます：</p>

<pre>
&lt;kernel&gt; /sbin/init

allow_ioctl /dev/console @ANY_NUMBER
</pre>

<h3><a name="6.4">6.4. 収集されたアクセス許可を確認する</a></h3>

<p>Apache に許可したい操作を一通り行ったと判断したら、ポリシーエディタを実行してプロファイル番号を 2 に変更します。</p>

<p>Apache は（例えば <code>/bin/sh</code> <code>/usr/bin/perl</code> <code>/usr/lib/sendmail</code> のような）外部のプログラムを実行したことにより、 Apache に子ドメインや孫ドメインが作成されているかもしれません。 Apache 本体のドメインだけでなくその子孫ドメインのプロファイル番号も変更するのを忘れないようにしてください。</p>

<img src="media/editpolicy-httpd-profile2.png" alt="editpolicy-httpd-profile2.png" title="Apache executed external programs." width="675" height="375">

<p>q キーを押してポリシーエディタを終了してください。その後、 Apache に対して許可したい操作を再度行ってください：</p>

<img src="media/operation-permissive.png" alt="operation-permissive.png" title="Check that Apache has appropriate permissions." width="575" height="475">

<p>もしプロファイルで PREFERENCE::permissive={ verbose=yes } と設定されている場合（デフォルトでそうなっています）、ポリシーで許可されていない操作を行うと WARNING: というメッセージがコンソールに表示されます。</p>

<p><img src="media/permissive-warning.png" alt="permissive-warning.png" title="Warning messages are printed." width="720" height="400"></p>

</div><!-- documentation -->

</div><!-- content -->

<div id="navfooter">
<hr>
<table>
<tr>
<td class="docs-previous">
<a href="chapter-5.html.ja">前</a>
</td>
<td class="docs-index">
<a href="index.html.ja">目次</a>
</td>
<td class="docs-next">
<a href="chapter-7.html.ja">次</a>
</td>
</tr>
<tr>
<td class="docs-previous-description">
<p>Chapter 5: ドメインの管理はどのように行いますか？</p>
</td>
<td class="docs-home">
</td>
<td class="docs-next-description">
<p>Chapter 7: ポリシーの適用はどのように行いますか？</p>
</td>
</tr>
</table>
</div>

<div id="footer">
<p class="language">Go to <a href="chapter-6.html.en">English page</a>.</p>
<p class="timestamp">Last modified: $Date$</p>
<p class="trademark">Linux&reg; は世界各国における Linus Torvalds の登録商標です。 TOMOYO&reg; は<a href="http://www.nttdata.co.jp/">株式会社ＮＴＴデータ</a>の登録商標です。</p>
<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="sflogo.php" title="SourceForge.jp"></a></p>
</div>

</body>
</html>
