<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>TOMOYO Linux Install manual</title>
<link rel="stylesheet" href="tomoyo.css" media="all" type="text/css">
</head>
<body>
<p style="text-align:right;"><a href="initialize.html.ja">Japanese Page</a></p>
<p style="text-align:right;">Last modified: $Date$</p>
<h1>Phase 2: Initializing TOMOYO Linux.</h1>

<p>This page describes basic operations needed for using TOMOYO.</p>

<hr>

<h2>Step 1: Initializing Policy</h2>

<p>To initialize policy, run</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# /usr/lib/ccs/init_policy.sh --file-only-profile
</td></tr>
</table>

<p>if you want to use only MAC for files, or</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# /usr/lib/ccs/init_policy.sh
</td></tr>
</table>

<p>if you want to enable all MAC functionalities.</p>

<p>This will take several minutes.</p>

<p>TOMOYO's policy files will be saved in /etc/ccs/ directory.</p>

<hr>

<h2>Step 2: Learning how to use TOMOYO's policy editor</h2>

<p>Run TOMOYO's policy editor "ccs-editpolicy" with "/etc/ccs/" option, and you will see a picture shown below.</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# /usr/sbin/ccs-editpolicy /etc/ccs/
</td></tr>
</table>

<p><img src="editpolicy-domain-list1.png" width="720" height="400"></p>

<p>This picture describes the domain tree. As of now, only "&lt;kernel&gt;" domain is defined. But as the system runs, TOMOYO will create domains and add them to the tree. The example picture shown below has many domains.</p>

<p><img src="editpolicy-domain-list2.png" width="720" height="400"></p>

<p>The MAC in TOMOYO Linux is applied in the units of domains. Every process belongs to single domain, and basically the process will transit to different domain whenever it executes a program. The name of a domain is a concatenated string expression for the process execution history. For example, the name of domain which the kernel belongs to is "&lt;kernel&gt;", the name of domain which /sbin/init invoked by the kernel belongs to is "&lt;kernel&gt; /sbin/init", the name of domain which /etc/rc.d/rc invoked by the /sbin/init belongs to is "&lt;kernel&gt; /sbin/init /etc/rc.d/rc". The exceptions of this transition rule are described later.</p>

<p>Look at the number which are the second column of each line.</p>

<p><img src="editpolicy-domain-profile-number.png" width="720" height="400"></p>

<p>This number is called "profile number". A profile number is an integer value which takes between 0 and 255.</p>

<p>Press "w" key, and you will see some choices.</p>

<p><img src="editpolicy-window-list.png" width="720" height="400"></p>

<p>Press "p" key, and you will see the list of profiles.</p>

<p>If you gave "--file-only-profile" option when executing /usr/lib/ccs/init_policy.sh , you will see entries shown in below picture.</p>

<p><img src="editpolicy-profile-list-file-only.png" width="720" height="400"></p>

<p>If you didn't give "--file-only-profile" option when executing /usr/lib/ccs/init_policy.sh , you will see entries shown in below picture.</p>

<p><img src="editpolicy-profile-list.png" width="720" height="400"></p>

<p>You can scroll this window using arrow keys and/or Home/End/PageUp/PageDown keys.</p>

<p>TOMOYO Linux can perform several MACs besides MAC for files, but to reduce the load of policy managements, you can disable MACs you think unnecessary.</p>

<table border="1">
<tr><td>Name</td><td>Control</td><td>Default value</td><td>Learning mode supported</td></tr>
<tr>
<td>COMMENT</td>
<td>A line of text that describes the content of the profile.</td>
<td></td>
<td>-</td>
</tr>
<tr>
<td>MAC_FOR_FILE</td>
<td>Enable Mandatory Access Control(MAC) for files.</td>
<td>disabled</td>
<td>Yes</td>
</tr>
<tr>
<td>MAC_FOR_ARGV0</td>
<td>Enable MAC for argv[0] checks.</td>
<td>disabled</td>
<td>Yes</td>
</tr>
<tr>
<td>MAC_FOR_ENV</td>
<td>Enable MAC for environment variables' names.</td>
<td>disabled</td>
<td>Yes</td>
</tr>
<tr>
<td>MAC_FOR_CAPABILITY::</td>
<td>Enable MAC for capabilities. There are 31 types of capabilities and you can enable/disable selectively.</td>
<td>disabled</td>
<td>Yes</td>
</tr>
<tr>
<td>MAC_FOR_NETWORK</td>
<td>Enable MAC for network addresses and ports.</td>
<td>disabled</td>
<td>Yes</td>
</tr>
<tr>
<td>MAC_FOR_SIGNAL</td>
<td>Enable MAC for signal.</td>
<td>disabled</td>
<td>Yes</td>
</tr>
<tr>
<td>DENY_CONCEAL_MOUNT</td>
<td>Forbid mount requests that hides an existing mount.</td>
<td>disabled</td>
<td>No</td>
</tr>
<tr>
<td>RESTRICT_CHROOT</td>
<td>Enable restrictions for chroot directories.</td>
<td>disabled</td>
<td>Yes</td>
</tr>
<tr>
<td>RESTRICT_MOUNT</td>
<td>Enable restrictions for mount parameters.</td>
<td>disabled</td>
<td>Yes</td>
</tr>
<tr>
<td>RESTRICT_UNMOUNT</td>
<td>Forbid unmount requests for specified directories.</td>
<td>disabled</td>
<td>No</td>
</tr>
<tr>
<td>RESTRICT_PIVOT_ROOT</td>
<td>Enable restrictions for pivot_root directories.</td>
<td>disabled</td>
<td>Yes</td>
</tr>
<tr>
<td>RESTRICT_AUTOBIND</td>
<td>Forbid selecting specific local port number when automatic local port binding happens.</td>
<td>disabled</td>
<td>No</td>
</tr>
<tr>
<td>MAX_ACCEPT_ENTRY</td>
<td>Limits the max number of ACL entries that are automatically appended during learning mode.</td>
<td>2048</td>
<td>-</td>
</tr>
<tr>
<td>MAX_GRANT_LOG</td>
<td>Limits the max number of access requests that didn't violate policies.</td>
<td>1024</td>
<td>-</td>
</tr>
<tr>
<td>MAX_REJECT_LOG</td>
<td>Limits the max number of access requests that violated policies.</td>
<td>1024</td>
<td>-</td>
</tr>
<tr>
<td>TOMOYO_VERBOSE</td>
<td>Dump domain policy violation messages to syslog.</td>
<td>enabled</td>
<td>-</td>
</tr>
<tr>
<td>SLEEP_PERIOD</td>
<td>Specifies how long should the process that violated policy in enforcing mode sleep for, in 0.1 seconds.</td>
<td>0</td>
<td>-</td>
</tr>
</table>
<p>You can give the following values for RESTRICT_AUTOBIND</p>
<table border="1">
<tr>
<td>Value</td>
<td>Meaning</td>
</tr>
<tr>
<td>disabled</td>
<td>Off. Works as if regular kernel.</td>
</tr>
<tr>
<td>enabled</td>
<td>On</td>
</tr>
</table>
<p>You can give any integer greater or equals to 0 for MAX_ACCEPT_ENTRY, MAX_GRANT_LOG, MAX_REJECT_LOG and SLEEP_PERIOD.</p>
<p>You can give the following values for TOMOYO_VERBOSE</p>
<table border="1">
<tr>
<td>Value</td>
<td>Meaning</td>
</tr>
<tr>
<td>disabled</td>
<td>Don't dump domain policy violation messages.</td>
</tr>
<tr>
<td>enabled</td>
<td>Dump domain policy violation messages.</td>
</tr>
</table>
<p>You can give the following values for all but listed above.</p>
<table border="1">
<tr>
<td>Value</td>
<td>Meaning</td>
</tr>
<tr>
<td>disabled</td>
<td>Disabled. Works as if regular kernel.</td>
</tr>
<tr>
<td>learning</td>
<td>Learning mode. Not rejected if the request violates policy. Automatically appended to policy.</td>
</tr>
<tr>
<td>permissive</td>
<td>Permissive mode. Not rejected if the request violates policy. Not appended to policy automatically.</td>
</tr>
<tr>
<td>enforcing</td>
<td>Enforcing mode. Rejected if the request violates policy.</td>
</tr>
</table>

<p>Press "w" key, then press "e" key, and you will see the picture shown below.</p>

<p><img src="editpolicy-exception-list1.png" width="720" height="400"></p>

<p>This screen contains the following types of exceptions.</p>

<table border="1">
<tr><td>
(1) Pathname pattern
</td><td>
<p>Register pathnames with patterns using the "file_pattern" directive. When a file operation is performed and the requested pathname matches a patterned pathname registered with "file_pattern" directive, policy is generated using patterned pathnames.<br>
The following is the guideline.</p>

<ul>
<li>Files under /proc/PID/ directory.</li>
<li>Files under /sys/ directory. (Applicable to 2.6 kernels only)</li>
<li>Some files under /dev/ directory.</li>
<li>Policy files under /etc/ccs/ directory.</li>
<li>Manual pages.</li>
<li>Spool directories.</li>
<li>Temporary files used for sending and receiving mails.</li>
<li>Temporary files used by man command.</li>
<li>Temporary files used by mount command.</li>
</ul>

<p>TOMOYO Linux needs more patterned pathnames depending on the applications installed and their configurations. You can add missing patterned pathnames after running the system.</p>
</td></tr><tr><td>
(2) Pathname group
</td><td>
<p>Register pathname groups using the "path_group" directive. This is a macro to reduce the amount of domain policy by grouping multiple pathnames using group names. An example usage is shown later.</p>
</td></tr><tr><td>
(3) Address group
</td><td>
<p>Register IPv4 or IPv6 address groups using the "address_group" directive. This is a macro to reduce the amount of domain policy by grouping multiple addresses using group names. An example usage is shown later.<br>
</td></tr><tr><td>
(4) Unconditionally readable files
</td><td>
<p>Register files that are allowed to be read by all programs using the "allow_read" directive. Patterns are allowed. When a file open request for reading is issued and the requested pathname matches a pathname registered with "allow_read" directive, the open request for read access is granted even if the pathname is not explicitly permitted by the domain policy.<br>
The following is the guideline.</p>

<ul>
<li>Dynamically-linked library files that are registered with ldconfig.
<li>Some files under /proc/ directory.
<li>Some locale data under /usr/share/locale/ directory.
</ul>

<p>You may find more files depending on applications in your system or configurations. Add missing files after observing which files are used for read access.</p>

</td></tr><tr><td>
(5) Unconditionally usable environment variable names
</td><td>
<p>Register environment variable names that are allowed to be passed to all programs using the "allow_env" directive. Patterns are allowed. When execve() request is issued and the passed environment variable name matches matches environment variable names registered with "allow_env" directive, the environment variable name is granted without checking domain policy.<br>
The following is the guideline.</p>

<ul>
<li>Commonly used environment variable names such as PATH and HOME
</ul>

<p>You may find more environment variable names depending on applications in your system or configurations. Add missing environment variable names after observing which environment variable names are used.</p>

</td></tr><tr><td>
(6) Non-rewritable files
</td><td>
<p>Register files that you don't want to allow overwriting existing contents (like log files) using "deny_rewrite" directive. Patterns are allowed. Files registered with "deny_rewrite" directive are (as long as it is not explicitly given by "allow_rewrite" directive in domain policy) forbidden to "open for writing but not append mode" and "truncate".<br>
The following is the guideline.</p>

<ul>
<li>Files under /var/log/ directory.
</ul>

<p>You may find more files depending on applications in your system or configurations. Add missing files after observing which files are used for append-only access.</p>

</td></tr><tr><td>
(7) Programs invocable via symbolic links
</td><td>
<p>Basically, TOMOYO Linux checks execute permissions using the dereferenced pathname if the requested program is a symbolic link. But to handle programs that behave differently depending on the name of invocation, you may define domains using the name of symbolic links.<br>
To allow executing programs using the name of symbolic links, use alias directive followed by dereferenced pathname and reference pathname. No patterns are allowed.<br>
For example, /sbin/pidof is a symbolic link to /sbin/killall5 . In normal case, if /sbin/pidof is executed, the domain is defined as if /sbin/killall5 is executed. By specifying "alias /sbin/killall5 /sbin/pidof", you can run /sbin/pidof in the domain for /sbin/pidof .</p>
</td></tr><tr><td>
(8) Program aggregations
</td><td>
<p>To deal multiple programs as a single program, use aggregator directive followed by name of original program and aggregated program. Patterns are allowed for name of original program.<br>
For example, /usr/bin/tac and /bin/cat are similar. By specifying "aggregator /usr/bin/tac /bin/cat", you can run /usr/bin/tac in the domain for /bin/cat .</p>
</td></tr><tr><td>
(9) Programs that cause domain transition initialization
</td><td>
<p>Register programs that initializes the domain transition history using the "initialize_domain" directive. No patterns allowed. When a program that is registered with "initialize_domain" directive is executed, the program runs just under the  &lt;kernel&gt; domain.<br>
The following is the guideline.</p>

<ul>
<li>Scripts that start or terminate daemon programs located under /etc/init.d/ directory.</li>
<li>Daemon programs that you want to make domain names shorter (for example, httpd and sshd).</li>
</ul>

<p>You may find more programs depending on applications in your system or configurations. Add missing programs after observing which programs should be initialize their domain transition history. But be careful with the side effect of other domains. For example, when the domain policy already includes</p>

<table border="1">
<tr><td>
&lt;kernel&gt; ... /bin/bash<br>
use_profile 3<br>
allow_execute /bin/tcsh<br>
<br>
&lt;kernel&gt; ... /bin/bash /bin/tcsh<br>
use_profile 3<br>
allow_execute /bin/cat<br>
<br>
&lt;kernel&gt; ... /bin/bash /bin/tcsh /bin/cat<br>
use_profile 3<br>
allow_read /etc/fstab
</td></tr>
</table>

<p>and you add /bin/tcsh as initialize_domain, "&lt;kernel&gt; ... /bin/bash /bin/tcsh" will become  unreachable domain because /bin/tcsh runs in "&lt;kernel&gt; /bin/tcsh" domain. In that case, you will need to replace "&lt;kernel&gt; ... /bin/bash /bin/tcsh" with "&lt;kernel&gt; /bin/tcsh" as shown below.</p>

<table border="1">
<tr><td>
&lt;kernel&gt; ... /bin/bash<br>
use_profile 3<br>
allow_execute /bin/tcsh<br>
<br>
&lt;kernel&gt; /bin/tcsh<br>
use_profile 3<br>
allow_execute /bin/cat<br>
<br>
&lt;kernel&gt; /bin/tcsh /bin/cat<br>
use_profile 3<br>
allow_read /etc/fstab
</td></tr>
</table>
</td></tr><tr><td>
(10) Programs that prevent domain transition initialization
</td><td>
<p>To deny the effect of "initialize_domain" directive under specific conditions, use "no_initialize_domain" directive.</p>
</td></tr><tr><td>
(11) Domains that prevent domain transition
</td><td>
<p>To declare domain keepers, use "keep_domain" directive followed by domain definition.<br>
For example, if "keep_domain &lt;kernel&gt; /usr/sbin/sshd /bin/tcsh" is given, any process that belongs to "&lt;kernel&gt; /usr/sbin/sshd /bin/tcsh" domain stays at that domain unless any program registered with "initialize_domain" directive is executed.</p>
</td></tr><tr><td>
(12) Domains that cause domain transition
</td><td>
<p>To deny the effect of "keep_domain" directive under specific conditions, use "no_keep_domain" directive.</p>
</td></tr>
</table>

<p>Press "q" key to finish the policy editor.</p>

<p>Please see the policy editor's tutorial page <a href="tool-editpolicy.html">How to use Policy Editor</a> as needed.</p>

<hr>

<h2><a name="configure_audit_daemon">Step 3: Configure to save TOMOYO's audit logs (Optional)</a></h2>

<p>TOMOYO Linux can record "access granted logs" (access requests that didn't violate domain policy) and "access rejected logs" (access requests that violated domain policy).<br>
The logs are in the form of domain policy so that the logs can be directly appended to domain policy. Add the "access rejected logs" to domain policy if you consider you should allow the access.</p>

<p>You can use a daemon program that reads from /proc/ccs/grant_log and /proc/ccs/reject_log and writes to files. Run in the following way from (for example) /etc/rc.local .</p>

<table border="1">
<tr><td>
/usr/sbin/ccs-auditd $location_to_store_access_granted_logs $location_to_store_access_rejected_logs
</td></tr>
</table>

<p>You may give MAX_GRANT_LOG=0 for profiles and give /dev/null for $location_to_store_access_granted_logs if you don't want "access granted logs". Since "ccs-auditd" doesn't have filtering functions, be careful with the disk's free space if you want to save "access granted logs".</p>

<p>You may give MAX_REJECT_LOG=0 for profiles and give /dev/null for $location_to_store_access_rejected_logs if you don't want "access rejected logs". But I recommend you to save "access rejected logs". This manual assumes that "access rejected logs" is saved in /var/log/tomoyo/reject_log.conf .</p>

<table border="1">
<tr><td>
/usr/sbin/ccs-auditd /dev/null /var/log/tomoyo/reject_log.conf
</td></tr>
</table>

<p>Create directories manually for storing access logs.</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# mkdir -p /var/log/tomoyo
</td></tr>
</table>

<p>If you want to rotate using "logrotate", create /etc/logrotate.d/tomoyo with the following content. Be sure to give "nocreate" option, or logs after the first rotation will not be saved.</p>

<table border="1">
<tr><td>
/var/log/tomoyo/reject_log.conf {<br>
&nbsp;&nbsp;weekly<br>
&nbsp;&nbsp;rotate 9<br>
&nbsp;&nbsp;missingok<br>
&nbsp;&nbsp;notifempty<br>
&nbsp;&nbsp;nocreate<br>
}
</td></tr>
</table>

<p>If you don't want neither "access granted logs" nor "access rejected logs", you needn't to run "ccs-auditd" and you can give MAX_GRANT_LOG=0 and MAX_REJECT_LOG=0 for profiles to save memory and improve performance.</p>

<hr>

<h2><a name="configure_notify_daemon">Step 4: Configure to mail TOMOYO's policy violation events (Optional)</a></h2>

<p>TOMOYO Linux can report the occurrence of policy violation in enforcing mode, if you have set up a mean to notify (e.g. mail).</p>

<p>You can use cron daemon for notifying. For example, to notify root@example.com via mail, once per an hour, add</p>

<table border="1">
<tr><td>
00 * * * * root /usr/lib/ccs/misc/ccs-notifyd 0 'mail root@example.com'
</td></tr>
</table>

<p>to /etc/crontab .</p>

<hr>

<h2>Step 5: Reboot the system</h2>

<p>Now, reboot with TOMOYO Linux kernel.</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# reboot
</td></tr>
</table>

<hr>

<p><a href="index.html">Return to index page.</a></p>
<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>
</body>
</html>
