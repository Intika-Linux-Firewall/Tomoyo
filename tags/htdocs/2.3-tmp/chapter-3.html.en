<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="en-US">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="content-style-type" content="text/css">
<link rel="stylesheet" href="../media/tomoyolinux.css" media="all" type="text/css">
<title>TOMOYO Linux 2.3.x : The Official Guide : Chapter 3</title>
</head>

<body>

<div id="titlebar">
<a href="../index.html.en"><img src="../media/tomoyotitle.png" alt="tomoyotitle.png" width="320" height="40" border="0" align="left"></a>
</div>

<div id="navbar" class="tomoyo-documentation">
<ul id="navbarlist">
<li id="tomoyo-home"><a href="../index.html.en" title="TOMOYO Linux Home Page">Home</a></li>
<li id="tomoyo-about"><a href="../about.html.en" title="About TOMOYO Linux">About</a></li>
<li id="tomoyo-download"><a href="../download.html.en" title="Get TOMOYO Linux">Download</a></li>
<li id="tomoyo-changelogs"><a href="../changelogs.html.en" title="TOMOYO Linux ChangeLogs">ChangeLogs</a></li>
<li id="tomoyo-documentation"><a href="../documentation.html.en" title="Official Documentation">Documentation</a></li>
<li id="tomoyo-support"><a href="../support.html.en" title="Support information">Support</a></li>
<li id="tomoyo-links"><a href="../links.html.en" title="Links">Links</a></li>
</ul>
<ul id="switch-language">
<li id="tomoyo-switch-language"><a href="chapter-3.html.ja" title="Go to Japanese page">Japanese page</a></li>
</ul>
</div>

<div id="content">

<div id="documentation">

<div class="navheader">
<p><a href="chapter-2.html.en">&lt;Prev&gt;</a> <a href="index.html.en">&lt;Index&gt;</a> <a href="chapter-4.html.en">&lt;Next&gt;</a></p>
</div>

<h2>Chapter 3: How do I install TOMOYO Linux?</h2>

<h3><a name="3.1">3.1. Install the kernel</a></h3>

<h4><a name="3.1.1">3.1.1. Determine if your kernel has TOMOYO Linux enabled</a></h4>

<p>TOMOYO Linux 2.3.x is integrated with the upstream kernel source, but is only enabled when certain kernel configuration options are set. You can determine if your kernel has TOMOYO Linux enabled by running the following command:</p>

<pre class="command">
$ grep tomoyo_supervisor /proc/kallsyms
</pre>

<p>If you found a lines containing tomoyo_supervisor in "/proc/kallsyms", proceed to <a href="#3.2">3.2. Install the userspace tools</a> because your kernel was built with TOMOYO Linux.</p>

<p>If not, please follow below steps because your kernel was not built with TOMOYO Linux. However, if you wish to obtain the most functionality out of TOMOYO Linux possible but do not wish to compile a kernel, the AKARI module can be used. This module provides more functionality that the 2.x branch, but is missing a small number of features that the 1.x branch provides. It is easy to use with any kernel from Linux 2.6.0 and later, depending on how the kernel has been configured and the CPU architecture. <a href="http://akari.sourceforge.jp/comparison.html.en">This chart</a> provides a detailed comparison between AKARI and both the 1.x and 2.x branches. If you would prefer to use this module, please visit the <a href="http://akari.sourceforge.jp/">AKARI website</a>.</p>

<h4><a name="3.1.2">3.1.2. Install dependencies</a></h4>

<p>These packages are required for compiling the kernel and the userspace tools:</p>
<ul>
<li><strong>wget</strong>: to download sources</li>
<li><strong>patch</strong>: to patch the kernel</li>
<li><strong>gcc</strong>: to build the kernel and tools</li>
<li><strong>make</strong>: to build the kernel and tools</li>
<li><strong>ncurses-devel</strong> or <strong>libncurses-dev</strong>: to build the tools</li>
</ul>

<p>These can be installed with the following commands:</p>

<p><strong>RedHat distributions</strong></p>
<pre class="command">
# yum -y install wget patch gcc make ncurses-devel
</pre>
<p><strong>Debian distributions</strong></p>
<pre class="command">
# apt-get -y install wget patch gcc make libncurses-dev
</pre>
<p><strong>SUSE distributions</strong></p>
<pre class="command">
# yast -i wget patch gcc make ncurses-devel
</pre>

<h4><a name="3.1.3">3.1.3. Download the kernel</a></h4>

<p>Download the kernel source from "<a href="http://www.kernel.org/pub/linux/kernel/v2.6/">linux-2.6</a>" or "<a href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=summary">linux-2.6 git tree</a>".<br>
Linux kernel 2.6.36 and later are supported.</p>

<p>Extract the kernel source and go to the extracted directory.</p>

<p>There may be bugfixes that are too late to get merged in the upstream kernel releases. Download all patches that match your kernel version (e.g. 2.6.38-tomoyo-\*.patch for 2.6.38 kernels) from <a href="http://tomoyo.sourceforge.jp/2.3/patches/">http://tomoyo.sourceforge.jp/2.3/patches/</a> and run below command from the kernel's top directory. (Below command will skip already applied patch if any.)</p>

<pre class="command">
$ for i in 2.6.*-tomoyo-*.patch; do patch -Nt -p1 --dry-run &lt; $i &amp;&amp; patch -p1 &lt; $i; done
</pre>

<h4><a name="3.1.4">3.1.4. Configure the kernel</a></h4>

<pre class="command">
$ make -s menuconfig
</pre>

<p>Choose the following options in the "Security options" section (although <i>"Default security module"</i> is optional):</p>

<pre>
[*] Enable different security models
-*- Enable the securityfs filesystem
-*- Security hooks for pathname based access control
[*] TOMOYO Linux Support
    Default security module (TOMOYO)
</pre>

<h4><a name="3.1.5">3.1.5. Compile and install the kernel</a></h4>

<p>Once the kernel has been configured, compile and install the kernel with the following commands:</p>

<pre class="command">
$ make -s
$ su
# make -s modules_install install
</pre>

<p>Create initrd/initramfs if required.</p>

<h3><a name="3.2">3.2. Install the userspace tools</a></h3>

<h4><a name="3.2.1">3.2.1. Determine if binary packages are provided</a></h4>

<p>If your repository provides tomoyo-tools or tomoyotools package, and the package's version is 2.3, you can use that package. Install and proceed to <a href="#3.3">3.3. Initialize configuration</a>.</p>

<h4><a name="3.2.2">3.2.2. Install tools from source</a></h4>

<p>Make sure the dependencies described above have been installed. Compile and install the tools with the following commands:</p>

<pre class="command">
# wget -O tomoyo-tools-2.3.0-20110511.tar.gz 'http://sourceforge.jp/frs/redir.php?f=/tomoyo/48663/tomoyo-tools-2.3.0-20110511.tar.gz'
# wget -O tomoyo-tools-2.3.0-20110511.tar.gz.asc 'http://sourceforge.jp/frs/redir.php?f=/tomoyo/48663/tomoyo-tools-2.3.0-20110511.tar.gz.asc'
# wget http://I-love.SAKURA.ne.jp/kumaneko-key
# gpg --import kumaneko-key
# gpg tomoyo-tools-2.3.0-20110511.tar.gz.asc
# tar -zxf tomoyo-tools-2.3.0-20110511.tar.gz
# make -C tomoyo-tools/ install
</pre>

<h3><a name="3.3">3.3. Initialize configuration</a></h3>

<p>You will probably want to add the location of the userspace tools (/usr/sbin) to your PATH so that the commands can be run easily. If you are using <code>/bin/bash</code>, append the following line to ~/.bashrc:</p>

<pre>
export PATH=$PATH:/usr/sbin
</pre>

<p>Before you can make use of TOMOYO Linux, an initialization procedure must take place. This prepares the files in which policy information will be stored. All policy files are <strong>stored in the "/etc/tomoyo/" directory</strong>.</p>

<p>You should see the following output by executing <code>/usr/lib/tomoyo/init_policy</code>:</p>

<pre class="command">
# /usr/lib/tomoyo/init_policy
</pre>
<pre class="output">
Creating policy directory... OK
Creating exception policy... OK
Creating domain policy... OK
Creating manager policy... OK
Creating default profile... OK
Creating memory quota policy... OK
</pre>

<p>Note that the policy configuration is not compatible between TOMOYO 2.2 and TOMOYO 2.3. If policy has been developed for TOMOYO 2.2 then the "/etc/tomoyo/" directory needs to be deleted or renamed, otherwise there will be a kernel panic on the next boot.</p>

<h3><a name="3.4">3.4. Configure bootloader</a></h3>

<p>Now edit your bootloader (e.g. GRUB) to include the kernel you have just compiled. If you kernel config does not contain "CONFIG_DEFAULT_SECURITY_TOMOYO=y", then edit your bootloader to include "security=tomoyo" in the kernel boot options. Depending on your distribution, the bootloader configuration file will probably be one of "/boot/grub/grub.conf" or "/boot/grub/menu.lst" (for GRUB version 1) or "/boot/grub/grub.cfg" (for GRUB version 2). Consult your distribution documentation for information on how to edit the bootloader.</p>

<h3><a name="3.5">3.5. Rebooting your system</a></h3>

<p>Now you have finished all preparation. You can't wait any more? Now it's time to make use of your newly installed kernel. Reboot your system and choose the entry with TOMOYO Linux kernel at the GRUB screen, or at whatever other bootloader you have installed:</p>

<img src="media/fig-1-12.png" alt="fig-1-12.png" width="500" height="375">

<p>If everything was installed properly and the bootloader was correctly configured, the kernel should boot as normal and TOMOYO Linux should be activated:</p>

<img src="media/fig-1-13.png" alt="fig-1-13.png" width="675" height="375">

<h3><a name="3.6">3.6. How can I disable/uninstall TOMOYO Linux?</a></h3>

<p>If your system becomes unable to boot during the course of this guide or any time in the future, it may be due to policy configuration or something related to TOMOYO Linux. If this is the case, it is possible that the kernel can still be booted by disabling TOMOYO Linux. This can be done by appending "security=none" at the kernel command-line parameters.</p>

<p>TOMOYO Linux fortunately does not require the modification of any existing Linux binaries, libraries or applications. Thus, uninstalling TOMOYO Linux is very easy. It is simply a matter of uninstalling the kernel and userspace tools that you installed above using your package manager (e.g. <code>rpm</code> or <code>apt</code>). You can reboot with the kernel provided by your distribution and then remove the entry from your bootloader.</p>

</div><!-- documentation -->

</div><!-- content -->

<div id="navfooter">
<hr>
<table>
<tr>
<td class="docs-previous">
<a href="chapter-2.html.en">Prev</a>
</td>
<td class="docs-index">
<a href="index.html.en">Index</a>
</td>
<td class="docs-next">
<a href="chapter-4.html.en">Next</a>
</td>
</tr>
<tr>
<td class="docs-previous-description">
<p>Chapter 2: Why do I need TOMOYO Linux?</p>
</td>
<td class="docs-home">
</td>
<td class="docs-next-description">
<p>Chapter 4: How does TOMOYO Linux work?</p>
</td>
</tr>
</table>
</div>

<div id="footer">
<p class="language">Go to <a href="chapter-3.html.ja">Japanese page</a>.</p>
<p class="timestamp">Last modified: $Date$</p>
<p class="trademark">Linux&reg; is a registered trademark of Linus Torvalds world-wide. TOMOYO&reg; is a registered trademark of <a href="http://www.nttdata.co.jp/en/">NTT DATA Corporation</a>.</p>
<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>
</div>

</body>
</html>
