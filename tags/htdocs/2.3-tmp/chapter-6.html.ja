<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja-JP">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="content-style-type" content="text/css">
<link rel="stylesheet" href="../media/tomoyolinux.css" media="all" type="text/css">
<title>TOMOYO Linux 2.3.x : 導入ガイド : Chapter 6</title>
</head>

<body>

<div id="titlebar">
<a href="../index.html.ja"><img src="../media/tomoyotitle.png" alt="tomoyotitle.png" width="320" height="40" border="0" align="left"></a>
</div>

<div id="navbar" class="tomoyo-documentation">
<ul id="navbarlist">
<li id="tomoyo-home"><a href="../index.html.ja" title="TOMOYO Linux ホーム">ホーム</a></li>
<li id="tomoyo-about"><a href="../about.html.ja" title="TOMOYO Linux の詳細">詳細</a></li>
<li id="tomoyo-download"><a href="../download.html.ja" title="TOMOYO Linux を入手">ダウンロード</a></li>
<li id="tomoyo-changelogs"><a href="../changelogs.html.ja" title="TOMOYO Linux 変更履歴">変更履歴</a></li>
<li id="tomoyo-documentation"><a href="../documentation.html.ja" title="公式ドキュメント">ドキュメント</a></li>
<li id="tomoyo-support"><a href="../support.html.ja" title="サポート情報">サポート</a></li>
<li id="tomoyo-links"><a href="../links.html.ja" title="Links">リンク</a></li>
</ul>
<ul id="switch-language">
<li id="tomoyo-switch-language"><a href="chapter-6.html.en" title="Go to English page">English page</a></li>
</ul>
</div>

<div id="content">

<div id="documentation">

<div class="navheader">
<p><a href="chapter-5.html.ja">&lt;前&gt;</a> <a href="index.html.ja">&lt;目次&gt;</a> <a href="chapter-7.html.ja">&lt;次&gt;</a></p>
</div>

<h2>Chapter 6: ポリシーはどのように作成しますか？</h2>

<h3><a name="6.1">6.1. テンポラリファイルをパターン化する</a></h3>

<p>特定のドメインでは、多数の資源に対して多数のアクセス許可を必要とすることがあります。「強制モード」では明示的に許可された資源へのアクセスだけが認められるため、必要な資源を全て網羅しておくことが重要です。網羅するために、アクセス許可をパターン化することができます。パターン化されたアクセス許可を使うと、多数のドメインポリシーのエントリを１個に集約することができます。</p>

<p>パターン化は、使い捨てのパス名が利用されるテンポラリファイルへの対処を行うのに有効です。以下に紹介する手順で対処することもできますし、ポリシーエディタを用いて対話的に対処することもできます。対話的に対処する手順の詳細については<a href="tool-editpolicy.html.ja#redundant">冗長なエントリを削除する</a>を参照してください。</p>

<p><code>tomoyo-findtemp</code> コマンドを利用して、テンポラリファイルの可能性があるパス名を抽出します：</p>

<pre class="command">
# /usr/sbin/tomoyo-findtemp &lt; /sys/kernel/security/tomoyo/domain_policy
</pre>
<pre class="output">
/tmp/RsACr8YD
/tmp/RsXg3Aav
/var/run/nscd/socket
/var/spool/clientmqueue/dfoBPETPpH002933
/var/spool/clientmqueue/dfoBPETf92002944
/var/spool/clientmqueue/qfoBPETPpH002933
/var/spool/clientmqueue/qfoBPETf92002944
/var/spool/clientmqueue/xfoBPETPpH002933
/var/spool/clientmqueue/xfoBPETf92002944
</pre>

<p>この例では、 /var/run/nscd/socket 以外は全てテンポラリファイルであると考えられます。そのため、これらのパス名をパターン化します。</p>

<p>最初に、どのようなパターンを利用するかを決めます。この例では、ランダムな文字列が使用されていると考えられます。そのため、 / 以外の任意の１文字に一致する <strong>\?</strong> と / 以外の任意の０文字以上に一致する <strong>\*</strong> が妥当だと考えられます。詳細についてはパターンの表記規則を参照してください。詳細については<a href="policy-specification/expression-rules.html.ja#wildcard">パターンの表記規則</a>を参照してください。</p>

<p><code>tomoyo-patternize</code> コマンドを利用して、非対話的にパターン化処理を行うことができます。パターン化の規則は /etc/tomoyo/tools/patternize.conf に記録されています。以下に初期設定を示します：</p>

<pre>
# This file contains rewriting rules used by tomoyo-patternize command.

# Domain policy consists with domain declaration lines (which start with
# &lt;kernel&gt; ) and acl declaration lines (which do not start with &lt;kernel&gt; ).
# You can refer the former using 'domain' keyword and the latter using 'acl'
# keyword.
#
# Words in each line are separated by a space character. Therefore, you can
# use 'domain[index]', 'acl[index]' for referring index'th word of the line.
# The index starts from 1, and 0 refers the whole line (i.e.
# 'domain[0]' = 'domain', 'acl[0]' = 'acl').
#
# Three operators are provided for conditional rewriting.
# '.contains' is for 'fgrep keyword' match.
# '.equals' is for 'grep ^keyword$' match.
# '.starts' is for 'grep ^keyword' match.
#
# Rewriting rules are defined using multi-lined chunks. A chunk is terminated
# by a 'rewrite' line which specifies old pattern and new pattern.
# A 'rewrite' line is evaluated only when all preceding 'domain' and 'acl'
# lines in that chunk have matched.
# Evaluation stops at first 'rewrite' line where a word matched old pattern.
# Therefore, no words are rewritten more than once.
#
# For user's convenience, new pattern can be omitted if old pattern is reused
# for new pattern.

# Please use TOMOYO Linux's escape rule (e.g. '\040' rather than '\ ' for
# representing a ' ' in a word).

# Files on proc filesystem.
rewrite path_pattern /proc/self/task/\$/fdinfo/\$
rewrite path_pattern /proc/self/task/\$/fd/\$
rewrite head_pattern /proc/self/task/\$/
rewrite path_pattern /proc/self/fdinfo/\$
rewrite path_pattern /proc/self/fd/\$
rewrite head_pattern /proc/self/
rewrite path_pattern /proc/\$/task/\$/fdinfo/\$
rewrite path_pattern /proc/\$/task/\$/fd/\$
rewrite head_pattern /proc/\$/task/\$/
rewrite path_pattern /proc/\$/fdinfo/\$
rewrite path_pattern /proc/\$/fd/\$
rewrite head_pattern /proc/\$/

# Files on devpts filesystem.
rewrite path_pattern devpts:/\$

# Files on pipe filesystem.
rewrite path_pattern pipe:[\$]
rewrite path_pattern pipefs:/[\$]

# Files on / partition.
rewrite tail_pattern /etc/mtab~\$
rewrite tail_pattern /etc/tomoyo/policy/\*/domain_policy.conf
rewrite tail_pattern /etc/tomoyo/policy/\*/exception_policy.conf
rewrite tail_pattern /etc/tomoyo/policy/\*/manager.conf
rewrite tail_pattern /etc/tomoyo/policy/\*/profile.conf
rewrite tail_pattern /etc/tomoyo/policy/\*/

# Files on /tmp/ partition.
rewrite tail_pattern /vte\?\?\?\?\?\?
rewrite tail_pattern /.ICE-unix/\$
rewrite tail_pattern /keyring-\?\?\?\?\?\?/socket.ssh
rewrite tail_pattern /orbit-\*/bonobo-activation-register-\X.lock
rewrite tail_pattern /orbit-\*/bonobo-activation-server-\X-ior
rewrite tail_pattern /orbit-\*/linc-\*
rewrite tail_pattern /orbit-\*/
rewrite tail_pattern /sh-thd-\$
rewrite tail_pattern /zman\?\?\?\?\?\?

# Files on home directory.
rewrite tail_pattern /.ICEauthority-\?
rewrite tail_pattern /.xauth\?\?\?\?\?\?
rewrite tail_pattern /.xauth\?\?\?\?\?\?-?
rewrite tail_pattern /.local/share/applications/preferred-mail-reader.desktop.\?\?\?\?\?\?
rewrite tail_pattern /.local/share/applications/preferred-web-browser.desktop.\?\?\?\?\?\?

# Files on /var/ partition.
rewrite tail_pattern /cache/fontconfig/\X-le64.cache-3
rewrite tail_pattern /lib/gdm/.pulse/\X-default-source
rewrite tail_pattern /lib/gdm/.pulse/\X-default-sink
rewrite tail_pattern /lib/gdm/.dbus/session-bus/\X-\X
rewrite tail_pattern /run/gdm/auth-for-\*/database-\?
rewrite tail_pattern /run/gdm/auth-for-\*/database
rewrite tail_pattern /run/gdm/auth-for-\*/
rewrite tail_pattern /spool/abrt/pyhook-\*/\{\*\}/\*
rewrite tail_pattern /spool/abrt/pyhook-\*/\{\*\}/
</pre>

<p><strong>path_pattern</strong> ディレクティブはパス名の全体一致をチェックします。<br>
<strong>head_pattern</strong> ディレクティブはパス名の前方一致をチェックします。<br>
<strong>tail_pattern</strong> ディレクティブはパス名の後方一致をチェックします。</p>

<p>/tmp/Rs\?\?\?\?\?\? および /var/spool/clientmqueue/\* というパターンを /etc/tomoyo/tools/patternize.conf に追加してください：</p>

<pre>
rewrite tail_pattern /tmp/Rs\?\?\?\?\?\?
rewrite tail_pattern /var/spool/clientmqueue/\*
</pre>

<p>その後、 <code>tomoyo-patternize</code> コマンドを利用してパターン化を行い、 <code>tomoyo-diffpolicy</code> コマンドを利用して結果を比較してください：</p>

<pre class="command">
# tomoyo-savepolicy -d &gt; /tmp/old
# tomoyo-patternize &lt; /tmp/old &gt; /tmp/new
# tomoyo-diffpolicy /tmp/old /tmp/new
</pre>
<pre class="output">
&lt;kernel&gt; /usr/sbin/httpd

allow_write /proc/self/task/\$/attr/fscreate
delete allow_write /proc/self/task/2766/attr/fscreate

&lt;kernel&gt; /usr/sbin/httpd /bin/sh /bin/mail

allow_create /tmp/Rs\?\?\?\?\?\? 0666
allow_read /tmp/Rs\?\?\?\?\?\?
allow_unlink /tmp/Rs\?\?\?\?\?\?
allow_write /tmp/Rs\?\?\?\?\?\?
delete allow_create /tmp/RsACr8YD 0666
delete allow_create /tmp/RsXg3Aav 0666
delete allow_read /tmp/RsACr8YD
delete allow_read /tmp/RsXg3Aav
delete allow_unlink /tmp/RsACr8YD
delete allow_unlink /tmp/RsXg3Aav
delete allow_write /tmp/RsACr8YD
delete allow_write /tmp/RsXg3Aav

&lt;kernel&gt; /usr/sbin/httpd /bin/sh /bin/mail

allow_ioctl pipefs:/[\$] 0x5413
delete allow_ioctl pipefs:/[11895] 0x5413
delete allow_ioctl pipefs:/[11965] 0x5413

&lt;kernel&gt; /usr/sbin/httpd /bin/sh /bin/mail /usr/sbin/sendmail

allow_create /var/spool/clientmqueue/\* 0660
allow_read /var/spool/clientmqueue/\*
allow_unlink /var/spool/clientmqueue/\*
allow_write /var/spool/clientmqueue/\*
delete allow_create /var/spool/clientmqueue/dfoBPETPpH002933 0660
delete allow_create /var/spool/clientmqueue/dfoBPETf92002944 0660
delete allow_create /var/spool/clientmqueue/qfoBPETPpH002933 0660
delete allow_create /var/spool/clientmqueue/qfoBPETf92002944 0660
delete allow_read /var/spool/clientmqueue/dfoBPETPpH002933
delete allow_read /var/spool/clientmqueue/dfoBPETf92002944
delete allow_unlink /var/spool/clientmqueue/dfoBPETPpH002933
delete allow_unlink /var/spool/clientmqueue/dfoBPETf92002944
delete allow_unlink /var/spool/clientmqueue/qfoBPETPpH002933
delete allow_unlink /var/spool/clientmqueue/qfoBPETf92002944
delete allow_unlink /var/spool/clientmqueue/xfoBPETPpH002933
delete allow_unlink /var/spool/clientmqueue/xfoBPETf92002944
delete allow_write /var/spool/clientmqueue/dfoBPETPpH002933
delete allow_write /var/spool/clientmqueue/dfoBPETf92002944
delete allow_write /var/spool/clientmqueue/qfoBPETPpH002933
delete allow_write /var/spool/clientmqueue/qfoBPETf92002944

&lt;kernel&gt; /usr/sbin/httpd /bin/sh /bin/ls

allow_ioctl pipefs:/[\$] 0x5413
delete allow_ioctl pipefs:/[11965] 0x5413
</pre>

<p>意図したとおりに変換されていない場合には、テキストエディタを利用して /tmp/new を直接編集しても構いませんし、 /etc/tomoyo/tools/patternize.conf を更新してから再度パターン化を行っても構いません。</p>

<p>意図したとおりに変換された場合には、差分をカーネル内に読み込ませることで反映することができます：</p>

<pre class="command">
# tomoyo-diffpolicy /tmp/old /tmp/new | /usr/sbin/tomoyo-loadpolicy -d
</pre>

<p>特定のドメインだけを対象に変換処理を行いたい場合、 <code>tomoyo-selectpolicy</code> コマンドを利用して特定のドメインのドメインポリシーだけを抽出することができます。例えば、 &lt;kernel&gt; /usr/sbin/httpd ドメインとその子孫ドメインだけを対象にパターン化処理を行いたい場合には、以下のように実行してください：</p>

<pre class="command">
# tomoyo-selectpolicy -r '&lt;kernel&gt; /usr/sbin/httpd' &lt; /sys/kernel/security/tomoyo/domain_policy &gt; /tmp/old-httpd
# tomoyo-patternize &lt; /tmp/old-httpd &gt; /tmp/new-httpd
# tomoyo-diffpolicy /tmp/old-httpd /tmp/new-httpd | tomoyo-loadpolicy -d
</pre>

<p>また、 /etc/tomoyo/tools/patternize.conf を編集することでも特定のドメインだけを対象に変換処理を行わせることができます。以下の行を rewite 行の前に挿入することで、 &lt;kernel&gt; /usr/sbin/httpd ドメインとその子孫ドメインだけを対象にパターン化処理を行わせることができます：</p>

<pre>
domain.starts &lt;kernel&gt; /usr/sbin/httpd
</pre>

<h3><a name="6.2">6.2. ファイルのアクセス許可をパターン化する</a></h3>

<p>学習モードでは必ずしもアクセスされないファイルに対するアクセス許可を追加します。例えば、 WWW サーバがアクセスするコンテンツを扱うために、以下のようにパターン化を行うことができます：</p>

<div class="simple-table">
<table>
<tr>
<th>
<p>修正前</p>
</th>
<th>
<p>修正後</p>
</th>
</tr>
<tr>
<td>
<p>&lt;kernel&gt; /usr/sbin/httpd</p>
<br>
<p>allow_read /var/www/html/index.html</p>
<p>allow_read /var/www/html/alice/index.html</p>
<p>allow_read /var/www/html/alice/page1.html</p>
<p>allow_read /var/www/html/alice/page2.html</p>
<p>allow_read /var/www/html/alice/image1.jpg</p>
<p>allow_read /var/www/html/alice/image2.jpg</p>
<p>allow_read /var/www/html/alice/archive/page1.html</p>
<p>allow_read /var/www/html/alice/archive/image1.jpg</p>
<p>allow_read /var/www/html/alice/archive/page2.html</p>
<p>allow_read /var/www/html/alice/archive/image2.jpg</p>
<p>allow_read /var/www/html/bob/index.html</p>
<p>allow_read /var/www/html/bob/page1.html</p>
<p>allow_read /var/www/html/bob/page2.html</p>
<p>allow_read /var/www/html/bob/image1.jpg</p>
<p>allow_read /var/www/html/bob/image2.jpg</p>
<p>allow_read /var/www/html/bob/archive/page1.html</p>
<p>allow_read /var/www/html/bob/archive/image1.jpg</p>
<p>allow_read /var/www/html/bob/archive/page2.html</p>
<p>allow_read /var/www/html/bob/archive/image2.jpg</p>
</td>
<td>
<p>&lt;kernel&gt; /usr/sbin/httpd</p>
<br>
<p>allow_read /var/www/html/\*.html</p>
<p>allow_read /var/www/html/\{\*\}/\*.html</p>
<p>allow_read /var/www/html/\{\*\}/\*.jpg</p>
</td>
</tr>
</table>
</div>

<p>例外ポリシーで以下のようなグループを定義しておくことにより：</p>

<pre>
path_group WEB-CONTENTS /var/www/html/\*.html
path_group WEB-CONTENTS /var/www/html/\{\*\}/\*.html
path_group WEB-CONTENTS /var/www/html/\{\*\}/\*.jpg
</pre>

<p>ドメインポリシーでの記述を以下のように単純化することができます：</p>

<pre>
&lt;kernel&gt; /usr/sbin/httpd

allow_read @WEB-CONTENTS
</pre>

<p>上記の変換処理は <code>tomoyo-editpolicy</code> を利用して行うことができますが、 <code>tomoyo-patternize</code> を利用して行うこともできます。上記のように path_group を例外ポリシーに追加し（ tomoyo-patternize はドメインポリシーしか扱わないので例外ポリシーへの追加は手作業で行う必要があります）、以下の内容を /etc/tomoyo/tools/patternize.conf に追加後、 <a href="#6.1">6.1. テンポラリファイルをパターン化する</a>と同様の手順を行ってください：</p>

<pre>
domain.equals &lt;kernel&gt; /usr/sbin/httpd
acl.starts allow_read
rewrite path_pattern /var/www/html/\*.html @WEB-CONTENTS

domain.equals &lt;kernel&gt; /usr/sbin/httpd
acl.starts allow_read
rewrite path_pattern /var/www/html/\{\*\}/\*.html @WEB-CONTENTS

domain.equals &lt;kernel&gt; /usr/sbin/httpd
acl.starts allow_read
rewrite path_pattern /var/www/html/\{\*\}/\*.jpg @WEB-CONTENTS
</pre>

<h3><a name="6.3">6.3. 数値パラメータをパターン化する</a></h3>

<p>ファイルのＤＡＣモードやネットワークのポート番号などの数値で表現されるパラメータについてもパターン化を行うことができます。</p>

<p>以下のドメインポリシーの例では &lt;kernel&gt; /usr/sbin/httpd ドメインに対してクライアントのポート番号が１０２４～６５５３５からの接続要求を受け付けるようにパターン化しています：</p>

<div class="simple-table">
<table>
<tr>
<th>
<p>修正前</p>
</th>
<th>
<p>修正後</p>
</th>
</tr>
<tr>
<td>
<p>&lt;kernel&gt; /usr/sbin/httpd</p>
<br>
<p>network inet stream accept 0:0:0:0:0:ffff:c0a8:801 3810</p>
<p>network inet stream accept 0:0:0:0:0:ffff:c0a8:801 3829</p>
<p>network inet stream accept 0:0:0:0:0:ffff:c0a8:801 3829</p>
</td>
<td>
<p>&lt;kernel&gt; /usr/sbin/httpd</p>
<br>
<p>network inet stream accept 0:0:0:0:0:ffff:c0a8:801 1024-65535</p>
</td>
</tr>
</table>
</div>

<p>例外ポリシーで以下のようなグループを定義しておくことにより：</p>

<pre>
number_group WEB-CLIENT-PORTS 1024-65535
</pre>

<p>ドメインポリシーでの記述を以下のように単純化することができます：</p>

<pre>
&lt;kernel&gt; /usr/sbin/httpd

network inet stream accept 0:0:0:0:0:ffff:c0a8:801 @WEB-CLIENT-PORTS
</pre>

<p>上記の変換処理は <code>tomoyo-editpolicy</code> を利用して行うことができますが、 <code>tomoyo-patternize</code> を利用して行うこともできます。上記のように number_group を例外ポリシーに追加し、以下の内容を /etc/tomoyo/tools/patternize.conf に追加後、 <a href="#6.1">6.1. テンポラリファイルをパターン化する</a>と同様の手順を行ってください：</p>

<pre>
domain.equals &lt;kernel&gt; /usr/sbin/httpd
acl.starts network inet stream accept
rewrite number_pattern 1024-65535 @WEB-CLIENT-PORTS
</pre>

<h3><a name="6.5">6.5. 収集されたアクセス許可を確認する</a></h3>

<p>Apache に許可したい操作を一通り行ったと判断したら、ポリシーエディタを実行してプロファイル番号を 2 に変更します。</p>

<p>Apache は（例えば <code>/bin/sh</code> <code>/usr/bin/perl</code> <code>/usr/lib/sendmail</code> のような）外部のプログラムを実行したことにより、 Apache に子ドメインや孫ドメインが作成されているかもしれません。 Apache 本体のドメインだけでなくその子孫ドメインのプロファイル番号も変更するのを忘れないようにしてください。</p>

<img src="media/editpolicy-httpd-profile2.png" alt="editpolicy-httpd-profile2.png" width="675" height="375">

<p>q キーを押してポリシーエディタを終了してください。その後、 Apache に対して許可したい操作を再度行ってください：</p>

<img src="media/operation-permissive.png" alt="operation-permissive.png" width="575" height="475">

</div><!-- documentation -->

</div><!-- content -->

<div id="navfooter">
<hr>
<table>
<tr>
<td class="docs-previous">
<a href="chapter-5.html.ja">前</a>
</td>
<td class="docs-index">
<a href="index.html.ja">目次</a>
</td>
<td class="docs-next">
<a href="chapter-7.html.ja">次</a>
</td>
</tr>
<tr>
<td class="docs-previous-description">
<p>Chapter 5: ドメインの管理はどのように行いますか？</p>
</td>
<td class="docs-home">
</td>
<td class="docs-next-description">
<p>Chapter 7: ポリシーの適用はどのように行いますか？</p>
</td>
</tr>
</table>
</div>

<div id="footer">
<p class="language">Go to <a href="chapter-6.html.en">English page</a>.</p>
<p class="timestamp">Last modified: $Date$</p>
<p class="trademark">Linux&reg; は世界各国における Linus Torvalds の登録商標です。 TOMOYO&reg; は<a href="http://www.nttdata.co.jp/">株式会社ＮＴＴデータ</a>の登録商標です。</p>
<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>
</div>

</body>
</html>
