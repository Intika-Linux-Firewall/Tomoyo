<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>TOMOYO Linux Kickstarting Manual for Ubuntu 6.10</title>
<link rel="stylesheet" href="../startup.css" media="all" type="text/css">
<link rev="made" href="mailto:k.takeda26@gmail.com"> 
</head>
<body>
<p style="text-align:right;"><a href="../../../../ja/1.5.x/1st-step/ubuntu6.10/index.html">Japanese Page</a></p>
<h1><a href="http://tomoyo.sourceforge.jp/">TOMOYO Linux</a> Kickstarting Manual for Ubuntu 6.10</h1>

<ul>
<li><a href="#l1">About this page</a></li>
<li><a href="#l2">Installing TOMOYO Linux kernel</a></li>
<li><a href="#l3">Installing TOMOYO Linux tools</a></li>
<li><a href="#l4">Executing automatic configuration script</a>
<li><a href="#l5">Preparation for audit logs</a></li>
<li><a href="#l6">Operation</a>
<ul>
<li><a href="#l7">Booting with TOMOYO Linux kernel</a></li>
<li><a href="#l8">Generating policies for login operations</a></li>
<li><a href="#l9">Editing generated policies</a></li>
<li><a href="#l10">Enforcing MAC</a></li>
</ul></li>
</ul>

<h2><a name="l1">About this page</a></h2>

<p>This page explains you how to introduce TOMOYO Linux 1.5.4 on Ubuntu 6.10 systems. By operating along with this page, you will be able to experience the fundamental functionalities of TOMOYO Linux and configure and operate TOMOYO Linux.</p>
<p>The following is the flow of introduction.</p>

<ol>
<li>Install TOMOYO Linux kernel and utilities</li>
<li>Configure fundamental policy</li>
<li>Policy generation and operation</li>
</ol>

<h2><a name="l2">Installing TOMOYO Linux kernel</a></h2>

<p>TOMOYO Linux is provided in the form of patches to the Linux kernels, and you need to apply these patches and compile.
But regarding Ubuntu 6.10, a binary kernel package is and this page uses it.</p>

<p>First, download the binary kernel package.</p>

<pre>
# <span class="user">wget http://osdn.dl.sourceforge.jp/tomoyo/27437/linux-image-2.6.17-12-generic-ccs1.5.4_2.6.17.1-12.44_i386.deb</span>
# <span class="user">wget http://osdn.dl.sourceforge.jp/tomoyo/27437/linux-restricted-modules-2.6.17-12-generic-ccs1.5.4_2.6.17.9-12.4_i386.deb</span>
</pre>

<p>Next, install the downloaded package.</p>

<pre>
# <span class="user">dpkg -i linux-image-2.6.17-12-generic-ccs1.5.4_2.6.17.1-12.44_i386.deb linux-restricted-modules-2.6.17-12-generic-ccs1.5.4_2.6.17.9-12.4_i386.deb</span>
</pre>

<p>The following entry is appended to /boot/grub/menu.lst if installation finishes successfully.</p>

<pre>
title           Ubuntu, kernel 2.6.17-12-generic-ccs
root            (hd0,0)
kernel          /boot/vmlinuz-2.6.17-12-generic-ccs root=/dev/sda1 ro quiet splash locale=ja_JP
initrd          /boot/initrd.img-2.6.17-12-generic-ccs
quiet
savedefault
boot
</pre>

<p>Comment out the "timeout=" line of /boot/grub/menu.lst so that you will not fail to select TOMOYO Linux's kernel.</p>
<p>To make prompt shown by /sbin/ccs-init and login programs visible, remove "splash" option from the "kernel" line.</p>
<pre>
<span class="user">#</span>timeout=5
</pre>

<h2><a name="l3">Installing TOMOYO Linux tools</a></h2>

<p>Next, you need to install TOMOYO Linux tools.
The TOMOYO Linux tools include programs for managing TOMOYO Linux's policy.</p>

<p>A binary tools package is provided and this page uses it.</p>

<pre>
# <span class="user">wget http://osdn.dl.sourceforge.jp/tomoyo/27437/ccs-tools_1.5.4-1_Ubuntu6.10_i386.deb</span>
# <span class="user">dpkg -i ccs-tools_1.5.4-1_Ubuntu6.10_i386.deb</span>
</pre>

<p>Tools are installed in /usr/lib/ccs directory.</p>

<p>You have installed TOMOYO Linux. Now proceed to configuration.</p>

<h2><a name="l4">Executing automatic configuration script</a></h2>

<p>A script is included in the tools package that performs configurations in this chapter. Run the script as follows.</p>

<pre># <span class="user">init_policy.sh --file-only-profile</span></pre>

<p>The execution of init_policy.sh may take long time (more than 10 minutes in some environment).</p>

<h3>About configuration directory</h3>

<p>The default directory for storing TOMOYO Linux's configuration is /etc/ccs/ .</p>

<h3>About profiles</h3>

<p>Since TOMOYO Linux has much functionality, you can selectively enable/disable them using "profiles".
All profiles are stored in a single file /etc/ccs/profile.conf and you can switch profiles assigned to domains.</p>

<p>Since this page explains only MAC for files, the contents of /etc/ccs/profile.conf will contain the following entries.</p>

<pre>
0-COMMENT=-----DISABLED_MODE-----
0-MAC_FOR_FILE=0
0-TOMOYO_VERBOSE=0
1-COMMENT=-----LEARNING_MODE-----
1-MAC_FOR_FILE=1
1-TOMOYO_VERBOSE=0
2-COMMENT=-----PERMISSIVE_MODE-----
2-MAC_FOF_FILE=2
2-TOMOYO_VERBOSE=1
3-COMMENT=-----ENFORCE_MODE-----
3-MAC_FOR_FILE=3
3-TOMOYO_VERBOSE=1
</pre>

<p>The syntax of an entry of /etc/ccs/profile.conf is shown below.</p>

<pre>
$profile_number-$topic_name=$control_mode
</pre>

<p>The leading integer ($profile_number) is the number of profile, the followed word before = ($topic_name) is the name of functionalities and the trailing integer after = ($control_mode) is the control mode.</p>

<p>The $topic_name = COMMENT is just for administrators.</p>

<p>The $topic_name = MAC_FOR_FILE means "MAC for file accesses", and the $control_mode = 0 means disabled, 1 means learning mode, 2 means permissive mode, 3 means enforcing mode.</p>

<p>The $topic_name = TOMOYO_VERBOSE means whether policy violation messages are printed to console or not, and prints if $control_mode = 1 and doesn't print if $control_mode = 0.</p>

<p>The above example has 4 profiles (from 0 to 3), and the purpose of them are shown below.</p>

<table><tbody>
<tr><th>profile 0</th><td>Don't apply MAC for file accesses. Don't print policy violation messages on console.</td></tr>
<tr><th>profile 1</th><td>Apply MAC for file accesses using learning mode. Don't print policy violation messages on console.</td></tr>
<tr><th>profile 2</th><td>Apply MAC for file accesses using permissive mode. Print policy violation messages on console.</td></tr>
<tr><th>profile 3</th><td>Apply MAC for file accesses using enforcing mode. Print policy violation messages on console.</td></tr>
</tbody></table>

<p>The basic procedure is, generate policy using learning mode (which is defined in profile 1),
confirm policy using permissive mode (which is defined in profile 2),
and enforce policy using enforcing mode (which is defined in profile 3).</p>

<h3>About programs that can update policies</h3>

<p>Programs that can update policies are listed in /etc/ccs/manager.conf .
The following programs are listed.</p>

<pre>
/usr/lib/ccs/loadpolicy
/usr/lib/ccs/editpolicy
/usr/lib/ccs/setlevel
/usr/lib/ccs/setprofile
/usr/lib/ccs/ld-watch
/usr/lib/ccs/ccs-queryd
</pre>

<h3>About exception policy</h3>

<p>/etc/ccs/exception_policy.conf contains the following 7 types of exceptions.</p>

<ol>
<li>Pathname patterns like /proc/PID/ to make group</li>
<li>Unconditionally readable files</li>
<li>Domain transition initializers</li>
<li>Domain keepers</li>
<li>Non-rewritable files</li>
<li>Program aggregations</li>
<li>Programs invocable via symbolic links</li>
</ol>

<h2><a name="l5">Preparation for audit logs</a></h2>

<p>TOMOYO Linux has two types of logs, "access granted logs" (access requests that didn't violate domain policy) and "access rejected logs" (access requests that violated domain policy).
This page configures to save only "access rejected logs".</p>

<p>To save logs, you can use "ccs-auditd" daemon program included in ccs-tools package.
To start "ccs-auditd" on bootup to save only "access rejected logs",
create the following script in the /etc/init.d/ directory and give execute permission to the script.</p>

<pre>
# <span class="user">cat &gt; /etc/init.d/ccs-auditd &lt;&lt; EOF</span>
<span class="user">#!/bin/sh</span>
<span class="user">/usr/lib/ccs/ccs-auditd /dev/null /var/log/tomoyo/reject_log.txt</span>
<span class="user">EOF</span>
# <span class="user">chmod +x /etc/init.d/ccs-auditd</span>
</pre>

<p>And create symbolic links to the script.</p>

<pre>
# <span class="user">update-rc.d ccs-auditd start 99 2 3 4 5 .</span>
Adding system startup for /etc/init.d/ccs-auditd ...
/etc/rc2.d/S99ccs-auditd -&gt; ../init.d/ccs-auditd
/etc/rc3.d/S99ccs-auditd -&gt; ../init.d/ccs-auditd
/etc/rc4.d/S99ccs-auditd -&gt; ../init.d/ccs-auditd
/etc/rc5.d/S99ccs-auditd -&gt; ../init.d/ccs-auditd
</pre>

<p>This script will save "access rejected logs" as /var/log/tomoyo/reject_log.txt .
You need to create the directory to save before you run this script.</p>

<pre>
# <span class="user">mkdir -p /var/log/tomoyo</span>
</pre>

<p>You have finished all preparations.</p>

<h2><a name="l6">Operation</a></h2>

<p>Now, boot with TOMOYO Linux kernel.</p>

<h3><a name="l7">Booting with TOMOYO Linux kernel</a></h3>

<p>First, reboot the system.</p>

<pre>
# <span class="user">reboot</span>
</pre>

<p>Select the TOMOYO Linux kernel and press 'Enter' key.</p>

<p><img alt="Booting with TOMOYO Linux kernel" title="Booting with TOMOYO Linux kernel" width="720" height="400" src="grub.png"></p>

<p>After the login prompt appear, log in as root.</p>

<p>To switch from graphical login to text login, press "Ctrl"-"Alt"-"F1" keys. If you are running from VMware, press keys in "Alt"-"F1"-"Ctrl" or "Ctrl"-"F1"-"Alt" order.</p>

<p><img alt="Log in as root" title="Log in as root" width="720" height="400" src="login.png"></p>

<h3><a name="l8">Generating policies for login operations</a></h3>

<p>Let the TOMOYO Linux's kernel remember the following operations, and let's see any operations that weren't done in the learning mode are denied in the enforcing mode.</p>

<ol>
<li>Running "date" command</li>
<li>Printing the heading 3 lines of /etc/passwd using "head" command</li>
<li>Invoking "sh"</li>
<li>Printing the tailing 3 lines of /etc/passwd using "tail" command</li>
<li>Exit from "sh"</li>
</ol>

<p>Now, change this session to learning mode.</p>

<p>The profile 1 is defined for learning mode.
So, assign this profile to /sbin/getty and programs invoked by /sbin/getty .</p>

<pre>
# <span class="user">/usr/lib/ccs/setprofile -r 1 '&lt;kernel&gt; /sbin/getty'</span>
</pre>

<p>This command means</p>

<blockquote><p>Assign profile 1 to /sbin/getty and all programs invoked by /sbin/getty .</p></blockquote>

<p>The /sbin/getty is a program that invokes login shell. Thus, by assigning profiles 1 to /sbin/getty and programs invoked by /sbin/getty, you can let the TOMOYO Linux kernel remember operations after login. Changing profiles takes effect immediately. Now, this session is already in the learning mode.</p>

<p>You have to quote "&lt;kernel&gt; /sbin/getty" appropriately, or you may lose the contents of /sbin/getty because "&lt;" and "&gt;" are interpreted as redirection command.</p>

<p>Let the kernel remember the 4 operations listed above. All you need to do is do these operations as usual.</p>

<p><img alt="Using learning mode" title="Using learning mode" width="720" height="400" src="ope_learning.png"></p>

<p>You can operate as if the usual Linux, but the TOMOYO Linux kernel is monitoring accesses and generating policies and storing on the memory in the background.</p>

<h3><a name="l9">Editing generated policies</a></h3>

<p>To refer and/or edit generated policy, you can use "editpolicy" in the TOMOYO Linux tools package.</p>

<pre>
# <span class="user">/usr/lib/ccs/editpolicy</span>
</pre>

<p>When you run "editpolicy", the list of process invocation history since the bootup is shown, explaining how programs are invoked until now.
TOMOYO Linux calls this invocation chains as "DOMAIN transition tree".</p>

<p><img alt="Domain Transition" title="Domain Transition" width="720" height="400" src="editpolicy1.png"></p>

<p>Search for getty from this tree. Press 'f' key and enter "getty" and press 'Enter' key.</p>

<p><img alt="Domains under getty" title="Domains under getty" width="720" height="400" src="editpolicy2.png"></p>

<p>The integer that is on the right side of line number shows profile number currently assigned to the domain. The profile number for /sbin/getty and its descendant domains is 1 because you ran earlier "setprofile -r 1 '&lt;kernel&gt; /bin/getty'".</p>

<p>You can find the tree for login operation at /bin/login under /sbin/getty .
Search for /usr/bin/head in that tree.
Press 'Enter' at the line of head command, and you will see the following window.</p>

<p><img alt="Policy for head command" title="Policy for head command" width="720" height="400" src="editpolicy3.png"></p>

<p>This is the policy generated by the previous operations and it says that</p>

<blockquote>
<p>The domain "&lt;kernel&gt; /sbin/getty /bin/login /bin/bash /usr/bin/head" (red colored underline)</p>
<ul>
<li>can read access of /etc/passwd (blue colored underline)</li>
</ul>
</blockquote>

<p>In TOMOYO Linux, the domain is defined as the history of process invocation represented using absolute pathnames of programs.
Each process belongs to single domain, and access permissions are granted to domains.</p>

<p>The granularity of permissions is standard read/write/execute plus detailed write permission such as create, unlink, rename.</p>

<p>Policies are kept on the memory and if they will be lost if you shutdown the system. To save policies currently on the memory onto disk, run the following command.</p>

<pre>
# <span class="user">/usr/lib/ccs/savepolicy</span>
</pre>

<h3><a name="l10">Enforcing MAC</a></h3>

<p>Now, let's experience MAC using previously generated policy.</p>

<p>Quit the "editpolicy" with 'q' key and run the following command.</p>

<pre>
# <span class="user">/usr/lib/ccs/setprofile -r 3 '&lt;kernel&gt; /sbin/getty'</span>
</pre>

<p>From now on, the domains under /sbin/getty are protected by MAC.</p>

<p>Now, let's do the following operations.</p>

<ol>
<li>Running "date" command</li>
<li>Printing the heading 3 lines of /etc/passwd using "head" command</li>
<li>Printing the tailing 3 lines of /etc/passwd using "tail" command (denied)</li>
<li>Printing the heading 3 lines of /etc/shadow using "head" command (denied)</li>
<li>Invoking "sh"</li>
<li>Running "date" command (denied)</li>
</ol>

<p><img alt="Enforcing MAC" title="Enforcing MAC" width="720" height="400" src="ope_enforcing.png"></p>

<p>Operations with red colored underline in the picture are performed normally because they are operations performed in the learning mode.
Operations with blue colored underline are denied.</p>

<p>The logs for denied operations are saved in /var/log/tomoyo/reject_log.txt by ccs-auditd.</p>

<pre>
#2007-09-25 14:16:14# pid=3443 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0
&lt;kernel&gt; /sbin/getty /bin/login /bin/bash
1 /usr/bin/tail

#2007-09-25 14:16:14# pid=3443 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0
&lt;kernel&gt; /sbin/getty /bin/login /bin/bash
4 /usr/bin/tail

#2007-09-25 14:16:22# pid=3444 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0
&lt;kernel&gt; /sbin/getty /bin/login /bin/bash /usr/bin/head
4 /etc/shadow

#2007-09-25 14:16:28# pid=3446 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0
&lt;kernel&gt; /sbin/getty /bin/login /bin/bash /bin/sh
1 /bin/date
</pre>

<p>As you have seen above, by using TOMOYO Linux's MAC for file accesses functionality, you can monitor</p>

<ul>
<li>Which process with what invocation history is</li>
<li>When</li>
<li>Which files and directories</li>
<li>How it accessed</li>
</ul>

<p>in detail.</p>

<hr>
<address><a href="/">TOMOYO Linux</a> is supported by <a href="http://www.nttdata.co.jp/">NTT DATA CORPORATION</a><br>
<a href="mailto:haradats@gmail.com">Send message to Webadmin</a><br>
Last modified: $Date$<br>
<!--#include virtual="/cgi-bin/counter.pl" -->
</address>

<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>

<p><a href="http://validator.w3.org/check?uri=referer">
<img src="http://www.w3.org/Icons/valid-html401" alt="Valid HTML 4.01 Strict" height="31" width="88"></a></p>

</body>
</html>
