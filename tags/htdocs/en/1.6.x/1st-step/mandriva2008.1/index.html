<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>TOMOYO Linux Kickstarting Manual for Mandriva 2008.1</title>
<link rel="stylesheet" href="../startup.css" media="all" type="text/css">
</head>
<body>
<h1><a href="http://tomoyo.sourceforge.jp/">TOMOYO Linux</a> Kickstarting Manual for Mandriva 2008.1</h1>

<ul>
<li><a href="#l1">About this page</a></li>
<li><a href="#l2">Installing TOMOYO Linux tools</a></li>
<li><a href="#l3">Initializing policy configuration</a>
<li><a href="#l4">Switching to learning mode</a></li>
<li><a href="#l5">Reviewing policies generated by learning mode</a></li>
<li><a href="#l6">Switching to enforcing mode</a></li>
</ul>

<h2><a name="l1">About this page</a></h2>

<p>This page explains you how to introduce TOMOYO Linux 1.6.3 on Mandriva 2008.1 systems. By operating along with this page, you will be able to experience the fundamental functionalities of TOMOYO Linux and configure and operate TOMOYO Linux.</p>
<p>The following is the flow of introduction.</p>

<ol>
<li>Install TOMOYO Linux utilities</li>
<li>Configure fundamental policy</li>
<li>Policy generation and operation</li>
</ol>

<h2><a name="l2">Installing TOMOYO Linux tools</a></h2>

<p>You need to install TOMOYO Linux tools.
The TOMOYO Linux tools include programs for managing TOMOYO Linux's policy.</p>

<p>Install ccs-tools rpm package using "Install &amp; Remove Software" (for operating from GUI) or "urpmi" (for operating from console or terminal). Using "urpmi" is recommended because you will need to execute /usr/lib/ccs/init_policy.sh from console or terminal after you installed ccs-tools rpm package.</p>

<pre># <span class="user">urpmi ccs-tools</span></pre>

<h2><a name="l3">Initializing policy configuration</a></h2>

<p>A script is included in the tools package that performs configurations in this chapter. Run the script as follows from console or terminal.</p>

<pre># <span class="user">/usr/lib/ccs/init_policy.sh --file-only-profile</span></pre>

<p>The execution of init_policy.sh may take long time (more than 10 minutes in some environment).</p>

<p>You have finished all preparations. Now, reboot the system.</p>

<pre># <span class="user">reboot</span></pre>

<h3>About configuration directory</h3>

<p>The default directory for storing TOMOYO Linux's configuration is /etc/ccs/ .</p>

<h3>About profiles</h3>

<p>Since TOMOYO Linux has much functionality, you can selectively enable/disable them using "profiles".
All profiles are stored in a single file /etc/ccs/profile.conf and you can switch profiles assigned to domains.</p>

<p>Since this page explains only MAC for files, the contents of /etc/ccs/profile.conf will contain the following entries.</p>

<pre>
0-COMMENT=-----DISABLED_MODE-----
0-MAC_FOR_FILE=disabled
0-TOMOYO_VERBOSE=disabled
1-COMMENT=-----LEARNING_MODE-----
1-MAC_FOR_FILE=learning
1-TOMOYO_VERBOSE=disabled
2-COMMENT=-----PERMISSIVE_MODE-----
2-MAC_FOF_FILE=permissive
2-TOMOYO_VERBOSE=enabled
3-COMMENT=-----ENFORCING_MODE-----
3-MAC_FOR_FILE=enforcing
3-TOMOYO_VERBOSE=enabled
</pre>

<p>The syntax of an entry of /etc/ccs/profile.conf is shown below.</p>

<pre>
$profile_number-$topic_name=$control_mode
</pre>

<p>The leading integer ($profile_number) is the name of profile, the followed word before = ($topic_name) is the name of functionalities and the trailing word after = ($control_mode) is the control mode.</p>

<p>The $topic_name = COMMENT is just for administrators.</p>

<p>The $topic_name = MAC_FOR_FILE means "MAC for file accesses".</p>

<p>The $topic_name = TOMOYO_VERBOSE means whether policy violation messages are printed to console or not, and prints if $control_mode = enabled and doesn't print if $control_mode = disabled.</p>

<p>The above example has 4 profiles (from 0 to 3), and the purpose of them are shown below.</p>

<table><tbody>
<tr><th>profile 0</th><td>Don't apply MAC for file accesses. Don't print policy violation messages on console.</td></tr>
<tr><th>profile 1</th><td>Apply MAC for file accesses using learning mode. Don't print policy violation messages on console.</td></tr>
<tr><th>profile 2</th><td>Apply MAC for file accesses using permissive mode. Print policy violation messages on console.</td></tr>
<tr><th>profile 3</th><td>Apply MAC for file accesses using enforcing mode. Print policy violation messages on console.</td></tr>
</tbody></table>

<p>The basic procedure is, generate policy using learning mode (which is defined in profile 1),
confirm policy using permissive mode (which is defined in profile 2),
and enforce policy using enforcing mode (which is defined in profile 3).</p>

<h3>About programs that can update policies</h3>

<p>Programs that can update policies are listed in /etc/ccs/manager.conf .
The following programs are listed.</p>

<pre>
/usr/lib/ccs/loadpolicy
/usr/lib/ccs/editpolicy
/usr/lib/ccs/setlevel
/usr/lib/ccs/setprofile
/usr/lib/ccs/ld-watch
/usr/lib/ccs/ccs-queryd
</pre>

<h3>About exception policy</h3>

<p>/etc/ccs/exception_policy.conf contains the following 12 types of exceptions.</p>

<ol>
<li>Pathname pattern</li>
<li>Pathname group</li>
<li>Address group</li>
<li>Unconditionally readable files</li>
<li>Unconditionally usable environment variable names</li>
<li>Non-rewritable files</li>
<li>Programs invocable via symbolic links</li>
<li>Program aggregations</li>
<li>Programs that cause domain transition initialization</li>
<li>Programs that prevent domain transition initialization</li>
<li>Domains that prevent domain transition</li>
<li>Domains that cause domain transition</li>
</ol>

<h3>About audit logs</h3>

<p>TOMOYO Linux has two types of logs, "access granted logs" (access requests that didn't violate domain policy) and "access rejected logs" (access requests that violated domain policy).
By installing ccs-tools package, the system is automatically configured to save only "access rejected logs".</p>

<h2><a name="l4">Switching to learning mode</a></h2>

<p>After logged into desktop desktop session, select "Menu" =&gt; "Tools" =&gt; "System Tools" =&gt; "Configure Your Computer" menu. Then, select "System" =&gt; "Open a console as administrator" menu.</p>

<p><img alt="Opening console as root user" title="Opening console as root user" width="800" height="600" src="rootconsole.png"></p>

<p>Start TOMOYO Linux's policy editor.</p>

<pre># <span class="user">/usr/sbin/ccs-editpolicy</span></pre>

<h2><a name="l5">Reviewing policies generated by learning mode</a></h2>

<h2><a name="l6">Switching to enforcing mode</a></h2>


<!--

<p>Let the TOMOYO Linux's kernel remember the following operations, and let's see any operations that weren't done in the learning mode are denied in the enforcing mode.</p>

<ol>
<li>Running "date" command</li>
<li>Printing the heading 3 lines of /etc/passwd using "head" command</li>
<li>Invoking "tcsh"</li>
<li>Printing the tailing 3 lines of /etc/passwd using "tail" command</li>
<li>Exit from "tcsh"</li>
</ol>

<p>Now, change this session to learning mode.</p>

<p>The profile 1 is defined for learning mode.
So, assign this profile to /sbin/mingetty and programs invoked by /sbin/mingetty .</p>

<pre>
# <span class="user">ccs-setprofile -r 1 '&lt;kernel&gt; /sbin/mingetty'</span>
</pre>

<p>This command means</p>

<blockquote><p>Assign profile 1 to /sbin/mingetty and all programs invoked by /sbin/mingetty .</p></blockquote>

<p>The /sbin/mingetty is a program that invokes login shell. Thus, by assigning profiles 1 to /sbin/mingetty and programs invoked by /sbin/mingetty, you can let the TOMOYO Linux kernel remember operations after login. Changing profiles takes effect immediately. Now, this session is already in the learning mode.</p>

<p>You have to quote "&lt;kernel&gt; /sbin/mingetty" appropriately, or you may lose the contents of /sbin/mingetty because "&lt;" and "&gt;" are interpreted as redirection command.</p>

<p>Let the kernel remember the 4 operations listed above. All you need to do is do these operations as usual.</p>

<p><img alt="Using learning mode" title="Using learning mode" width="720" height="400" src="ope_learning.png"></p>

<p>You can operate as if the usual Linux, but the TOMOYO Linux kernel is monitoring accesses and generating policies and storing on the memory in the background.</p>

<h3><a name="l9">Editing generated policies</a></h3>

<p>To refer and/or edit generated policy, you can use "ccs-editpolicy" in the TOMOYO Linux tools package.</p>

<pre>
# <span class="user">ccs-editpolicy</span>
</pre>

<p>When you run "ccs-editpolicy", the list of process invocation history since the bootup is shown, explaining how programs are invoked until now.
TOMOYO Linux calls this invocation chains as "DOMAIN transition tree".</p>

<p><img alt="Domain Transition" title="Domain Transition" width="720" height="400" src="editpolicy1.png"></p>

<p>Search for mingetty from this tree. Press 'f' key and enter "mingetty" and press 'Enter' key.</p>

<p><img alt="Domains under mingetty" title="Domains under mingetty" width="720" height="400" src="editpolicy2.png"></p>

<p>The integer that is on the right side of line number shows profile number currently assigned to the domain. The profile number for /sbin/mingetty and its descendant domains is 1 because you ran earlier "setprofile -r 1 '&lt;kernel&gt; /bin/mingetty'".</p>

<p>You can find the tree for login operation at /bin/login under /sbin/mingetty .
Search for /usr/bin/head in that tree.
Press 'Enter' at the line of head command, and you will see the following window.</p>

<p><img alt="Policy for head command" title="Policy for head command" width="720" height="400" src="editpolicy3.png"></p>

<p>This is the policy generated by the previous operations and it says that</p>

<blockquote>
<p>The domain "&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash /usr/bin/head" (red colored underline)</p>
<ul>
<li>can open /etc/passwd for reading (blue colored underline)</li>
</ul>
</blockquote>

<p>In TOMOYO Linux, the domain is defined as the history of process invocation represented using absolute pathnames of programs.
Each process belongs to single domain, and access permissions are granted to domains.</p>

<p>The granularity of permissions is standard read/write/execute plus detailed write permission such as create, unlink, rename.</p>

<p>Policies are kept on the memory and if they will be lost if you shutdown the system. To save policies currently on the memory onto disk, run the following command.</p>

<pre>
# <span class="user">ccs-savepolicy</span>
</pre>

<h3><a name="l10">Enforcing MAC</a></h3>

<p>Now, let's experience MAC using previously generated policy.</p>

<p>Quit the "editpolicy" with 'q' key and run the following command.</p>

<pre>
# <span class="user">ccs-setprofile -r 3 '&lt;kernel&gt; /sbin/mingetty'</span>
</pre>

<p>From now on, the domains under /sbin/mingetty are protected by MAC.</p>

<p>Now, let's do the following operations.</p>

<ol>
<li>Running "date" command</li>
<li>Printing the heading 3 lines of /etc/passwd using "head" command</li>
<li>Printing the tailing 3 lines of /etc/passwd using "tail" command (denied)</li>
<li>Printing the heading 3 lines of /etc/shadow using "head" command (denied)</li>
<li>Invoking "tcsh"</li>
<li>Running "date" command (denied)</li>
</ol>

<p><img alt="Enforcing MAC" title="Enforcing MAC" width="720" height="400" src="ope_enforcing.png"></p>

<p>Operations with red colored underline in the picture are performed normally because they are operations performed in the learning mode.
Operations with blue colored underline are denied.</p>

<p>The logs for denied operations are saved in /var/log/tomoyo/reject_log.conf by ccs-auditd.</p>

<blockquote>
#2008-05-06 10:06:31# profile=3 mode=enforcing pid=2284 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0 state[0]=0 state[1]=0 state[2]=0 argc=3 envc=17 argv[]={ "tail" "-3" "/etc/passwd" } envp[]={ "HOSTNAME=tomoyo" "TERM=linux" "SHELL=/bin/bash" "HISTSIZE=1000" "USER=root" "LS_COLORS=no=00:fi=00:di=01;34:ln=01;36:pi=40;33:so=01;35:bd=40;33;01:cd=40;33;01:or=01;05;37;41:mi=01;05;37;41:ex=01;32:*.cmd=01;32:*.exe=01;32:*.com=01;32:*.btm=01;32:*.bat=01;32:*.sh=01;32:*.csh=01;32:*.tar=01;31:*.tgz=01;31:*.arj=01;31:*.taz=01;31:*.lzh=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.gz=01;31:*.bz2=01;31:*.bz=01;31:*.tz=01;31:*.rpm=01;31:*.cpio=01;31:*.jpg=01;35:*.gif=01;35:*.bmp=01;35:*.xbm=01;35:*.xpm=01;35:*.png=01;35:*.tif=01;35:" "MAIL=/var/spool/mail/root" "PATH=/usr/kerberos/sbin:/usr/kerberos/bin:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/usr/lib/ccs:/root/bin" "PWD=/root" "LANG=C" "SHLVL=1" "HOME=/root" "LOGNAME=root" "CVS_RSH=ssh" "LESSOPEN=|/usr/bin/lesspipe.sh\040%s" "G_BROKEN_FILENAMES=1" "_=/usr/bin/tail" }<br>
&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash<br>
allow_execute /usr/bin/tail<br>
<br>
#2008-05-06 10:06:31# profile=3 mode=enforcing pid=2284 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0 state[0]=0 state[1]=0 state[2]=0<br>
&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash<br>
allow_read /usr/bin/tail<br>
<br>
#2008-05-06 10:06:37# profile=3 mode=enforcing pid=2285 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0 state[0]=0 state[1]=0 state[2]=0<br>
&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash /usr/bin/head<br>
allow_read /etc/shadow<br>
<br>
#2008-05-06 10:06:43# profile=3 mode=enforcing pid=2307 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0 state[0]=0 state[1]=0 state[2]=0 argc=1 envc=24 argv[]={ "date" } envp[]={ "HOSTNAME=tomoyo" "TERM=linux" "SHELL=/bin/bash" "HISTSIZE=1000" "USER=root" "LS_COLORS=no=00:fi=00:di=01;34:ln=01;36:pi=40;33:so=01;35:bd=40;33;01:cd=40;33;01:or=01;05;37;41:mi=01;05;37;41:ex=01;32:*.cmd=01;32:*.exe=01;32:*.com=01;32:*.btm=01;32:*.bat=01;32:*.sh=01;32:*.csh=01;32:*.tar=01;31:*.tgz=01;31:*.arj=01;31:*.taz=01;31:*.lzh=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.gz=01;31:*.bz2=01;31:*.bz=01;31:*.tz=01;31:*.rpm=01;31:*.cpio=01;31:*.jpg=01;35:*.gif=01;35:*.bmp=01;35:*.xbm=01;35:*.xpm=01;35:*.png=01;35:*.tif=01;35:" "MAIL=/var/spool/mail/root" "PATH=/usr/kerberos/sbin:/usr/kerberos/bin:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/usr/lib/ccs:/root/bin" "PWD=/root" "LANG=C" "SHLVL=2" "HOME=/root" "LOGNAME=root" "CVS_RSH=ssh" "LESSOPEN=|/usr/bin/lesspipe.sh\040%s" "G_BROKEN_FILENAMES=1" "_=/bin/tcsh" "HOSTTYPE=i386-linux" "VENDOR=intel" "OSTYPE=linux" "MACHTYPE=i386" "GROUP=root" "HOST=tomoyo" "SUPPORTED=ja_JP.UTF-8:ja_JP:ja" }<br>
&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash /bin/tcsh<br>
allow_execute /bin/date
</blockquote>

<p>As you have seen above, by using TOMOYO Linux's MAC for file accesses functionality, you can monitor</p>

<ul>
<li>Which process with what invocation history is</li>
<li>When</li>
<li>Which files and directories</li>
<li>How it accessed</li>
</ul>

<p>in detail.</p>

-->

<hr>
<address><a href="/">TOMOYO Linux</a> is supported by <a href="http://www.nttdata.co.jp/">NTT DATA CORPORATION</a><br>
<a href="mailto:haradats@gmail.com">Send message to Webadmin</a><br>
Last modified: $Date$<br>
<!--#include virtual="/cgi-bin/counter.pl" -->
</address>

<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>

<p><a href="http://validator.w3.org/check?uri=referer">
<img src="http://www.w3.org/Icons/valid-html401" alt="Valid HTML 4.01 Strict" height="31" width="88"></a></p>

</body>
</html>
