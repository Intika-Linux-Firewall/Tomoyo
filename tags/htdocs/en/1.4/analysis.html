<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>Access analysis using TOMOYO Linux</title>
<link rel="stylesheet" href="http://tomoyo.sourceforge.jp/tomoyo.css" media="all" type="text/css">
</head>
<body>
<p>Info: Version <a href="../1.4.1/">1.4.1</a> is available.</p>
<h1>Access Analysis using TOMOYO Linux</h1>
<p style="text-align:right;">Last modified: $Date$</p>

<p>Since the policy of TOMOYO Linux is represented using pathnames, TOMOYO Linux is applicable for tracing file accesses.<br>
You can use TOMOYO Linux to find how programs access files or what program is creating files on specific directories.</p>

<h1>Preparation</h1>

<h2>Install TOMOYO Linux kernel</h2>

<p>To compile kernel, see <a href="compile.html">TOMOYO Linux kernel compilation</a>.</p>

<p>If you are using distributions that support SELinux, you might encounter errors while installing packages if SELinux is not disabled. If you see error messages shown below while installing packages, retry after you disable SELinux. You can disable SELinux by either "changing SELINUX=disabled in /etc/selinux/config and reboot" or "adding selinux=0 to the kernel's boot paramaters".</p>

<table border="1">
<tr><td>
[root@localhost ~]# rpm -ihv kernel-2.6.9-55.EL_tomoyo_1.4.i586.rpm<br>
Preparing...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;########################################### [100%]<br>
Error: %pre(kernel-2.6.9-55.EL_tomoyo_1.4.i586) scriptlet failed, exit status 255<br>
Error:&nbsp;&nbsp;&nbsp;install: %pre scriptlet failed (2), skipping kernel-2.6.9-55.EL_tomoyo_1.4
</td></tr>
</table>

<p>TOMOYO Linux itself can coexist with SELinux. You may continue with SELinux enabled if you want.</p>

<p>If you install rpm package, the following entry is added to /boot/grub/grub.conf upon successful installation.</p>

<table border="1">
<tr><td>
title CentOS (2.6.9-55.EL_tomoyo_1.4)<br>
&nbsp;&nbsp;&nbsp;&nbsp;root (hd0,0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;kernel /vmlinuz-2.6.9-55.EL_tomoyo_1.4 ro root=/dev/VolGroup00/LogVol00<br>
&nbsp;&nbsp;&nbsp;&nbsp;initrd /initrd-2.6.9-55.EL_tomoyo_1.4.img
</td></tr>
</table>

<p>Append "init=/.init" to the line of "kernel".</p>

<table border="1">
<tr><td>
title CentOS (2.6.9-55.EL_tomoyo_1.4)<br>
&nbsp;&nbsp;&nbsp;&nbsp;root (hd0,0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;kernel /vmlinuz-2.6.9-55.EL_tomoyo_1.4 ro root=/dev/VolGroup00/LogVol00 init=/.init<br>
&nbsp;&nbsp;&nbsp;&nbsp;initrd /initrd-2.6.9-55.EL_tomoyo_1.4.img
</td></tr>
</table>

<p>If you install deb package, the following entry is added to /boot/grub/menu.lst upon successful installation.</p>

<table border="1">
<tr><td>
title Debian GNU/Linux, kernel 2.6.8-16sarge6-ccs<br>
root (hd0,0)<br>
kernel /boot/vmlinuz-2.6.8-16sarge6-ccs root=/dev/sda1 ro<br>
initrd /boot/initrd.img-2.6.8-16sarge6-ccs<br>
savedefault<br>
boot
</td></tr>
</table>

<p>Append "init=/.init" to the line of "kernel".</p>

<table border="1">
<tr><td>
title Debian GNU/Linux, kernel 2.6.8-16sarge6-ccs<br>
root (hd0,0)<br>
kernel /boot/vmlinuz-2.6.8-16sarge6-ccs root=/dev/sda1 ro init=/.init<br>
initrd /boot/initrd.img-2.6.8-16sarge6-ccs<br>
savedefault<br>
boot
</td></tr>
</table>

<p>The "/.init" is a script to load TOMOYO Linux's policy files and is executed before starting "/sbin/init" .<br>
The "/.init" is included in the TOMOYO Linux tools package.</p>

<h2>Install TOMOYO Linux tools</h2>

<p>To compile tools, run the following commands.</p>

<table border="1">
<tr><td>
cd /root/<br>
# Download source of tools for TOMOYO Linux.<br>
wget http://osdn.dl.sourceforge.jp/tomoyo/24615/ccs-tools-1.4-20070401.tar.gz<br>
# Extract.<br>
tar -zxf ccs-tools-1.4-20070401.tar.gz<br>
# Compile.<br>
make -sC ccstools/<br>
# Move policy loader to / .<br>
mv ccstools/.init /
</td></tr>
</table>

<h2>Create Policy</h2>

<p>Create /etc/ccs/manager.txt with the following contents.</p>

<table border="1">
<tr><td>
/root/ccstools/editpolicy
</td></tr>
</table>

<p>Create /etc/ccs/status.txt with the following contents.</p>

<table border="1">
<tr><td>
MAC_FOR_FILE=1<BR>
MAX_ACCEPT_ENTRY=1048576<BR>
MAX_GRANT_LOG=0<BR>
MAX_REJECT_LOG=0<BR>
TOMOYO_VERBOSE=0<BR>
</td></tr>
</table>

<p>Save the output of the following commands as /etc/ccs/exception_policy.txt .</p>

<table border="1">
<tr><td>
/root/ccstools/make_exception.sh | grep ^file_pattern | sort | uniq
</td></tr>
</table>

<h1>Analysis</h1>

<p>Reboot with TOMOYO Linux kernel.</p>

<p>The following messages will appear upon successful execution of "/.init", so press "Enter".</p>

<table border="1">
<tr><td>
Press 'Enter' or wait for 10 seconds to use default status.<br>
You may input 'disabled' and press 'Enter' to disable MAC in case of emergency.<br>
&gt;
</td></tr>
</table>

<p>/sbin/init will start and the system will boot if profiles are loaded successfully.<br>
On failure, the following messages will appear and the system halts.</p>

<table border="1">
<tr><td>
No profiles loaded. Run policy loader using 'init=' option.
</td></tr>
</table>

<p>If failed, check the following points.</p>

<ul>
<li>The "kernel" line of the entry of TOMOYO Linux kernel in /boot/grub/grub.conf ( or /boot/grub/menu.lst ) has "init=/.init" option.
<li> /.init has execute permission.
</ul>

<p>Run applications you want to analyze.</p>

<p>You can see the list of programs executed until now by executing /root/ccstools/editpolicy . Choose a program and press "Enter" to see the list of files accessed by the program. See <a href="tool-editpolicy.html">How to use Policy Editor</a> for usage of the policy editor.</p>

<p>You can save the list of all accessed files until now as /etc/ccs/domain_policy.txt by executing /root/ccstools/savepolicy .</p>
<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>
</body>
</html>
