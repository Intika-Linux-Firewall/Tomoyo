<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>TOMOYO Linux Kickstarting Manual for CentOS 4.5</title>
<link rel="stylesheet" href="../startup.css" media="all" type="text/css">
<link rev="made" href="mailto:k.takeda26@gmail.com"> 
</head>
<body>
<h1><a href="http://tomoyo.sourceforge.jp/">TOMOYO Linux</a> Kickstarting Manual for CentOS 4.5</h1>

<ul>
<li><a href="#l0">About this page</a></li>
<li><a href="#l1">Installation</a>
<ul>
<li><a href="#l2">Disabling SELinux</a></li>
<li><a href="#l3">Installing TOMOYO Linux kernel</a></li>
<li><a href="#l5">Installing TOMOYO Linux tools</a></li>
</ul></li>
<li><a href="#l6">Configuration</a>
<ul>
<li><a href="#l7">Creating configuration directory</a></li>
<li><a href="#l8">Creating profiles</a></li>
<li><a href="#l9">Preparation for policy generation</a></li>
<li><a href="#l10">Defining programs that can update policies</a></li>
<li><a href="#l11">Preparation for audit logs</a></li>
<li><a href="#l12">Initializing exception policy</a></li>
</ul></li>
<li><a href="#l13">Operation</a>
<ul>
<li><a href="#l14">Booting with TOMOYO Linux kernel</a></li>
<li><a href="#l15">Generating policies for login operations</a></li>
<li><a href="#l16">Editing generated policies</a></li>
<li><a href="#l17">Enforcing MAC</a></li>
</ul></li>
</ul>

<h2><a name="l0">About this page</a></h2>

<p>This page explains you how to introduce TOMOYO Linux 1.4.1 on CentOS 4.5 systems. By operating along with this page, you will be able to experience the fundamental functionalities of TOMOYO Linux and configure and operate TOMOYO Linux.</p>
<p>The following is the flow of introduction.</p>
<ol>
<li>Install TOMOYO Linux kernel and utilities</li>
<li>Configure fundamental policy</li>
<li>Policy generation and operation</li>
</ol>

<h2><a name="l1">Installation</a></h2>

<h3><a name="l2">Disabling SELinux</a></h3>

<p>Regarding CentOS, SELinux is enabled by default. TOMOYO Linux itself can coexist with SELinux. But to make troubleshooting easy, we recommend you to disable SELinux.</p>
<p>To disable SELinux, change "SELINUX=" of /etc/selinux/config as follows.</p>
<pre>
SELINUX=<span class="user">disabled</span>
</pre>
<p>Reboot the system and run "getenforce" command to make sure SELinux is desabled.</p>
<pre>
# <span class="user">getenforce</span>
Disabled
</pre>

<h3><a name="l3">Installing TOMOYO Linux kernel</a></h3>

<p>TOMOYO Linux is provided in the form of patches to the Linux kernels, and you need to apply these patches and compile. But regarding CentOS 4.5, binary kernel packages are provided and this page uses them.</p>
<p>First, download the binary kernel package.</p>
<pre>
# <span class="user">wget http://osdn.dl.sourceforge.jp/tomoyo/25544/kernel-2.6.9-55.EL_tomoyo_1.4.1.i586.rpm</span>
</pre>
<p>Next, install the downloaded package.</p>
<pre>
# <span class="user">rpm --install kernel-2.6.9-55.EL_tomoyo_1.4.1.i586.rpm</span>
</pre>
<p>The following entries are appended to /boot/grub/grub.conf if installation finishes successfully.</p>
<pre>
title CentOS (2.6.9-55.EL_tomoyo_1.4.1)
    root (hd0,0)
    kernel /vmlinuz-2.6.9-55.EL_tomoyo_1.4.1 ro root=/dev/VolGroup00/LogVol00
    initrd /initrd-2.6.9-55.EL_tomoyo_1.4.1.img
</pre>
<p>Comment out the "timeout=" and "hiddenmenu" lines of /boot/grub/grub.conf so that you will not fail to select TOMOYO Linux's kernel.</p>
<pre>
<span class="user">#</span>timeout=5
</pre>
<pre>
<span class="user">#</span>hiddenmenu
</pre>

<h3><a name="l5">Installing TOMOYO Linux tools</a></h3>

<p>After you have installed TOMOYO Linux kernel, you need to install TOMOYO Linux tools. The TOMOYO Linux tools include programs for managing TOMOYO Linux's policy.</p>
<p>Regarding CentOS 4.5, a binary tools tar ball is provided and this page uses it. We use /root/ccstools/ directory as the location of TOMOYO Linux tools.</p>
<pre>
# <span class="user">cd /root</span>
# <span class="user">wget http://osdn.dl.sourceforge.jp/tomoyo/25544/ccs-tools-1.4.1-i386-CentOS4.5.tar.gz</span>
# <span class="user">tar zxf ccs-tools-1.4.1-i386-CentOS4.5.tar.gz</span>
</pre>
<p>Add the location of TOMOYO Linux tools to the environment variable PATH. If you are using bash, run the following commands.</p>
<pre>
# <span class="user">echo 'export PATH=$PATH:/root/ccstools' &gt;&gt; ~/.bashrc</span>
# <span class="user">source ~/.bashrc</span>
</pre>
<p>Move the policy loader script (.init) to / directory.</p>
<pre>
# <span class="user">mv /root/ccstools/.init /</span>
</pre>
<p>To load TOMOYO Linux's policy automatically upon startup, you need to update the kernel command line. Append "init=/.init" at the "kernel" lines of TOMOYO Linux's kernels in /boot/grub/grub.conf .</p>
<pre>
title CentOS (2.6.9-55.EL_tomoyo_1.4.1)
    root (hd0,0)
    kernel /vmlinuz-2.6.9-55.EL_tomoyo_1.4.1 ro root=/dev/VolGroup00/LogVol00 <span class="user">init=/.init</span>
    initrd /initrd-2.6.9-55.EL_tomoyo_1.4.1.img
</pre>
<p>You have installed TOMOYO Linux. Now proceed to configuration.</p>

<h2><a name="l6">Configuration</a></h2>

<h3><a name="l7">Creating configuration directory</a></h3>

<p>The default directory for storing TOMOYO Linux's configuration is /etc/ccs/ . You need to create this directory manually.</p>
<pre>
# <span class="user">mkdir -m 700 /etc/ccs</span>
</pre>

<h3><a name="l8">Creating profiles</a></h3>

<p>Since TOMOYO Linux has much functionality, you can selectively enable/disable them using "profiles". All profiles are stored in a single file /etc/ccs/status.txt and you can switch profiles assigned to domains.</p>
<p>Since this page explains only MAC for files, create /etc/ccs/status.txt containing the following entries.</p>
<pre>
# <span class="user">cat &gt; /etc/ccs/status.txt &lt;&lt; EOF</span>
<span class="user">0-COMMENT=-----DISABLED_MODE-----</span>
<span class="user">0-MAC_FOR_FILE=0</span>
<span class="user">0-TOMOYO_VERBOSE=0</span>
<span class="user">1-COMMENT=-----LEARNING_MODE-----</span>
<span class="user">1-MAC_FOR_FILE=1</span>
<span class="user">1-TOMOYO_VERBOSE=0</span>
<span class="user">2-COMMENT=-----PERMISSIVE_MODE-----</span>
<span class="user">2-MAC_FOF_FILE=2</span>
<span class="user">2-TOMOYO_VERBOSE=1</span>
<span class="user">3-COMMENT=-----ENFORCE_MODE-----</span>
<span class="user">3-MAC_FOR_FILE=3</span>
<span class="user">3-TOMOYO_VERBOSE=1</span>
<span class="user">EOF</span>
</pre>
<p>The syntax of an entry of /etc/ccs/status.txt is shown below.</p>
<pre>
$profile_number-$topic_name=$control_mode
</pre>
<p>The leading integer ($profile_number) is the number of profile, the followed word before = ($topic_name) is the name of functionalities and the trailing integer after = ($control_mode) is the control mode.</p>
<p>The $topic_name = COMMENT is just for administrators.</p>
<p>The $topic_name = MAC_FOR_FILE means "MAC for file accesses", and the $control_mode = 0 means disabled, 1 means learning mode, 2 means permissive mode, 3 means enforcing mode.</p>
<p>The $topic_name = TOMOYO_VERBOSE means whether policy violation messages are printed to console or not, and prints if $control_mode = 1 and doesn't print if $control_mode = 0.</p>
<p>The above example has 4 profiles (from 0 to 3), and the purpose of them are shown below.</p>
<table>
<tr><th>profile 0</th><td>Don't apply MAC for file accesses. Don't print policy violation messages on console.</td></tr>
<tr><th>profile 1</th><td>Apply MAC for file accesses using learning mode. Don't print policy violation messages on console.</td></tr>
<tr><th>profile 2</th><td>Apply MAC for file accesses using permissive mode. Print policy violation messages on console.</td></tr>
<tr><th>profile 3</th><td>Apply MAC for file accesses using enforcing mode. Print policy violation messages on console.</td></tr>
</table>
<p>The basic procedure is, generate policy using learning mode (which is defined in profile 1), confirm policy using permissive mode (which is defined in profile 2), and enforce policy using enforcing mode (which is defined in profile 3).</p>

<h3><a name="l9">Preparation for policy generation</a></h3>

<p>Although TOMOYO Linux can generate policy using profile 1 (learning mode), you need some preparations before using profile 1. The preparations are listed below.</p>
<ol>
<li>Listing up programs that are allowed to update policies</li>
<li>Preparing for Audit Logs</li>
<li>Initializing Exception Policy</li>
</ol>

<h4><a name="l10">Defining programs that can update policies</a></h4>

<p>Create /etc/ccs/manager.txt and list up programs that are allowed to update policies. Specifically, list the following 6 programs in /root/ccstools/ directory.</p>
<pre>
# <span class="user">cat &gt; /etc/ccs/manager.txt &lt;&lt; EOF</span>
<span class="user">/root/ccstools/loadpolicy</span>
<span class="user">/root/ccstools/editpolicy</span>
<span class="user">/root/ccstools/setlevel</span>
<span class="user">/root/ccstools/setprofile</span>
<span class="user">/root/ccstools/ld-watch</span>
<span class="user">/root/ccstools/ccs-queryd</span>
<span class="user">EOF</span>
</pre>

<h4><a name="l11">Preparation for audit logs</a></h4>

<p>TOMOYO Linux has two types of logs, "access granted logs" (access requests that didn't violate domain policy) and "access rejected logs" (access requests that violated domain policy). This page configures to save only "access rejected logs".</p>
<p>To save logs, you can use "ccs-auditd" daemon program included in ccs-tools package. To start ccs-auditd on bootup to save only "access rejected logs", add the following line to /etc/rc.d/rc.local .</p>
<pre>
# <span class="user">echo "/root/ccstools/ccs-auditd /dev/null /var/log/tomoyo/reject_log.txt" &gt;&gt; /etc/rc.d/rc.local</span>
</pre>
<p>This script will save "access rejected logs" as /var/log/tomoyo/reject_log.txt . You need to create the directory to save before you run this script.</p>
<pre>
# <span class="user">mkdir -p /var/log/tomoyo</span>
</pre>

<h4><a name="l12">Initializing exception policy</a></h4>

<p>Before you create policy, you need to define the following 7 types of exceptions.</p>
<ol>
<li>Pathname patterns like /proc/PID/ to make group</li>
<li>Unconditionally readable files</li>
<li>Domain transition initializers</li>
<li>Domain keepers</li>
<li>Non-rewritable files</li>
<li>Program aggregations</li>
<li>Programs invocable via symbolic links</li>
</ol>
<p>TOMOYO Linux tools package contains two scripts, make_exception.sh and make_alias.sh, that automatically generate these exceptions.</p>
<p>Run the following commands.</p>
<pre>
# <span class="user">make_exception.sh &gt; /etc/ccs/exception_policy.txt</span>
# <span class="user">make_alias.sh &gt;&gt; /etc/ccs/exception_policy.txt</span>
</pre>
<p>The execution of make_alias.sh will take long time (may be longer than 10 minutes in some environment).</p>
<p>You have finished all preparations.</p>

<h2><a name="l13">Operation</a></h2>

<p>Now, boot with TOMOYO Linux kernel.</p>

<h3><a name="l14">Booting with TOMOYO Linux kernel</a></h3>

<p>First, reboot the system.</p>
<pre>
# <span class="user">reboot</span>
</pre>
<p>Select the TOMOYO Linux kernel and press 'Enter' key.</p>
<p><img alt="Booting with TOMOYO Linux kernel" title="Booting with TOMOYO Linux kernel" width="640" height="480" src="grub.png"></p>
<p>The following prompt will appear.</p>
<p><img alt="Loading policy" title="Loading policy" width="720" height="400" src="init.png"></p>
<p>Wait 10 seconds or press 'Enter' key to continue. The exception policy will be loaded and the system starts. After the login prompt appear, log in as root.</p>
<p><img alt="Log in as root" title="Log in as root" width="720" height="400" src="login.png"></p>

<h3><a name="l15">Generating policies for login operations</a></h3>

<p>Let the TOMOYO Linux's kernel remember the following operations, and let's see any operations that weren't done in the learning mode are denied in the enforcing mode.</p>
<ol>
<li>Running "date" command</li>
<li>Printing the heading 3 lines of /etc/passwd using "head" command</li>
<li>Invoking "tcsh"</li>
<li>Printing the tailing 3 lines of /etc/passwd using "tail" command</li>
<li>Exit from "tcsh"</li>
</ol>
<p>Now, change this session to learning mode.</p>
<p>According to <a href="#l8">Creating profiles</a>, the profile 1 is defined for learning mode. So, assign this profile to /sbin/mingetty and programs invoked by /sbin/mingetty .</p>
<pre>
# <span class="user">setprofile -r 1 '&lt;kernel&gt; /sbin/mingetty'</span>
</pre>
<p>This command means</p>
<blockquote><p>Assign profile 1 to /sbin/mingetty and all programs invoked by /sbin/mingetty .</p></blockquote>
<p>The /sbin/mingetty is a program that invokes login shell. Thus, by assigning profiles 1 to /sbin/mingetty and programs invoked by /sbin/mingetty, you can let the TOMOYO Linux kernel remember operations after login. Changing profiles takes effect immediately. Now, this session is already in the learning mode.</p>
<p>You have to quote "&lt;kernel&gt; /sbin/mingetty" appropriately, or you may lose the contents of /sbin/mingetty because "&lt;" and "&gt;" are interpreted as redirection command.</p>
<p>Let the kernel remember the 4 operations listed above. All you need to do is do these operations as usual.</p>
<p><img alt="Using learning mode" title="Using learning mode" width="720" height="400" src="ope_accept.png"></p>
<p>You can operate as if the usual Linux, but the TOMOYO Linux kernel is monitoring accesses and generating policies and storing on the memory in the background.</p>

<h3><a name="l16">Editing generated policies</a></h3>

<p>To refer and/or edit generated policy, you can use "editpolicy" in the TOMOYO Linux tools package.</p>
<pre>
# <span class="user">editpolicy</span>
</pre>
<p>When you run "editpolicy", the list of process invocation history since the bootup is shown, explaining how programs are invoked until now. TOMOYO Linux calls this invocation chains as "DOMAIN transition tree".</p>
<p><img alt="Domain Transition" title="Domain Transition" width="720" height="400" src="editpolicy1.png"></p>
<p>Search for mingetty from this tree. Press 'f' key and enter "mingetty" and press 'Enter' key.</p>
<p><img alt="Domains under mingetty" title="Domains under mingetty" width="720" height="400" src="editpolicy2.png"></p>
<p>The integer that is on the right side of line number shows profile number currently assigned to the domain. The profile number for /sbin/mingetty and its descendant domains is 1 because you ran earlier "setprofile -r 1 '&lt;kernel&gt; /bin/mingetty'".</p>
<p>You can find the tree for login operation at /bin/login under /sbin/mingetty . Search for /usr/bin/head in that tree.
Press 'Enter' at the line of head command, and you will see the following window.</p>
<p><img alt="Policy for head command" title="Policy for head command" width="720" height="400" src="editpolicy3.png"></p>
<p>This is the policy generated by the previous operations and it says that</p>
<blockquote>
<p>The domain "&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash /usr/bin/head" (red colored underline)</p>
<ul>
<li>can read access of /etc/passwd (blue colored underline)</li>
</ul>
</blockquote>
<p>In TOMOYO Linux, the domain is defined as the history of process invocation represented using absolute pathnames of programs. Each process belongs to single domain, and access permissions are granted to domains.</p>
<p>The granularity of permissions is standard read/write/execute plus detailed write permission such as create, unlink, rename.</p>
<p>Policies are kept on the memory and if they will be lost if you shutdown the system. To save policies currently on the memory onto disk, run the following command.</p>
<pre>
# <span class="user">savepolicy</span>
</pre>

<h3><a name="l17">Enforcing MAC</a></h3>

<p>Now, let's experience MAC using previously generated policy.</p>
<p>Quit the "editpolicy" with 'q' key and run the following command.</p>
<pre>
# <span class="user">setprofile -r 3 '&lt;kernel&gt; /sbin/mingetty'</span>
</pre>
<p>From now on, the domains under /sbin/mingetty are protected by MAC.</p>
<p>Now, let's do the following operations.</p>
<ol>
<li>Running "date" command</li>
<li>Printing the heading 3 lines of /etc/passwd using "head" command</li>
<li>Printing the tailing 3 lines of /etc/passwd using "tail" command (denied)</li>
<li>Printing the heading 3 lines of /etc/shadow using "head" command (denied)</li>
<li>Invoking "tcsh"</li>
<li>Running "date" command (denied)</li>
</ol>
<p><img alt="Enforcing MAC" title="Enforcing MAC" width="720" height="400" src="ope_enforce.png"></p>
<p>Operations with red colored underline in the picture are performed normally because they are operations performed in the learning mode. Operations with blue colored underline are denied.</p>
<p>The logs for denied operations are saved in /var/log/tomoyo/reject_log.txt by ccs-auditd.</p>
<pre>
#2007-02-08 16:12:38# pid=3523 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0
&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash
1 /usr/bin/tail

#2007-02-08 16:12:38# pid=3523 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0
&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash
4 /usr/bin/tail

#2007-02-08 16:12:45# pid=3524 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0
&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash /usr/bin/head
4 /etc/shadow

#2007-02-08 16:12:48# pid=3550 uid=0 gid=0 euid=0 egid=0 suid=0 sgid=0 fsuid=0 fsgid=0
&lt;kernel&gt; /sbin/mingetty /bin/login /bin/bash /bin/tcsh
1 /bin/date
</pre>
<p>As you have seen above, by using TOMOYO Linux's MAC for file accesses functionality, you can monitor</p>
<ul>
<li>Which process with what invocation history is</li>
<li>When</li>
<li>Which files and directories</li>
<li>How it accessed</li>
</ul>
<p>in detail.</p>
<hr>
<address><a href="/">TOMOYO Linux</a> is supported by <a href="http://www.nttdata.co.jp/">NTT DATA CORPORATION</a><br>
<a href="mailto:haradats@gmail.com">Send message to Webadmin</a><br>
Last modified: $Date$<br>
<!--#include virtual="/cgi-bin/counter.pl" -->
</address>

<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>
<p><a href="http://validator.w3.org/check?uri=referer">
<img src="http://www.w3.org/Icons/valid-html401" alt="Valid HTML 4.01 Strict" height="31" width="88"></a></p>

</body>
</html>
