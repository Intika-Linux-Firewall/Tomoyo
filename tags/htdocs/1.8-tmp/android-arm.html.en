<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="en-US">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="content-style-type" content="text/css">
<link rel="stylesheet" href="../media/tomoyolinux.css" media="all" type="text/css">
<title>TOMOYO Linux 1.8.x : TOMOYO Linux on Android</title>
</head>

<body>

<div id="titlebar">
<a href="../index.html.en"><img src="../media/tomoyotitle.png" alt="tomoyotitle.png" width="320" height="40" border="0" align="left"></a>
</div>

<div id="navbar" class="tomoyo-documentation">
<ul id="navbarlist">
<li id="tomoyo-home"><a href="../index.html.en" title="TOMOYO Linux Home Page">Home</a></li>
<li id="tomoyo-about"><a href="../about.html.en" title="About TOMOYO Linux">About</a></li>
<li id="tomoyo-download"><a href="../download.html.en" title="Get TOMOYO Linux">Download</a></li>
<li id="tomoyo-changelogs"><a href="../changelogs.html.en" title="TOMOYO Linux ChangeLogs">ChangeLogs</a></li>
<li id="tomoyo-documentation"><a href="../documentation.html.en" title="Official Documentation">Documentation</a></li>
<li id="tomoyo-support"><a href="../support.html.en" title="Support information">Support</a></li>
<li id="tomoyo-links"><a href="../links.html.en" title="Links">Links</a></li>
</ul>
<ul id="switch-language">
<li id="tomoyo-switch-language"><a href="android-arm.html.ja" title="Go to Japanese page">Japanese page</a></li>
</ul>
</div>

<div id="content">

<div id="regular-content">

<h2>TOMOYO Linux on Android</h2>

<p>This page describes how to run TOMOYO Linux on Android emulator for ARM architecture. This page assumes Ubuntu 8.04.4 for x86 architecture as the host environment.</p>

<h3>Step 1: Install required packages.</h3>

<p>Install packages as suggested at <a href="http://source.android.com/source/download.html">http://source.android.com/source/download.html</a> .</p>

<pre class="command">
sudo apt-get install git-core gnupg sun-java5-jdk flex bison gperf libsdl-dev libesd0-dev libwxgtk2.6-dev build-essential zip curl libncurses5-dev zlib1g-dev
</pre>

<h3>Step 2: Set environment variables.</h3>

<p>Set environment variables shown below. Adding to user's initrc script (e.g. ~/.bashrc ) is recommended. You may try arm-eabi-4.3.1 or arm-eabi-4.4.0 instead of arm-eabi-4.2.1 .</p>

<pre class="command">
export ANDROID_HOME=$HOME/mydroid/
export ANDROID_IMG=$ANDROID_HOME/image/
export ANDROID_TOOLCHAIN=$ANDROID_HOME/prebuilt/linux-x86/toolchain/arm-eabi-4.2.1/bin/
export PATH=$PATH:$ANDROID_HOME/out/host/linux-x86/bin/:$ANDROID_TOOLCHAIN
</pre>

<h3>Step 3: Build the Android environment.</h3>

<p>Download the source code and compile the emulator.</p>

<pre class="command">
mkdir -p $ANDROID_HOME
cd $ANDROID_HOME
wget http://android.git.kernel.org/repo
chmod 755 repo
./repo init -u git://android.git.kernel.org/platform/manifest.git -b froyo
./repo sync
make
</pre>

<h3>Step 4: Build the Android kernel.</h3>

<p>Compile the kernel. The proceedure is same as usual except applying TOMOYO Linux patches.</p>

<pre class="command">
mkdir -p $ANDROID_HOME/tmp
cd $ANDROID_HOME/tmp/
wget -O kernel-source.tar.gz 'http://android.git.kernel.org/?p=kernel/common.git;a=snapshot;h=b0d93fb0426911d0329f861f22c59f1c72cff815;sf=tgz'
tar -zxf kernel-source.tar.gz
cd common-b0d93fb/
wget -O ccs-patch-1.8.0-20110121.tar.gz 'http://sourceforge.jp/frs/redir.php?f=/tomoyo/49684/ccs-patch-1.8.0-20110121.tar.gz'
wget -O ccs-patch-1.8.0-20110121.tar.gz.asc 'http://sourceforge.jp/frs/redir.php?f=/tomoyo/49684/ccs-patch-1.8.0-20110121.tar.gz.asc'
gpg ccs-patch-1.8.0-20110121.tar.gz.asc
tar -zxf ccs-patch-1.8.0-20110121.tar.gz
patch -p1 &lt; patches/ccs-patch-2.6.29-android-goldfish.diff
sed -i -e 's:/sbin/modprobe /sbin/hotplug::' -e 's:/sbin/ccs-start:/init:' -- security/ccsecurity/Kconfig
ARCH=arm CROSS_COMPILE=$ANDROID_TOOLCHAIN/arm-eabi- make goldfish_defconfig
ARCH=arm CROSS_COMPILE=$ANDROID_TOOLCHAIN/arm-eabi- make -s
mkdir -p $ANDROID_IMG/tmp
cp -p arch/arm/boot/zImage $ANDROID_IMG/kernel.img
</pre>

<h3>Step 5: Copy Android's image files.</h3>

<p>Copy image file used by Android emulator.</p>

<pre class="command">
cd $ANDROID_HOME/out/target/product/generic/
cp -p system.img ramdisk.img userdata.img $ANDROID_IMG
</pre>

<h3>Step 6: Compile tools for host environment.</h3>

<p>Install TOMOYO Linux's userland tools into host environment in order to manage Android emulator remotely.</p>

<pre class="command">
cd $ANDROID_HOME/tmp/
wget -O ccs-tools-1.8.0-20101231.tar.gz 'http://sourceforge.jp/frs/redir.php?f=/tomoyo/49693/ccs-tools-1.8.0-20101231.tar.gz'
wget -O ccs-tools-1.8.0-20101231.tar.gz.asc 'http://sourceforge.jp/frs/redir.php?f=/tomoyo/49693/ccs-tools-1.8.0-20101231.tar.gz.asc'
gpg ccs-tools-1.8.0-20101231.tar.gz.asc
tar -zxf ccs-tools-1.8.0-20101231.tar.gz
cd ccstools
sudo apt-get install libreadline-dev
make
sudo make install
</pre>

<h3>Step 7: Compile tools for emulator environment.</h3>

<p>Install TOMOYO Linux's userland tools into Android emulator environment.</p>

<p>Since /init.rc in Android emulator's ramdisk creates /etc as a symlink to /system/etc/ directory, /sbin/ccs-init (TOMOYO Linux's policy loader which will be added at Step 13) can't reserve /etc/ccs/ directory for storing policy which is loaded upon boot. Thus, use /ccs/ directory rather than /etc/ccs/ directory.</p>

<pre class="command">
cd $ANDROID_HOME/tmp/
wget -O agcc http://plausible.org/andy/agcc
chmod 755 agcc
./agcc -o init_policy $ANDROID_HOME/tmp/ccstools/usr_lib_ccs/init_policy.c
./agcc -o ccs-editpolicy-agent $ANDROID_HOME/tmp/ccstools/usr_lib_ccs/ccs-editpolicy-agent.c
sed -e 's:etc/ccs:ccs:g' $ANDROID_HOME/tmp/ccstools/sbin/ccs-init.c &gt; $ANDROID_HOME/tmp/ccstools/ccs-init2.c
./agcc -o ccs-init $ANDROID_HOME/tmp/ccstools/ccs-init2.c
chmod 700 init_policy ccs-editpolicy-agent ccs-init
</pre>

<h3>Step 8: Edit Android's ramdisk image.</h3>

<p>Copy the agent program into Android emulator's ramdisk and configure the agent to be automatically executed upon boot.</p>

<pre class="command">
cd $ANDROID_IMG/tmp/
zcat ../ramdisk.img | cpio -id
echo 'service ccs_agent /sbin/ccs-editpolicy-agent 0.0.0.0:7000' &gt;&gt; init.rc
echo '&nbsp;&nbsp;&nbsp;&nbsp;oneshot' &gt;&gt; init.rc
echo &gt;&gt; init.rc
cp -p $ANDROID_HOME/tmp/init_policy $ANDROID_HOME/tmp/ccs-editpolicy-agent sbin/
find . -print0 | cpio -o0 -H newc | gzip -9 &gt; ../ramdisk.img
</pre>

<h3>Step 9: Start the Android emulator.</h3>

<p>Start the Android emulator. Specify the kernel made at step 4 and the ramdisk made at step 8.</p>

<pre class="command">
emulator -kernel $ANDROID_IMG/kernel.img -ramdisk $ANDROID_IMG/ramdisk.img -sysdir $ANDROID_IMG -data $ANDROID_IMG/userdata.img -show-kernel
</pre>

<h3>Step 10: Pull files needed for policy loader.</h3>

<p>Copy files needed by /sbin/ccs-init . On Android environment, /system/bin/loader is used for loading dynamically linked library files. But /system/ partition is not yet mounted when /sbin/ccs-init is executed. Therefore, you need to copy /bin/loader in the /system/ partition to /system/bin/ directory in the ramdisk's image. Likewise, you need to copy /lib/libc.so and /lib/libm.so in the /system/ partition to /lib/ directory in the ramdisk's image.</p>

<pre class="command">
cd $ANDROID_IMG/tmp/
mkdir -p system/bin lib
adb pull /system/bin/linker system/bin/
adb pull /system/lib/libc.so lib/
adb pull /system/lib/libm.so lib/
chmod 755 system/bin/linker lib/libc.so lib/libm.so
</pre>

<h3>Step 11: Initialize policy and pull.</h3>

<p>Create initial policy used by TOMOYO Linux. Then, copy the initial policy to ramdisk's /ccs/ directory.</p>

<pre class="command">
mkdir -p $ANDROID_IMG/tmp/ccs/
adb shell /sbin/init_policy policy_dir=/data/ccs/
adb pull /data/ccs/ $ANDROID_IMG/tmp/ccs/
rm -fR $ANDROID_IMG/tmp/ccs/tools/ $ANDROID_IMG/tmp/ccs/policy/ $ANDROID_IMG/tmp/ccs/ccs-load-module
adb shell rm -R /data/ccs/
adb emu kill
</pre>

<h3>Step 12: Edit initialized policy.</h3>

<p>Add missing entries (e.g. "acl_group 0 file read" ) to exception policy. Below is just an example. Domain policy is configured to use profile 1 (which is a profile for "learning mode"). Manager is configured to allow only agent program.</p>

<pre class="command">
cd $ANDROID_IMG/tmp/
(
echo 'initialize_domain /init'
echo 'initialize_domain /system/bin/app_process'

echo 'acl_group 0 file read /system/lib/\@.so'
echo 'acl_group 0 file read /system/framework/\*.jar'
echo 'acl_group 0 file read /system/media/audio/\*/\*'
echo 'acl_group 0 file read /system/fonts/\*.ttf'

echo 'path_group SYSTEM_APK /system/app/\@.apk'

echo 'path_group SYS_FILES sysfs:/kernel/ipv4/tcp_wmem_min'
echo 'path_group SYS_FILES sysfs:/kernel/ipv4/tcp_wmem_def'
echo 'path_group SYS_FILES sysfs:/kernel/ipv4/tcp_wmem_max'
echo 'path_group SYS_FILES sysfs:/kernel/ipv4/tcp_rmem_min'
echo 'path_group SYS_FILES sysfs:/kernel/ipv4/tcp_rmem_def'
echo 'path_group SYS_FILES sysfs:/kernel/ipv4/tcp_rmem_max'

echo 'acl_group 0 file read sysfs:/devices/platform/\*battery\*/power_supply/ac/online'
echo 'acl_group 0 file read sysfs:/devices/platform/\*battery\*/power_supply/battery/\@'

#App. specific data files
) &gt;&gt; ccs/exception_policy.conf
(
echo '&lt;kernel&gt;'
echo 'use_profile 1'
) &gt; ccs/domain_policy.conf
echo /sbin/ccs-editpolicy-agent &gt; ccs/manager.conf
</pre>

<h3>Step 13: Add policy loader to Android's ramdisk image.</h3>

<p>Add ccs-init into ramdisk in order to enable TOMOYO Linux.</p>

<pre class="command">
cd $ANDROID_IMG/tmp/
rm sbin/init_policy
cp -p $ANDROID_HOME/tmp/ccs-init sbin/
find . -print0 | cpio -o0 -H newc | gzip -9 &gt; ../ramdisk.img
</pre>

<h3>Step 14: Start the Android emulator.</h3>

<p>Start the Android emulator. Specify the kernel made at step 4 and the ramdisk made at step 13.</p>

<pre class="command">
emulator -kernel $ANDROID_IMG/kernel.img -ramdisk $ANDROID_IMG/ramdisk.img -sysdir $ANDROID_IMG -data $ANDROID_IMG/userdata.img -show-kernel
</pre>

<h3>Step 15: Enable TCP port forwarding.</h3>

<p>Configure port forwarding in order to communicate with the agent program running in the emulator. Below line makes TCP connection requests sent to host enviroment's port 10000 are forwarded to emulator environment's port 7000. As you have configures ccs-editpolicy-agent to listen at port 7000 at step 8, you can communicate with the agent program by connecting to host environment's port 10000.</p>

<pre class="command">
adb forward tcp:10000 tcp:7000
</pre>

<h3>Step 16: Operate via agent.</h3>

<p>You can browse/edit policy via agent program by starting ccs-editpolicy as shown below.</p>

<pre class="command">
/usr/sbin/ccs-editpolicy 127.0.0.1:10000
</pre>

<p>You can save current policy into ramdisk's /ccs/ directory by executing ccs-savepolicy as shown below.</p>

<pre class="command">
cd $ANDROID_IMG/tmp/
/usr/sbin/ccs-savepolicy -e 127.0.0.1:10000 &gt; ccs/exception_policy.conf
/usr/sbin/ccs-savepolicy -d 127.0.0.1:10000 &gt; ccs/domain_policy.conf
/usr/sbin/ccs-savepolicy -p 127.0.0.1:10000 &gt; ccs/profile.conf
find . -print0 | cpio -o0 -H newc | gzip -9 &gt; ../ramdisk.img
</pre>

<p>You can save audit logs by starting ccs-auditd as shown below. Please be careful with disk's free space because a lot of logs are generated.</p>

<pre class="command">
/usr/sbin/ccs-auditd 127.0.0.1:10000
</pre>

<p>You can interactively handle policy violation in enforcing mode by starting ccs-queryd as shown below. Press Ctrl-C to terminate ccs-queryd.</p>

<pre class="command">
/usr/sbin/ccs-queryd 127.0.0.1:10000
</pre>

</div><!-- regular-content -->

</div><!-- content -->

<div id="footer">
<p class="language">Go to <a href="android-arm.html.ja">Japanese page</a>.</p>
<p class="timestamp">Last modified: $Date$</p>
<p class="trademark">Linux&reg; is a registered trademark of Linus Torvalds world-wide. TOMOYO&reg; is a registered trademark of <a href="http://www.nttdata.co.jp/en/">NTT DATA Corporation</a>.</p>
<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>
</div>

</body>
</html>
