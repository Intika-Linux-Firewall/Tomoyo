<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja-JP">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="content-style-type" content="text/css">
<link rel="stylesheet" href="../media/tomoyolinux.css" media="all" type="text/css">
<title>TOMOYO Linux 2.3.x : 導入ガイド : Chapter 3</title>
</head>

<body>

<div id="titlebar">
<a href="../index.html.ja"><img src="../media/tomoyotitle.png" alt="tomoyotitle.png" width="320" height="40" border="0" align="left"></a>
</div>

<div id="navbar" class="tomoyo-documentation">
<ul id="navbarlist">
<li id="tomoyo-home"><a href="../index.html.ja" title="TOMOYO Linux ホーム">ホーム</a></li>
<li id="tomoyo-about"><a href="../about.html.ja" title="TOMOYO Linux の詳細">詳細</a></li>
<li id="tomoyo-download"><a href="../download.html.ja" title="TOMOYO Linux を入手">ダウンロード</a></li>
<li id="tomoyo-changelogs"><a href="../changelogs.html.ja" title="TOMOYO Linux 変更履歴">変更履歴</a></li>
<li id="tomoyo-documentation"><a href="../documentation.html.ja" title="公式ドキュメント">ドキュメント</a></li>
<li id="tomoyo-support"><a href="../support.html.ja" title="サポート情報">サポート</a></li>
<li id="tomoyo-links"><a href="../links.html.ja" title="Links">リンク</a></li>
</ul>
<ul id="switch-language">
<li id="tomoyo-switch-language"><a href="chapter-3.html.en" title="Go to English page">English page</a></li>
</ul>
</div>

<div id="content">

<div id="documentation">

<div class="navheader">
<p><a href="chapter-2.html.ja">&lt;前&gt;</a> <a href="index.html.ja">&lt;目次&gt;</a> <a href="chapter-4.html.ja">&lt;次&gt;</a></p>
</div>

<h2>Chapter 3: どうすれば TOMOYO Linux をインストールできますか？</h2>

<h3><a name="3.1">3.1. カーネルのインストール</a></h3>

<h4><a name="3.1.1">3.1.1. 既に TOMOYO Linux 対応カーネルであるかどうか判断する</a></h4>

<p>TOMOYO Linux 2.3 はメインラインカーネルのソースに既に含まれていますが、特定のカーネルコンフィグオプションを有効にしないと利用できません。以下の手順により利用中のカーネルで TOMOYO Linux を利用できるかどうかを判断することができます。</p>

<pre class="command">
$ grep tomoyo_supervisor /proc/kallsyms
</pre>

<p>/proc/kallsyms の中に tomoyo_supervisor を含む行が存在していた場合、既に TOMOYO Linux 対応カーネルですので、<a href="#3.2">3.2. 管理ツールのインストール</a>へと進んでください。</p>

<p>存在しない場合、 TOMOYO Linux 対応カーネルを作成する必要がありますので、以下の手順に従ってインストールしてください。ただし、カーネルのコンパイルをせずに TOMOYO Linux の機能の主要部分を使いたい場合には、 AKARI というカーネルモジュールを利用することができます。このモジュールは TOMOYO 2.x よりも豊富な機能を提供していますが、 TOMOYO 1.x の機能の一部は使えません。「カーネルがどのようなコンパイルオプションでコンパイルされたか」と「ＣＰＵアーキテクチャ」に依存するという制限がありますが、カーネル 2.6.0 以降の全てのバージョンに対応しており、簡単に利用できます。 <a href="http://akari.sourceforge.jp/comparison.html.ja">機能比較表</a>で AKARI と TOMOYO 1.x と TOMOYO 2.x の違いについて詳細に説明されています。もし、 AKARI を使うのであれば、 <a href="http://akari.sourceforge.jp/">AKARI のウェブサイト</a>へと移動してください。</p>

<h4><a name="3.1.2">3.1.2. 依存するパッケージのインストール</a></h4>

<p>カーネルと管理ツールをコンパイルするために以下のパッケージが必要になります：</p>
<ul>
<li><strong>wget</strong> ：ソースコードをダウンロードするのに必要です。</li>
<li><strong>patch</strong> ：カーネルにパッチを当てるのに必要です。</li>
<li><strong>gcc</strong> ：カーネルおよび管理ツールをコンパイルするのに必要です。</li>
<li><strong>make</strong> ：カーネルおよび管理ツールをコンパイルするのに必要です。</li>
<li><strong>ncurses-devel</strong> または <strong>libncurses-dev</strong> ：管理ツールをコンパイルするのに必要です。</li>
</ul>

<p>これらのパッケージは以下のコマンドを実行することでインストールできます：</p>

<p><strong>RedHat 系の場合</strong></p>
<pre class="command">
# yum -y install wget patch gcc make ncurses-devel
</pre>
<p><strong>Debian 系の場合</strong></p>
<pre class="command">
# apt-get -y install wget patch gcc make libncurses-dev
</pre>
<p><strong>SUSE 系の場合</strong></p>
<pre class="command">
# yast -i wget patch gcc make ncurses-devel
</pre>

<h4><a name="3.1.3">3.1.3. カーネルソースの入手</a></h4>

<p>カーネルのソースを "<a href="http://www.kernel.org/pub/linux/kernel/v2.6/">linux-2.6</a>" または "<a href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=summary">linux-2.6 git tree</a>" からダウンロードして展開してください。<br>
カーネル 2.6.36 以降に対応しています。</p>

<p>カーネルのソースを展開して、そのディレクトリに移動してください。</p>

<p>メインラインのカーネルのソースに反映することが間に合わなかった不具合修正パッチがあるかもしれません。利用するカーネルのバージョンに合った全ての不具合修正パッチ（例えば 2.6.38 カーネルの場合には 2.6.38-tomoyo-\*.patch ）を <a href="http://tomoyo.sourceforge.jp/2.3/patches/">http://tomoyo.sourceforge.jp/2.3/patches/</a> からダウンロードして、カーネルのソースコードを展開したディレクトリから以下のコマンドを実行してください。（以下のコマンドは、適用済みのパッチがあればスキップします。）</p>

<pre class="command">
$ for i in 2.6.*-tomoyo-*.patch; do patch -Nt -p1 --dry-run &lt; $i &amp;&amp; patch -p1 &lt; $i; done
</pre>

<h4><a name="3.1.4">3.1.4. カーネルコンパイルオプションの設定</a></h4>

<pre class="command">
$ make -s menuconfig
</pre>

<p>Security options の画面に移動して、以下のオプションを選択してください。（ <i>Default security module</i> として TOMOYO を指定するかどうかは任意です。）</p>

<pre>
[*] Enable different security models
-*- Enable the securityfs filesystem
-*- Security hooks for pathname based access control
[*] TOMOYO Linux Support
    Default security module (TOMOYO)
</pre>

<h4><a name="3.1.5">3.1.5. カーネルのコンパイルおよびインストール</a></h4>

<p>カーネルコンパイルオプションの変更が終わったら、以下のコマンドを実行してカーネルをコンパイルしてください：</p>

<pre class="command">
$ make -s
$ su
# make -s modules_install install
</pre>

<p>必要であれば initrd/initramfs を作成してください。</p>

<h3><a name="3.2">3.2. 管理ツールのインストール</a></h3>

<h4><a name="3.2.1">3.2.1. バイナリパッケージが提供されているかどうか判断する</a></h4>

<p>tomoyo-tools あるいは tomoyotools というパッケージが提供されており、そのバージョンが 2.3 である場合、それを利用することができます。インストールして <a href="#3.3">3.3. 設定の初期化</a>へと進んでください。</p>

<h4><a name="3.2.2">3.2.2. ツールをソースからコンパイルする</a></h4>

<p>前述した依存するパッケージがインストールされていることを確認してください。以下のコマンドを実行することによりコンパイルおよびインストールできます。</p>

<pre class="command">
# wget -O tomoyo-tools-2.3.0-20110511.tar.gz 'http://sourceforge.jp/frs/redir.php?f=/tomoyo/48663/tomoyo-tools-2.3.0-20110511.tar.gz'
# wget -O tomoyo-tools-2.3.0-20110511.tar.gz.asc 'http://sourceforge.jp/frs/redir.php?f=/tomoyo/48663/tomoyo-tools-2.3.0-20110511.tar.gz.asc'
# wget http://I-love.SAKURA.ne.jp/kumaneko-key
# gpg --import kumaneko-key
# gpg tomoyo-tools-2.3.0-20110511.tar.gz.asc
# tar -zxf tomoyo-tools-2.3.0-20110511.tar.gz
# make -C tomoyo-tools/ install
</pre>

<h3><a name="3.3">3.3. 設定の初期化</a></h3>

<p>管理ツールを実行するときに便利なように、管理ツールのインストールされているディレクトリ（ /usr/sbin ）を環境変数 PATH に追加したいと思うかもしれません。 <code>/bin/bash</code> を使用している場合、以下の行を ~/.bashrc に追加してください：</p>

<pre>
export PATH=$PATH:/usr/sbin
</pre>

<p>TOMOYO Linux を使うためには、初期設定の手順を行う必要があります。この手順により、ポリシーを保存するディレクトリが作成されます。全てのポリシーファイルは <strong>/etc/tomoyo/ ディレクトリに保存されます</strong>。</p>

<p><code>/usr/lib/tomoyo/init_policy</code> を実行することで、以下のような出力が表示される筈です：</p>

<pre class="command">
# /usr/lib/tomoyo/init_policy
</pre>
<pre class="output">
Creating policy directory... OK
Creating exception policy... OK
Creating domain policy... OK
Creating manager policy... OK
Creating default profile... OK
Creating memory quota policy... OK
</pre>

<p>なお、 TOMOYO 2.2 用のポリシーと TOMOYO 2.3 用のポリシーとの間には互換性がありません。既に TOMOYO 2.2 用のポリシーを策定済みであっても、 /etc/tomoyo/ ディレクトリを削除（またはリネーム）してから上記のコマンドを実行する必要があります。さもないと、起動時にカーネルパニックに遭遇します。</p>

<h3><a name="3.4">3.4. ブートローダの設定</a></h3>

<p>前述の手順でインストールされたカーネルをブートローダ（例えば GRUB など）から選択できるように、ブートローダの設定を行ってください。もし、カーネルコンフィグで CONFIG_DEFAULT_SECURITY_TOMOYO=y という指定が行われていない場合、 security=tomoyo という指定をカーネル起動時のコマンドラインオプションに含めることを忘れないでください。ディストリビューションにより、ブートローダの設定ファイルの場所が異なります。 GRUB バージョン１を利用している場合には /boot/grub/grub.conf または /boot/grub/menu.lst のどちらか、 GRUB バージョン２を利用している場合には /boot/grub/grub.cfg であると思います。詳しくはお使いのディストリビューションのドキュメントを参照してください。</p>

<h3><a name="3.5">3.5. システムの再起動</a></h3>

<p>ここまでで準備は完了です。（お疲れさまでした。）それでは、新しくインストールされたカーネルを使用してみましょう。システムを再起動し、 GRUB の画面（あるいは使用している他のブートローダの画面）で TOMOYO Linux カーネルを選択してください：</p>

<img src="media/fig-1-12.png" alt="fig-1-12.png" width="500" height="375">

<p>正常にインストールが完了し、ブートローダの設定が適切に行われていれば、正常にカーネルがロードされ、 TOMOYO Linux が有効になる筈です：</p>

<img src="media/fig-1-13.png" alt="fig-1-13.png" width="675" height="375">

<h3><a name="3.6">3.6. どのようにすれば TOMOYO Linux を無効化またはアンインストールできますか？</a></h3>

<p>もし、このガイドに従って操作している間またはそれ以降にシステムが起動しなくなってしまった場合、ポリシーの設定が不適切である場合を含めて TOMOYO Linux に原因があるかもしれません。その場合、 security=none というパラメータをカーネルに対するコマンドラインオプションに指定することにより、 TOMOYO Linux が無効な状態でカーネルがロードされます。</p>

<p>幸いなことに、 TOMOYO Linux はカーネル以外には既存のプログラムやライブラリなどに対する修正を必要としません。そのため、 TOMOYO Linux のアンインストールはとても簡単です。（ <code>rpm</code> や <code>apt</code> などの）パッケージマネージャを用いてインストールされたカーネルおよび管理ツールをアンインストールするだけです。ディストリビューションから配布されているカーネルで再起動して、ブートローダから TOMOYO Linux カーネル用のエントリを削除してください。</p>

</div><!-- documentation -->

</div><!-- content -->

<div id="navfooter">
<hr>
<table>
<tr>
<td class="docs-previous">
<a href="chapter-2.html.ja">前</a>
</td>
<td class="docs-index">
<a href="index.html.ja">目次</a>
</td>
<td class="docs-next">
<a href="chapter-4.html.ja">次</a>
</td>
</tr>
<tr>
<td class="docs-previous-description">
<p>Chapter 2: なぜ TOMOYO Linux が必要なのですか？</p>
</td>
<td class="docs-home">
</td>
<td class="docs-next-description">
<p>Chapter 4: TOMOYO Linux はどのように動きますか？</p>
</td>
</tr>
</table>
</div>

<div id="footer">
<p class="language">Go to <a href="chapter-3.html.en">English page</a>.</p>
<p class="timestamp">Last modified: $Date$</p>
<p class="trademark">Linux&reg; は世界各国における Linus Torvalds の登録商標です。 TOMOYO&reg; は<a href="http://www.nttdata.co.jp/">株式会社ＮＴＴデータ</a>の登録商標です。</p>
<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>
</div>

</body>
</html>
