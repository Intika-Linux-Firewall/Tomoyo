<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>The Official Guide</title>
<link rel="stylesheet" href="tomoyo.css" media="all" type="text/css">
</head>
<body>

<div class=navheader>
<table summary="Header navigation table" width="100%" border="0" cellpadding="0" cellspacing="0">
<tr>
<td width="33%" align="left" valign="bottom">
<a href="chapter-3.html.en">Prev</a>
</td>
<td width="34%" align="center" valign="bottom">
<a href="index.html.jp">Japanese page</a>
</td>
<td width="33%" align="right" valign="bottom">
<a href="chapter-5.html.en">Next</a>
</td></tr>
</table>
</div>

<h1>Chapter 4: How does TOMOYO Linux work?</h1>

<p style="text-align:center;">Aim: to become familiar with the concepts involved in TOMOYO Linux and usage of the associated userspace tools.</p>

<h2><a name="4.1">4.1. Understanding domains</a></h2>

<p>In TOMOYO Linux, the technique used to enforce MAC makes use of something called <b>"domains"</b>. This is an important concept. Every process in a system belongs to a domain, which is determined by its execution history. Broadly speaking, every time a process is executed, a new domain is created. Any particular domain is represented by a concatenation of all previously executed pathanames. This creation of a new domain can also be called a <b>"domain transition"</b>. Have a look at this diagram:</p>

<p>
<table border="1" summary="fig">
<tr><td>
<img src="tutorial/fig-3-1.png" alt="fig-3-1.png" width="800" height="600">
</td></tr>
</table>
</p>

<p>The kernel is always the first domain and is represented in TOMOYO Linux by <b>&lt;kernel&gt;</b>. In this example, the kernel then executes "/sbin/init". Because a process has been executed, a new domain is created which in this case is the domain <b>"&lt;kernel&gt; /sbin/init"</b>. The bootup scripts are then executed, which result in further domains being created.</p>

<p>The process execution history is important. Consider the following domains:</p>

<p>&lt;kernel&gt; /sbin/init <b>/etc/rc.d/rc</b><br>
&lt;kernel&gt; /sbin/init /etc/rc.d/rc.sysinit <b>/etc/rc.d/rc</b><p>

<p>In both cases, the script "/etc/rc.d/rc" is the process causing a new domain to be created. However, <b>because the process execution history is different, they are considered to be two separate domains</b>. This allows you to control what can be executed by any particular domain, and allows policy to be more flexible as you can apply different levels of restriction to a process depending on how it was executed. There is also the possibility to manage domain transition very precisely and for example apply the same restriction to a process without regard to how it was executed. This topic will be discussed later.</p>

<h3>View domains with the policy editor</h3>

<p>Let's have a look at the policy editor to get a better understanding of domains. This is the main tool used with TOMOYO Linux and it is important to become comfortable using it. The instructions on this page can be supplemented with this page describing <a href="tool-editpolicy.html.en">How to use the Policy Editor</a>.</p>

<p>Once the system has been rebooted into the TOMOYO Linux kernel, run the policy editor with "/etc/ccs/" option to edit policy files within "/etc/ccs/":</p>

<pre class="command">
# /usr/sbin/ccs-editpolicy /etc/ccs/
</pre>

<p>The policy editor provides a number of "screens" that each serve a different role. The default screen that greets the user is the <b>"Domain Transition Editor"</b>. The picture below describes the domain tree that should be visible after running the above command. As of now, only the "&lt;kernel&gt;" domain is defined:</p>

<p><img src="editpolicy-domain-list1.png" alt="editpolicy-domain-list1.png" width="720" height="400"></p>

<p>Since this is a newly initialized policy, the policy files in "/etc/ccs/" are empty. <b>There are two sets of policy involved in TOMOYO Linux: policy loaded in the kernel, and policy saved to "/etc/ccs/"</b>. Many sets of policies can be saved to "/etc/ccs/" and can be loaded into the kernel at boot or on demand. Saving policy to disk will be discussed in later. Press the "q" key to quit the policy editor.</p>

<p>Now run the policy editor again <b>without</b> the "/etc/ccs/" option in order to view the policy that is loaded in the kernel:</p>

<pre class="command">
# /usr/sbin/ccs-editpolicy
</pre>

<p>As the system runs, TOMOYO Linux will record the creation of new domains and add them to the tree. After running the above command, the domain tree should appear populated with all domains created since startup:</p>

<p><img src="editpolicy-domain-list2.png" alt="editpolicy-domain-list2.png" width="720" height="400"></p>

<p>The first line shows what screen you are on and how many domains are listed.<br>
The second line is the message area.<br>
The third line shows the domain name currently selected by the cursor.<br>
The fourth line and downwards are the domains currently defined.<p>

<p>Try executing some commands and see where new domains are created. You can do this while you still have the policy editor running.</p>

<p>You can scroll using the <b>arrow keys</b> and/or the <b>Home/End/PageUp/PageDown</b> keys.</br>
Press the <b>"r"</b> key to refresh the contents of the screen.<br>
Press the <b>"f"</b> key to find an entry.<br>
Press the <b>"?"</b> key to view the available commands. Press the "?" again to go back to the previous screen.</p>

<p>Note that a new domain is only created if it is unique, so executing the same command over and over again will not result in the creation of many domains.</p>

<h2><a name="4.2">4.2. Understanding profiles</a></h2>

<p>Each domain can be restricted using TOMOYO Linux by assigning a <b>"profile"</b>. These profiles can be assigned to any domain independently of others, which allows you to slowly build up the security in your system one domain at a time. This also allows you to create custom profiles for specific domains, but this is a more advanced topic for later on.</p>

<p>In the policy editor, look at the numbers in the second column of each line:</p>

<p><img src="editpolicy-domain-profile-number.png" alt="editpolicy-domain-profile-number.png" width="720" height="400"></p>

<p>This number is called the <b>"profile number"</b>. A profile number is an integer value which takes between 0 and 255. The default profile number is "0", also known as "Disabled Mode", in which the domain is completely unrestricted.</p>

<p>Press the <b>"w"</b> key to list the different "screens" that can be viewed using the policy editor:</p>

<p><img src="editpolicy-window-list.png" alt="editpolicy-window-list.png" width="720" height="400"></p>

<br>

<p>Press the <b>"p"</b> key to select the <b>"Profile Editor"</b>, and you will see the list of profiles:</p>

<p><img src="editpolicy-profile-list.png" alt="editpolicy-profile-list.png" width="720" height="400"></p>

<br>

<p>
<table border="1">
<tr><td>Name</td><td>Control</td></tr>
<tr>
<td>COMMENT</td>
<td>Description of the profile.</td>
</tr>
<tr>
<td>CONFIG</td>
<td>Configuration of operation mode.</td>
</tr>
<tr>
<td>PREFERENCE</td>
<td>Configuration of various options.</td>
</tr>
</table>
</p>

<p>The "mode=" parameter of the CONFIG line can contain one of the following values:</p>

<p>
<table border="1">
<tr>
<td>Value</td>
<td>Meaning</td>
</tr>
<tr>
<td>disabled</td>
<td>Works as if a regular kernel.</td>
</tr>
<tr>
<td>learning</td>
<td>Do not reject an access request if the request violates policy. Append the request to policy.</td>
</tr>
<tr>
<td>permissive</td>
<td>Do not reject an access request if the request violates policy. Do not append the request to policy.</td>
</tr>
<tr>
<td>enforcing</td>
<td>Reject an access request if the request violates policy. Do not append the request to policy.</td>
</tr>
</table>
</p>

<br>

<p>Thus, there are four default profiles that each play a different role:</p>

<p>
<table border="1">
<tr><td>
<img src="tutorial/fig-2-5-en.png" alt="fig-2-5-en.png" width="640" height="320">
</td></tr>
</table>
</p>

<br>

<p>Each of these profiles can be assigned to a domain:</p>

<p>
<table border="1">
<tr><td>
<p><img src="tutorial/fig-2-6.png" alt="fig-2-6.png" width="800" height="600"></p>
</td></tr>
</table>
</p>

<br>

<p>The "Learning Mode" profile is the feature of TOMOYO Linux that makes developing policy very easy. This mode will automatically generate policy for any domain that has this profile selected. The other profiles, "Permissive Mode" and "Enforcing Mode", are for later on when a domain is ready to be restricted.</p>

<h2><a name="4.3">4.3. Understanding domain policy</a></h2>

<p>The restrictions of each domain can be viewed using the <b>"Domain Policy Editor"</b> screen, which can be accessed by selecting a domain in the "Domain Transition" screen, and then pressing the "Enter" key. Since no policy has been developed yet, the screen is empty. This is an example of domain policy for Apache:</p>

<p><a href="editpolicy-httpd-full.png">(Click to view complete screen.)<br><img src="editpolicy-httpd-acl1.png" alt="editpolicy-httpd-acl1.png" width="720" height="400"></a></p>

<p>The permissions in domain policy are represented here with directives such as "file read" and "file write". Once the domain is placed in "Enforcing Mode", only the permissions defined in domain policy will be allowed, as well as the permissions defined in exception policy (see <a href="chapter-4.html.en#4.4">4.4: Understanding exception policy</a>). In order to develop a policy of least privilege that still allows normal usage, the "Learning Mode" and "Permissive Mode" can be used. The directives available are described in detail in the <a href="policy-reference.html.en#domain_policy">Domain Policy Specification</a>. However, it is recommended that you <b>continue with this tutorial rather than try to master these directives</b>. It will become clearer later on how these directives can be used.</p>

<h2><a name="4.4">4.4. Understanding exception policy</a></h2>

<p>Press the "w" key, then press the "e" key, and you will see the <b>"Exception Policy Editor"</b> screen:</p>

<p><a href="editpolicy-exception-full.png">(Click to view complete screen.)<br><img src="editpolicy-exception-list1.png" alt="editpolicy-exception-list1.png" width="720" height="400"></a></p>

<p>You can scroll this window using the arrow keys and/or the Home/End/PageUp/PageDown keys.</p>

<p>The permissions here are similar to those in the domain policy, but apply to all domains. Permissions defined here will not be displayed in domain policy, and access requests from any domain that match a permission in exception policy will be automatically accepted. The exception policy can also be used to shorten and simplify domain policy for each domain by using the group directives.</p>

<p>For in depth details on the directives that can be used in exception policy, see the <a href="policy-reference.html.en#exception_policy">Exception Policy Specifications</a>. However, it is recommended that you <b>continue with this tutorial rather than try to master these directives</b>. It will become clearer later on how these directives can be used.</p>

<h2><a name="4.5">4.5. Save audit logs (optional)</a></h2>

<p>When a domain tries to perform an action that has been permitted in domain/exception policy, this action is granted. If the action has not been permitted in policy, then the action is rejected, assuming the domain is in "Enforcing Mode".</p>

<p>When developing policy, it may be useful to save a log entry every time a domain makes a request that is undefined in domain/exception policy. While this is crucial for system administration once policy has been fully developed and enforced, it can also be used alongside "Learning Mode" to help develop policy.</p>

<p>TOMOYO Linux can record <b>"access granted logs"</b> (access requests that did not violate domain policy) and <b>"access rejected logs"</b> (access requests that violated domain policy). These logs are in the form of domain policy. This is useful in the case that the user wishes to permit a domain to perform actions that are not currently permitted in policy. The "access rejected log" could then be used to append permissions to domain policy. The "Learning Mode" described in <a href="chapter-5.html.en">the next chapter</a> mostly automates the process of appending "access rejected logs" into domain policy for domains set to that mode.</p>

<p>The following values can be given for the grant_log= parameter of the CONFIG line:</p>

<p>
<table border="1">
<tr>
<td>Value</td>
<td>Meaning</td>
</tr>
<tr>
<td>no</td>
<td>Don't record "access granted logs" unless "grant_log=yes" is explicitly specified in the individual ACL entry.</td>
</tr>
<tr>
<td>yes</td>
<td>Record "access granted logs" unless "grant_log=no" is explicitly specified in the individual ACL entry.</td>
</tr>
</table>
</p>

<p>The following values can be given for the reject_log= parameter of the CONFIG line:</p>

<p>
<table border="1">
<tr>
<td>Value</td>
<td>Meaning</td>
</tr>
<tr>
<td>no</td>
<td>Don't record "access rejected logs".</td>
</tr>
<tr>
<td>yes</td>
<td>Record "access rejected logs".</td>
</tr>
</table>
</p>

<p>"/usr/sbin/ccs-auditd" is a daemon program that reads from "/proc/ccs/audit" and writes to specified log files. To make use of this daemon, it can for example be run by adding "/usr/sbin/ccs-auditd" to "/etc/rc.local".</p>

<p>The configuration of this daemon is done in the "/etc/ccs/tools/auditd.conf" file. Text read from "/proc/ccs/audit" can be sorted and sent to different files. Some useful defaults exist, but an advaned user can make use of extensive sorting rules to make administration easier. The default configuration file looks like this:</p>

<pre>
# This file contains sorting rules used by ccs-auditd command.

# An audit log consists with three lines. You can refer the first line
# using 'header' keyword, the second line using 'domain' keyword, and the
# third line using 'acl' keyword.
#
# Words in each line are separated by a space character. Therefore, you can
# use 'header[index]', 'domain[index]', 'acl[index]' for referring index'th
# word of the line. The index starts from 1, and 0 refers the whole line
# (i.e. 'header[0]' = 'header', 'domain[0]' = 'domain', 'acl[0]' = 'acl').
#
# Three operators are provided for conditional sorting.
# '.contains' is for 'fgrep keyword' match.
# '.equals' is for 'grep ^keyword$' match.
# '.starts' is for 'grep ^keyword' match.
#
# Sorting rules are defined using multi-lined chunks. A chunk is terminated
# by a 'destination' line which specifies the pathname to write the audit
# log. A 'destination' line is processed only when all preceding 'header',
# 'domain' and 'acl' lines in that chunk have matched.
# Evaluation stops at the first processed 'destination' line.
# Therefore, no audit logs are written more than once.
#
# More specific matches should be placed before less specific matches.
# For example:
#
# header.contains profile=3
# domain.contains /usr/sbin/httpd
# destination     /var/log/tomoyo/reject_003_httpd.log
#
# This chunk should be placed before the chunk that matches logs with
# profile=3. If placed after, the audit logs for /usr/sbin/httpd will be
# sent to /var/log/tomoyo/reject_003.log .

# Please use TOMOYO Linux's escape rule (e.g. '\040' rather than '\ ' for
# representing a ' ' in a word).

# Discard all granted logs.
header.contains granted=yes
destination     /dev/null

# Save rejected logs with profile=0 to /var/log/tomoyo/reject_000.log
header.contains profile=0
destination     /var/log/tomoyo/reject_000.log

# Save rejected logs with profile=1 to /var/log/tomoyo/reject_001.log
header.contains profile=1
destination     /var/log/tomoyo/reject_001.log

# Save rejected logs with profile=2 to /var/log/tomoyo/reject_002.log
header.contains profile=2
destination     /var/log/tomoyo/reject_002.log

# Save rejected logs with profile=3 to /var/log/tomoyo/reject_003.log
header.contains profile=3
destination     /var/log/tomoyo/reject_003.log
</pre>

<p>WARNING: Be careful with disk space if "access granted logs" are saved as this file can grow extremely quickly. Do not do this unless you know what you are doing.</p>

<p>To manage logs with "logrotate", create /etc/logrotate.d/tomoyo with the following content (give "nocreate" option or logs after the first rotation will not be saved):</p>

<pre>
/var/log/tomoyo/*.log {
&nbsp;&nbsp;weekly
&nbsp;&nbsp;rotate 9
&nbsp;&nbsp;missingok
&nbsp;&nbsp;notifempty
&nbsp;&nbsp;nocreate
}
</pre>

<p>If audit logs are not required, ccs-auditd need not be run. In this case, give PREFERENCE={ max_audit_log=0 } for profiles to save memory and improve performance. While the use of audit logs can be delayed until a domain has been switched to "Enforcing Mode", it is recommended to store "access rejected logs" at this point for the development of fine-grained policy.</p>

<br>

<p>Proceed to the <a href="chapter-5.html.en">Chapter 5</a>, where we talk about how to manage domains!</p>

<div class=navfooter>
<hr align="left" width="100%">
<table summary="Footer navigation table" width="100%" border="0" cellpadding="0" cellspacing="0">
<tr>
<td width="33%" align="left" valign="top">
<a href="chapter-3.html.en">Next</a>
</td>
<td width="34%" align="center" valign="top">
<a href="index.html.en">Index</a>
</td>
<td width="33%" align="right" valign="top">
<a href="chapter-5.html.en">Next</a>
</td></tr>
<tr><td width="33%" align="left" valign="top">
Chapter 3: How do I install TOMOYO Linux?
</td>
<td width="34%" align="center" valign="top">
<a href="http://tomoyo.sourceforge.jp/">Home</a>
</td>
<td width="33%" align="right" valign="top">
Chapter 5: How do I manage domains?
</td>
</tr>
</table>
</div>

<table width="100%" border="0" cellpadding="0" cellspacing="0">
<tr><td>
<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>
</td>
<td>
<p style="text-align:right;font-size:smaller;">Last modified: $Date$</p>
</td></tr>
</table>
</body>
</html>
