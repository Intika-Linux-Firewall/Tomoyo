<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<meta http-equiv="Content-Style-Type" content="text/css">
<title>TOMOYO Linux Install manual</title>
<link rel="stylesheet" href="http://tomoyo.sourceforge.jp/tomoyo.css" media="all" type="text/css">
</head>
<body>
<p>This page is for TOMOYO 2.3 (for Linux 2.6.36 and later kernels). Please jump to <a href="../2.2/">this page</a> for TOMOYO 2.2 (for Linux 2.6.30 - 2.6.35 kernels).</p>
<p style="text-align:right;"><a href="learning.html.ja">Japanese Page</a></p>
<p style="text-align:right;">Last modified: $Date$</p>
<h1>Phase 3: Analyzing your system's behavior.</h1>

<p>This page describes how to use TOMOYO Linux's learning mode.</p>

<hr>

<h2>Step 1: Creating domains</h2>

<p>After rebooting the system with the TOMOYO Linux kernel, login as root.</p>

<p>Decide what application to analyze/protect.</p>

<p>The procedure below takes the use of Apache in a CentOS 5.6 as an example.</p>

<p>Start the target application:</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# service httpd start
</td></tr>
</table>

<p>Let's start TOMOYO Linux's policy editor. "/etc/tomoyo/" need not be passed to the command line so that the policy loaded by the kernel can be edited directly:</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# /usr/sbin/tomoyo-editpolicy
</td></tr>
</table>

<p>In CentOS 5.6, the location of Apache is "/usr/sbin/httpd".<br>
Scroll the cursor using arrow-keys and/or Home/End/PageUp/PageDown keys to find the line "/usr/sbin/httpd". In this picture, it is line 419:</p>

<p><img src="editpolicy-httpd-profile0.png" alt="editpolicy-httpd-profile0.png" width="720" height="400"></p>

<p>If /usr/sbin/httpd is registered with "initialize_domain", a domain named "&lt;kernel&gt; /usr/sbin/httpd" is created by invoking /usr/sbin/httpd . If not registered, a child domain of invoker domain (for example, if you invoked from "&lt;kernel&gt; /usr/sbin/mingetty /bin/login /bin/bash", it is "&lt;kernel&gt; /usr/sbin/mingetty /bin/login /bin/bash /usr/sbin/httpd") is created. This manual assumes that /usr/sbin/httpd is registered with "initialize_domain". See <a href="tool-editpolicy.html.en#Initialize_domain_transition">Initialize domain transition</a> for more information.</p>

<p>Press 's' key and enter '1' and press 'Enter' key:</p>

<p><img src="editpolicy-httpd-set-profile1.png" alt="editpolicy-httpd-set-profile1.png" width="720" height="400"></p>

<p>Now the profile number of the /usr/sbin/httpd has changed to 1:</p>

<p><img src="editpolicy-httpd-profile1.png" alt="editpolicy-httpd-profile1.png" width="720" height="400"></p>

<p>Press '@' key to switch to the process list. Verify that /usr/sbin/httpd processes are assigned profile number 1:</p>

<p><img src="editpolicy-httpd-process1.png" alt="editpolicy-httpd-process1.png" width="720" height="400"></p>

<p>Press 'q' key to quit the policy editor.</p>

<hr>

<h2>Step 2: Gathering necessary permissions</h2>

<p>Restart "httpd" in order to learn necessary permissions required for starting/stopping this service:</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# service httpd restart
</td></tr>
</table>

<p>Run the policy editor again and go to the "/usr/sbin/httpd" line. The line number may have changed due to the creation of new domains from executed programs.</p>

<p>Press 'Enter' key to browse the permissions that have been gathered:</p>

<p><img src="editpolicy-httpd-acl1.png" alt="editpolicy-httpd-acl1.png" width="720" height="400"></p>

<p>Press 'q' key to quit the policy editor.</p>

<p>Apache should now be used to generate the necessary permissions for normal usage. All actions should be performed that you wish to allow:</p>

<p><img src="operation-learning.png" alt="operation-learning.png" width="688" height="933"></p>

<p>Remember to save policy, as permissions are accumulated only in kernel memory. If the system is rebooted, the gathered permissions will be lost.</p>

<p>To save policy to disk, use the following command:</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# /usr/sbin/tomoyo-savepolicy
</td></tr>
</table>

<p>By executing "tomoyo-savepolicy", two files ("exception_policy.conf", "domain_policy.conf") are created in the /etc/tomoyo/ directory. To be accurate, they are symbolic links to text files whose filenames contain the creation time.</p>

<p>To load the policy currently on the disk into the kernel, use "tomoyo-loadpolicy" command.</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# /usr/sbin/tomoyo-loadpolicy af
</td></tr>
</table>

<p>The "a" option means load two files ("exception_policy.conf", "domain_policy.conf"). The "f" option means erase the policy currently in the kernel before loading the policy currently on the disk. If "f" is not given, the policy currently on the disk will be added to the policy currently in the kernel.</p>

<hr>

<h2>Step 3: Reviewing gathered permissions</h2>

<p>Once Apache has been stretched to cover all possible uses, run the policy editor to change the profile number to 2. If Apache has executed external programs (e.g. /bin/sh, /usr/bin/sendmail), then there will be descendent domains. The profile number of all descendent domains must also be changed to 2.

<p>Choose target domains and press 's' key and enter '2' and press 'Enter' key:</p>

<p><img src="editpolicy-httpd-set-profile2.png" alt="editpolicy-httpd-set-profile2.png" width="720" height="400"></p>

<p>Now the profile number of the "/usr/sbin/httpd" domain and all descendants have changed to 2:</p>

<p><img src="editpolicy-httpd-profile2.png" alt="editpolicy-httpd-profile2.png" width="720" height="400"></p>

<p>Press 'q' key to quit the policy editor.</p>

<p>Continue using Apache. The counter in /proc/tomoyo/stat will be incremented every time a policy violation occurs.</p>

<p>If the profile is configured as "PREFERENCE::permissive={ verbose=yes }" (this is default), the "WARNING:" messages will be printed to the console when policy violation occur.</p>

<p><img src="operation-permissive.png" alt="operation-permissive.png" width="688" height="622"></p>

<p><img src="permissive-warning.png" alt="permissive-warning.png" width="720" height="400"></p>

<p>Remember to save policy, as permissions are accumulated only in kernel memory. If the system is rebooted, the gathered permissions will be lost.</p>

<p>Use the following command to save the policy to disk into exception_policy.conf and domain_policy.conf :</p>

<table border="1">
<tr><td>
[root@tomoyo ~]# /usr/sbin/tomoyo-savepolicy a
</td></tr>
</table>

<p>If you are using TOMOYO Linux for system analysis, this point is the goal of this procedure.</p>

<p>If you are using TOMOYO Linux for protection, proceed to the next phase to continue tuning policy.</p>

<hr>

<p><a href="index.html.en">Return to index page.</a></p>
<p><a href="http://sourceforge.jp/"><img src="http://sourceforge.jp/sflogo.php?group_id=1973" width="96" height="31" alt="SourceForge.jp"></a></p>
</body>
</html>
